# Story 4.4: Personnalisation temps de repos

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** définir mes temps de repos par exercice,  
**so that** je respecte mon programme spécifique.

---

## Acceptance Criteria

1. Dans workout editor, option "Set Rest Time" par exercice
2. Options rapides: 60s, 90s, 2min, 3min, 5min (quick select)
3. Option custom (time picker pour durée personnalisée)
4. Temps sauvegardé avec workout template dans WorkoutExercise
5. Pendant séance active, affichage du temps de repos personnalisé
6. Temps personnalisé override les defaults (compound 3min, isolation 90s)
7. Si non défini, utiliser defaults basés sur catégorie exercice

---

## Tasks / Subtasks

### Data Model Update
- [ ] **Task 1: Verify WorkoutExercise Entity** (AC: 4)
  - [ ] Subtask 1.1: Verify `WorkoutExercise` entity has `restTime` field
    - Already defined in Story 1.1: `final Duration? restTime;`
    - If missing, add field to entity
  - [ ] Subtask 1.2: Verify `WorkoutExerciseModel` supports restTime serialization
    - toJson: Convert Duration to seconds (int)
    - fromJson: Convert seconds to Duration
  - [ ] Subtask 1.3: Verify database schema includes rest_time
    - Column: `rest_time INTEGER` (seconds) in workout_exercises table
    - Already defined in Story 1.1

### UI Layer - Workout Builder
- [ ] **Task 2: Add Rest Time Setting to Exercise in Workout Builder** (AC: 1, 2, 3, 4)
  - [ ] Subtask 2.1: Update `WorkoutExerciseListItem` widget
    - Add "Set Rest Time" button or tap gesture
    - Show current rest time if set (e.g., "Rest: 2:00")
    - If not set, show "Rest: Auto" or default value
  - [ ] Subtask 2.2: Create `RestTimePickerDialog` widget in `lib/presentation/widgets/rest_time_picker_dialog.dart`
    - Bottom sheet or dialog
    - Quick select buttons: 60s, 90s, 2min, 3min, 5min
    - "Custom" button → opens time picker
    - "Auto" or "Default" button → clears custom time
  - [ ] Subtask 2.3: Implement quick select buttons
    - Tap button → set rest time → close dialog
    - Highlight selected option
  - [ ] Subtask 2.4: Implement custom time picker
    - Tap "Custom" → show duration picker
    - Picker: Minutes (0-10) and Seconds (0-59)
    - Or use TextField with "MM:SS" format
  - [ ] Subtask 2.5: Save rest time with exercise
    - Update WorkoutExercise in workout state
    - Persist to database when workout saved

### UI Layer - Active Workout
- [ ] **Task 3: Display Custom Rest Time During Workout** (AC: 5, 6, 7)
  - [ ] Subtask 3.1: Update ActiveWorkoutScreen to show exercise rest time
    - Display: "Rest Time: 2:00" below exercise name
    - Or show in exercise card
  - [ ] Subtask 3.2: Update timer start logic (Story 4.1 integration)
    - Check if current exercise has custom rest time
    - If yes: use custom rest time
    - If no: use default based on exercise category
  - [ ] Subtask 3.3: Visual indicator for custom vs default
    - Optional: Badge or icon to show custom time set
    - Or just display the time value

### Use Case Integration
- [ ] **Task 4: Update GetRestTimeForExercise Use Case** (AC: 6, 7)
  - [ ] Subtask 4.1: Verify `GetRestTimeForExercise` use case (Story 4.1)
    - Already checks WorkoutExercise.restTime
    - If set: return custom time
    - If null: return default based on Exercise.category
  - [ ] Subtask 4.2: Ensure logic correctly prioritizes custom over default

### Validation & Edge Cases
- [ ] **Task 5: Implement Validation** (AC: 3)
  - [ ] Subtask 5.1: Validate custom rest time input
    - Minimum: 10 seconds (or 0 for no rest)
    - Maximum: 10 minutes (600 seconds) - reasonable limit
  - [ ] Subtask 5.2: Handle edge cases
    - 0 seconds = no rest timer (skip timer)
    - Invalid input = show error message

### Testing
- [ ] **Task 6: Unit Tests**
  - [ ] Subtask 6.1: Test WorkoutExerciseModel restTime serialization
    - toJson converts Duration to seconds
    - fromJson converts seconds to Duration
  - [ ] Subtask 6.2: Test GetRestTimeForExercise prioritization
    - Custom time overrides default
    - Default used when no custom time
  - [ ] Subtask 6.3: Test rest time saved with workout

- [ ] **Task 7: Widget Tests**
  - [ ] Subtask 7.1: Test RestTimePickerDialog renders quick options
  - [ ] Subtask 7.2: Test quick select sets rest time
  - [ ] Subtask 7.3: Test custom picker sets rest time
  - [ ] Subtask 7.4: Test "Auto" clears custom time
  - [ ] Subtask 7.5: Test rest time displays in workout builder
  - [ ] Subtask 7.6: Test rest time displays in active workout

- [ ] **Task 8: Integration Tests**
  - [ ] Subtask 8.1: Test full flow: Set custom rest time → Save workout → Start workout → Verify custom time used
  - [ ] Subtask 8.2: Test default time used when no custom time set
  - [ ] Subtask 8.3: Test custom time persists after app restart

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 4 - US-4.3]

New/Modified files:
```
lib/
├── domain/
│   ├── entities/
│   │   └── workout_exercise.dart (VERIFY - restTime field exists)
│   └── usecases/
│       └── get_rest_time_for_exercise.dart (VERIFY - prioritizes custom)
├── presentation/
│   ├── screens/
│   │   ├── workout_builder/
│   │   │   └── workout_builder_screen.dart (MODIFY - show rest time)
│   │   └── active_workout/
│   │       └── active_workout_screen.dart (MODIFY - display custom time)
│   └── widgets/
│       ├── workout_exercise_list_item.dart (MODIFY - add rest time button)
│       └── rest_time_picker_dialog.dart (NEW)
```

### WorkoutExercise Entity (Already Defined)
**Source:** [PRD Feature 1 - Technical Specifications, Story 1.1]

```dart
class WorkoutExercise {
  final String exerciseId;
  final int order;
  final int targetSets;
  final Duration? restTime; // ALREADY EXISTS - nullable for optional custom time
}
```

**Note:** This field already exists from Story 1.1. This story adds UI to set it.

### Rest Time Priority Logic
**Source:** [PRD Feature 4 - US-4.3 AC, Story 4.1]

**GetRestTimeForExercise logic (already in Story 4.1):**
```dart
Duration getRestTimeForExercise(Exercise exercise, WorkoutExercise? workoutExercise) {
  // Priority 1: Custom rest time from workout template
  if (workoutExercise?.restTime != null) {
    return workoutExercise!.restTime!;
  }
  
  // Priority 2: Default based on exercise category
  switch (exercise.category) {
    case ExerciseCategory.compound:
      return Duration(minutes: 3); // 180s
    case ExerciseCategory.isolation:
      return Duration(seconds: 90);
  }
}
```

**This story adds UI to set the custom rest time.**

### UI/UX Design - Rest Time Picker
**Source:** [PRD Feature 4 - US-4.3 AC]

**RestTimePickerDialog (Bottom Sheet):**
```
┌─────────────────────────────────┐
│  Set Rest Time                  │
├─────────────────────────────────┤
│  Quick Select:                  │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐   │
│  │ 60s│ │ 90s│ │2:00│ │3:00│   │
│  └────┘ └────┘ └────┘ └────┘   │
│  ┌────┐                         │
│  │5:00│                         │
│  └────┘                         │
│                                 │
│  [     Custom Time     ]        │ ← Opens picker
│                                 │
│  [    Auto (Default)   ]        │ ← Clears custom
│                                 │
│  [       Cancel        ]        │
└─────────────────────────────────┘
```

**Custom Time Picker:**
- Use CupertinoTimerPicker or custom picker
- Format: MM:SS
- Range: 0:10 to 10:00

**In Workout Builder:**
```
Exercise List Item:
┌─────────────────────────────────┐
│ Bench Press                     │
│ 4 sets • Rest: 3:00 ⏱          │ ← Shows custom time
│ [Drag handle]                   │
└─────────────────────────────────┘

Tap "Rest: 3:00" → Opens RestTimePickerDialog
```

### Quick Select Options
**Source:** [PRD Feature 4 - US-4.3 AC]

**Predefined durations:**
1. **60s** - Short rest for accessories/isolation
2. **90s** - Standard isolation rest
3. **2:00** (120s) - Moderate compound rest
4. **3:00** (180s) - Standard compound rest (default)
5. **5:00** (300s) - Long rest for heavy compounds

**Why these values:**
- Cover most common rest periods
- Align with training science
- Easy to select quickly

### Custom Time Picker Implementation
**Source:** [PRD Feature 4 - US-4.3 AC]

**Option 1: Duration Picker Widget**
```dart
CupertinoTimerPicker(
  mode: CupertinoTimerPickerMode.ms, // minutes:seconds
  initialTimerDuration: Duration(minutes: 2),
  onTimerDurationChanged: (Duration duration) {
    // Update rest time
  },
)
```

**Option 2: Custom Scrollable Pickers**
- Two columns: Minutes (0-10), Seconds (0-59)
- Scroll to select
- Combine to create Duration

**Recommendation:** CupertinoTimerPicker for iOS-style, or custom for Material

### Auto/Default Option
**Source:** [PRD Feature 4 - US-4.3 AC]

**Purpose:** Clear custom rest time and use defaults

**Implementation:**
- Button: "Auto" or "Use Default"
- Action: Set workoutExercise.restTime = null
- Display: Show "Rest: Auto" or calculated default value
- Timer will use GetRestTimeForExercise logic (compound 3min / isolation 90s)

### Display in Active Workout
**Source:** [PRD Feature 4 - US-4.3 AC]

**Show rest time for current exercise:**
```
Active Workout Screen:
┌─────────────────────────────────┐
│ Bench Press            (1/5)    │
│ Rest Time: 3:00 ⏱              │ ← Custom time displayed
│                                 │
│ Last time: 3×8 @ 80kg           │
│                                 │
│ Current Sets:                   │
│ ...                             │
└─────────────────────────────────┘
```

**Visual indicators:**
- Icon: ⏱ or timer icon
- Text: "3:00" or "Auto (3:00)" if using default
- Color: Neutral or theme color

### Database Serialization
**Source:** [PRD Feature 4 - US-4.3 AC]

**Store as seconds (INTEGER):**
```dart
// toJson
int? get restTimeSeconds => restTime?.inSeconds;

// fromJson
Duration? restTime = json['rest_time'] != null 
  ? Duration(seconds: json['rest_time'] as int)
  : null;
```

**Database:**
```sql
-- workout_exercises table
rest_time INTEGER NULL  -- NULL = use default
```

### Validation Rules
**Source:** [PRD Feature 4 - US-4.3]

**Custom rest time:**
- Minimum: 10 seconds (or 0 for skip)
- Maximum: 600 seconds (10 minutes)
- Reason: Reasonable bounds for rest periods

**Special case: 0 seconds**
- Means no rest timer
- Skip timer entirely
- Useful for supersets or circuits

### Integration with Story 4.3 (Timer Controls)
**Source:** [PRD Feature 4]

**Custom rest time works with controls:**
- User sets 3:00 rest time
- Timer starts with 3:00
- User can still +30s or -30s during rest
- Controls are independent of initial duration

### Performance Considerations
**Source:** [PRD Feature 4 - US-4.3]

- **Load rest time:** < 10ms (field read)
- **Save rest time:** < 50ms (UPDATE query)
- **Display picker:** < 200ms

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- Standard Flutter widgets

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- Custom rest time overrides default
- Quick select sets correct duration
- Custom picker sets correct duration
- Auto clears custom time
- Rest time persists in database
- Display shows custom vs default correctly
- Timer uses custom time when set

### Integration with Other Stories
**Dependencies:**
- Story 1.1 (Create Workout) - WorkoutExercise entity already has restTime field
- Story 4.1 (Auto Timer) - GetRestTimeForExercise uses custom time

**Enables:**
- Flexible rest periods per exercise
- Personalized workout programs
- Better adherence to training plans

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

