# Story 5.3: Graphiques de progression par exercice

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** voir des graphiques de mes progrès par exercice,  
**so that** je suis motivé et j'identifie les tendances.

---

## Acceptance Criteria

1. Graphique "Max Weight" over time (line chart)
2. Graphique "Total Volume" (sets × reps × weight) over time
3. Graphique "1RM estimé" (formule: weight × (1 + reps/30))
4. Sélecteur période: 1 mois, 3 mois, 6 mois, 1 an, All
5. Graphiques générés après minimum 3 datapoints
6. Interactive: tap point = détails session
7. Accessible depuis Exercise Details ou History

---

## Tasks / Subtasks

### Dependencies
- [ ] **Task 1: Add Chart Package** (AC: 1, 2, 3)
  - [ ] Subtask 1.1: Add `fl_chart: ^0.66.0` to pubspec.yaml
  - [ ] Subtask 1.2: Import and configure

### Use Cases
- [ ] **Task 2: Create Progress Use Cases** (AC: 1, 2, 3)
  - [ ] Subtask 2.1: Create `GetExerciseProgressData` use case
    - Input: exerciseId, period (enum)
    - Query all sets for exercise in period
    - Calculate max weight per session
    - Calculate total volume per session
    - Calculate estimated 1RM per session
    - Return ProgressData entity
  - [ ] Subtask 2.2: Create `CalculateEstimated1RM` helper
    - Formula: weight × (1 + reps/30) (Epley)
    - Or Brzycki: weight × (36 / (37 - reps))

### Data Models
- [ ] **Task 3: Create Progress Entities** (AC: 1, 2, 3)
  - [ ] Subtask 3.1: Create ProgressData entity
    - maxWeightOverTime: List<DataPoint>
    - volumeOverTime: List<DataPoint>
    - estimated1RMOverTime: List<DataPoint>
  - [ ] Subtask 3.2: Create DataPoint entity
    - date: DateTime
    - value: double
    - sessionId: String (for tap navigation)

### State Management
- [ ] **Task 4: Create ProgressBloc** (AC: 1-7)
  - [ ] Subtask 4.1: Create ProgressBloc events
    - LoadProgressData(exerciseId, period)
  - [ ] Subtask 4.2: Create ProgressBloc states
    - ProgressLoading, ProgressLoaded, ProgressError
  - [ ] Subtask 4.3: Implement bloc logic

### UI Layer - Charts
- [ ] **Task 5: Create Progress Charts Screen** (AC: 1-7)
  - [ ] Subtask 5.1: Create ProgressChartsScreen
    - TabBar with 3 tabs: Max Weight, Volume, Est. 1RM
    - Period selector (chips or dropdown)
  - [ ] Subtask 5.2: Create MaxWeightChart widget
    - LineChart from fl_chart
    - X-axis: dates
    - Y-axis: weight
    - Touch interaction
  - [ ] Subtask 5.3: Create VolumeChart widget
    - Similar to MaxWeightChart
  - [ ] Subtask 5.4: Create Estimated1RMChart widget
    - Similar charts
  - [ ] Subtask 5.5: Add empty state
    - "Not enough data. Complete at least 3 workouts to see progress."

### Period Selector
- [ ] **Task 6: Implement Period Filter** (AC: 4)
  - [ ] Subtask 6.1: Period enum
    - oneMonth, threeMonths, sixMonths, oneYear, all
  - [ ] Subtask 6.2: Filter chips UI
    - Horizontal scrollable
    - Selected chip highlighted
  - [ ] Subtask 6.3: Filter logic
    - Calculate date range from period
    - Reload charts with new period

### Interactive Charts
- [ ] **Task 7: Make Charts Interactive** (AC: 6)
  - [ ] Subtask 7.1: Enable touch on charts
    - Show tooltip on tap
    - Tooltip: date, value
  - [ ] Subtask 7.2: Navigate to session on tap
    - Tap datapoint → SessionDetailsScreen

### Testing
- [ ] **Task 8: Tests**
  - [ ] Subtask 8.1: Unit tests for calculations
  - [ ] Subtask 8.2: Widget tests for charts
  - [ ] Subtask 8.3: Test with 3, 10, 100+ datapoints

---

## Dev Notes

### Chart Package
**Source:** [PRD Feature 5 - US-5.2]

Package: `fl_chart: ^0.66.0`

### 1RM Formulas
**Source:** [PRD Feature 5 - Technical Specifications]

**Epley Formula:**
```dart
double calculateEpley1RM(double weight, int reps) {
  return weight * (1 + reps / 30.0);
}
```

Example: 8 reps @ 80kg → 80 × (1 + 8/30) = 101.3kg

### Progress Data Query
**Source:** [PRD Feature 5 - US-5.2]

```sql
SELECT 
  s.start_time as date,
  MAX(sr.weight) as max_weight,
  SUM(sr.reps * sr.weight) as volume
FROM workout_sessions s
JOIN performed_exercises pe ON pe.session_id = s.id
JOIN set_records sr ON sr.performed_exercise_id = pe.id
WHERE pe.exercise_id = ?
  AND s.start_time >= ?
  AND s.status = 'completed'
GROUP BY s.id
ORDER BY s.start_time ASC;
```

### Minimum Datapoints
**Source:** [PRD Feature 5 - US-5.2 AC]

Require minimum 3 sessions to show charts (avoid misleading single-point chart)

### Chart Theming
**Source:** Story 0 - UX Polish]

- Dark/Light mode support
- Line color: Theme primary color
- Grid lines: Subtle
- Smooth curves (interpolation)

### Performance
**Source:** [PRD Feature 5]

- Max 100 datapoints on chart (sample if > 100)
- Query optimization with indexes
- Cache chart data (invalidate on new session)

### Dependencies
**Source:** Package ecosystem]

New package:
- `fl_chart: ^0.66.0`

Existing:
- `flutter_bloc`, `sqflite`, `intl`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

