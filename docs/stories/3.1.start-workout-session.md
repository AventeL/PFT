# Story 3.1: Démarrer une séance d'entraînement

## Status
**In Progress** - Started 2026-01-13

---

## Story

**As a** utilisateur,  
**I want to** démarrer une séance rapidement,  
**so that** je peux commencer à tracker mes sets.

---

## Acceptance Criteria

1. Bouton "Start Workout" sur home screen (FAB)
2. User sélectionne séance (templates ou custom)
3. Option "Quick Start" = séance vide (ajouter exercices on-the-fly)
4. Transition vers "Active Workout Screen" < 500ms
5. Timestamp de début enregistré
6. Écran reste allumé pendant séance (wakelock)
7. Session sauvegardée avec status "active"

---

## Tasks / Subtasks

### Domain Layer - Entities & Models
- [ ] **Task 1: Create WorkoutSession entities** (AC: 5, 7)
  - [ ] Subtask 1.1: Create `WorkoutSession` entity in `lib/domain/entities/workout_session.dart`
    - Properties: `id` (String UUID), `workoutId` (String?), `startTime` (DateTime), `endTime` (DateTime?), `status` (SessionStatus enum), `performedExercises` (List<PerformedExercise>), `notes` (String?)
  - [ ] Subtask 1.2: Create `PerformedExercise` entity in `lib/domain/entities/performed_exercise.dart`
    - Properties: `exerciseId` (String), `sets` (List<SetRecord>), `restTime` (Duration?)
  - [ ] Subtask 1.3: Create `SetRecord` entity in `lib/domain/entities/set_record.dart`
    - Properties: `setNumber` (int), `reps` (int), `weight` (double), `rpe` (int?), `timestamp` (DateTime)
  - [ ] Subtask 1.4: Create `SessionStatus` enum in `lib/domain/entities/session_status.dart`
    - Values: active, completed, abandoned
  - [ ] Subtask 1.5: Create corresponding models in `lib/data/models/`
    - `WorkoutSessionModel`, `PerformedExerciseModel`, `SetRecordModel` with JSON serialization

### Data Layer - Repository
- [ ] **Task 2: Implement WorkoutSession Repository** (AC: 5, 7)
  - [ ] Subtask 2.1: Create `WorkoutSessionRepository` interface in `lib/domain/repositories/workout_session_repository.dart`
    - Methods: `Future<WorkoutSession> createSession(WorkoutSession session)`, `Future<WorkoutSession?> getActiveSession()`, `Future<WorkoutSession> updateSession(WorkoutSession session)`, `Future<void> completeSession(String sessionId, DateTime endTime)`, `Future<void> abandonSession(String sessionId)`
  - [ ] Subtask 2.2: Create `WorkoutSessionLocalDataSource` interface in `lib/data/datasources/local/workout_session_local_datasource.dart`
  - [ ] Subtask 2.3: Implement `WorkoutSessionLocalDataSourceImpl` with SQLite operations
    - Create table: `workout_sessions` (id, workout_id, start_time, end_time, status, notes)
    - Create table: `performed_exercises` (id, session_id, exercise_id, rest_time)
    - Create table: `set_records` (id, performed_exercise_id, set_number, reps, weight, rpe, timestamp)
  - [ ] Subtask 2.4: Implement `WorkoutSessionRepositoryImpl` in `lib/data/repositories/workout_session_repository_impl.dart`

### Use Cases
- [ ] **Task 3: Create WorkoutSession Use Cases** (AC: 1, 2, 3, 5, 7)
  - [ ] Subtask 3.1: Create `StartWorkoutSession` use case in `lib/domain/usecases/start_workout_session.dart`
    - Input: Workout (optional for quick start)
    - Generate session ID (UUID)
    - Set startTime = DateTime.now()
    - Set status = SessionStatus.active
    - If workout provided, initialize performedExercises list
    - Save to repository
  - [ ] Subtask 3.2: Create `GetActiveSession` use case in `lib/domain/usecases/get_active_session.dart`
    - Check if active session exists
    - Return session or null
  - [ ] Subtask 3.3: Create `ResumeWorkoutSession` use case in `lib/domain/usecases/resume_workout_session.dart`
    - For crash recovery (Story 3.7)

### State Management (BLoC)
- [ ] **Task 4: Implement ActiveWorkoutBloc** (AC: 1, 2, 3, 4, 5, 7)
  - [ ] Subtask 4.1: Create ActiveWorkoutBloc events in `lib/presentation/blocs/active_workout/active_workout_event.dart`
    - `StartWorkoutSession(Workout? workout)`, `LoadActiveSession()`, `UpdateSession(WorkoutSession session)`, `CompleteSession()`, `AbandonSession()`
  - [ ] Subtask 4.2: Create ActiveWorkoutBloc states in `lib/presentation/blocs/active_workout/active_workout_state.dart`
    - `ActiveWorkoutInitial`, `ActiveWorkoutLoading`, `ActiveWorkoutActive(WorkoutSession session)`, `ActiveWorkoutCompleted`, `ActiveWorkoutError`
  - [ ] Subtask 4.3: Implement ActiveWorkoutBloc logic in `lib/presentation/blocs/active_workout/active_workout_bloc.dart`
    - Handle StartWorkoutSession event
    - Handle LoadActiveSession event (check for existing active session)
    - Emit ActiveWorkoutActive state with session

### UI Layer - Home Screen
- [ ] **Task 5: Add "Start Workout" FAB to Home Screen** (AC: 1)
  - [ ] Subtask 5.1: Update `HomeScreen` in `lib/presentation/screens/home/home_screen.dart`
    - Add FloatingActionButton with "Start Workout" icon
    - On tap, show workout selection bottom sheet
  - [ ] Subtask 5.2: Create `WorkoutSelectionSheet` widget in `lib/presentation/widgets/workout_selection_sheet.dart`
    - List user's custom workouts
    - List templates
    - "Quick Start" option at top
    - Tap workout → dispatch StartWorkoutSession event

- [ ] **Task 6: Implement Workout Selection Logic** (AC: 2, 3)
  - [ ] Subtask 6.1: Load workouts from WorkoutBloc
  - [ ] Subtask 6.2: Display workouts in selectable list
  - [ ] Subtask 6.3: Implement "Quick Start" option
    - Creates session without predefined workout
    - Allows adding exercises on-the-fly
  - [ ] Subtask 6.4: On selection, dispatch StartWorkoutSession event with selected workout

### UI Layer - Active Workout Screen
- [ ] **Task 7: Create Active Workout Screen** (AC: 4, 5, 6, 7)
  - [ ] Subtask 7.1: Create `ActiveWorkoutScreen` in `lib/presentation/screens/active_workout/active_workout_screen.dart`
    - AppBar with workout name, elapsed time, close button
    - Body: current exercise view (placeholder for Story 3.2)
    - Show "Session started at [time]"
  - [ ] Subtask 7.2: Implement navigation from Home to ActiveWorkoutScreen
    - Use Navigator.push with Material route
    - Transition animation (slide from bottom)
    - Performance: transition < 500ms
  - [ ] Subtask 7.3: Add elapsed time display
    - Show "Elapsed: 0:15:32" format
    - Update every second using Timer
  - [ ] Subtask 7.4: Implement WakeLock on session start
    - Add `wakelock` package
    - Enable wakelock when session starts
    - Disable wakelock when session ends/abandoned

- [ ] **Task 8: Implement Session State Persistence** (AC: 5, 7)
  - [ ] Subtask 8.1: On session start, save to database immediately
  - [ ] Subtask 8.2: Store session ID in BLoC state
  - [ ] Subtask 8.3: Verify session persists across app restarts (integration test)

### Testing
- [ ] **Task 9: Unit Tests**
  - [ ] Subtask 9.1: Test `WorkoutSession`, `PerformedExercise`, `SetRecord` entity creation
  - [ ] Subtask 9.2: Test `WorkoutSessionModel` JSON serialization/deserialization
  - [ ] Subtask 9.3: Test `StartWorkoutSession` use case
    - Creates session with UUID
    - Sets startTime
    - Sets status to active
  - [ ] Subtask 9.4: Test `GetActiveSession` use case
    - Returns active session if exists
    - Returns null if no active session
  - [ ] Subtask 9.5: Test `WorkoutSessionRepositoryImpl` CRUD operations
  - [ ] Subtask 9.6: Test `ActiveWorkoutBloc` event handling
    - StartWorkoutSession event creates session
    - LoadActiveSession event loads existing session

- [ ] **Task 10: Widget Tests**
  - [ ] Subtask 10.1: Test Home Screen FAB renders
  - [ ] Subtask 10.2: Test WorkoutSelectionSheet displays workouts
  - [ ] Subtask 10.3: Test Quick Start option
  - [ ] Subtask 10.4: Test ActiveWorkoutScreen renders with session data
  - [ ] Subtask 10.5: Test elapsed time updates

- [ ] **Task 11: Integration Tests**
  - [ ] Subtask 11.1: Test full flow: Tap FAB → Select workout → Navigate to ActiveWorkoutScreen
  - [ ] Subtask 11.2: Test transition performance < 500ms
  - [ ] Subtask 11.3: Test wakelock enabled during session

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 3 - Technical Specifications]

New files for Active Workout feature:
```
lib/
├── domain/
│   ├── entities/
│   │   ├── workout_session.dart (NEW)
│   │   ├── performed_exercise.dart (NEW)
│   │   ├── set_record.dart (NEW)
│   │   └── session_status.dart (NEW)
│   ├── repositories/
│   │   └── workout_session_repository.dart (NEW)
│   └── usecases/
│       ├── start_workout_session.dart (NEW)
│       ├── get_active_session.dart (NEW)
│       └── resume_workout_session.dart (NEW)
├── data/
│   ├── models/
│   │   ├── workout_session_model.dart (NEW)
│   │   ├── performed_exercise_model.dart (NEW)
│   │   └── set_record_model.dart (NEW)
│   ├── datasources/local/
│   │   ├── workout_session_local_datasource.dart (NEW)
│   │   └── workout_session_local_datasource_impl.dart (NEW)
│   └── repositories/
│       └── workout_session_repository_impl.dart (NEW)
└── presentation/
    ├── blocs/active_workout/
    │   ├── active_workout_bloc.dart (NEW)
    │   ├── active_workout_event.dart (NEW)
    │   └── active_workout_state.dart (NEW)
    ├── screens/
    │   ├── home/
    │   │   └── home_screen.dart (MODIFY - add FAB)
    │   └── active_workout/
    │       └── active_workout_screen.dart (NEW)
    └── widgets/
        └── workout_selection_sheet.dart (NEW)
```

### Data Models
**Source:** [PRD Feature 3 - Technical Specifications]

**WorkoutSession Entity:**
```dart
class WorkoutSession {
  final String id; // UUID
  final String? workoutId; // null for quick start
  final DateTime startTime;
  final DateTime? endTime;
  final SessionStatus status;
  final List<PerformedExercise> performedExercises;
  final String? notes;
}
```

**PerformedExercise Entity:**
```dart
class PerformedExercise {
  final String exerciseId;
  final List<SetRecord> sets;
  final Duration? restTime;
}
```

**SetRecord Entity:**
```dart
class SetRecord {
  final int setNumber;
  final int reps;
  final double weight;
  final int? rpe; // 1-10 optional (Rate of Perceived Exertion)
  final DateTime timestamp;
}
```

**SessionStatus Enum:**
```dart
enum SessionStatus {
  active,
  completed,
  abandoned
}
```

### Database Schema
**Source:** [PRD Feature 3 - Technical Specifications]

**Table: workout_sessions**
- `id` TEXT PRIMARY KEY
- `workout_id` TEXT (FOREIGN KEY, nullable)
- `start_time` INTEGER NOT NULL
- `end_time` INTEGER
- `status` TEXT NOT NULL
- `notes` TEXT

**Table: performed_exercises**
- `id` TEXT PRIMARY KEY
- `session_id` TEXT NOT NULL (FOREIGN KEY)
- `exercise_id` TEXT NOT NULL (FOREIGN KEY)
- `rest_time` INTEGER (seconds)

**Table: set_records**
- `id` TEXT PRIMARY KEY
- `performed_exercise_id` TEXT NOT NULL (FOREIGN KEY)
- `set_number` INTEGER NOT NULL
- `reps` INTEGER NOT NULL
- `weight` REAL NOT NULL
- `rpe` INTEGER (1-10)
- `timestamp` INTEGER NOT NULL

### BLoC Architecture
**Source:** [PRD Feature 3 - Technical Specifications]

**Events:**
- `StartWorkoutSession(Workout? workout)` - Start new session
- `LoadActiveSession()` - Load existing active session (crash recovery)
- `UpdateSession(WorkoutSession session)` - Update session (auto-save)
- `CompleteSession()` - Mark session as completed
- `AbandonSession()` - Mark session as abandoned

**States:**
- `ActiveWorkoutInitial` - No active session
- `ActiveWorkoutLoading` - Loading/starting session
- `ActiveWorkoutActive(WorkoutSession session)` - Session in progress
- `ActiveWorkoutCompleted` - Session completed
- `ActiveWorkoutError(String message)` - Error occurred

### Workflow
**Source:** [PRD Feature 3 - US-3.1]

1. User taps "Start Workout" FAB on Home Screen
2. Bottom sheet shows workout options (custom workouts, templates, Quick Start)
3. User selects workout (or Quick Start)
4. ActiveWorkoutBloc dispatches StartWorkoutSession event
5. Use case creates WorkoutSession with:
   - UUID
   - startTime = now
   - status = active
   - performedExercises = empty list (or initialized from workout)
6. Session saved to database
7. Navigate to ActiveWorkoutScreen
8. WakeLock enabled
9. Elapsed timer starts

### WakeLock Implementation
**Source:** [PRD Feature 3 - US-3.1 AC]

**Purpose:** Keep screen on during workout to avoid interruptions

**Package:** `wakelock: ^0.6.2`

**Implementation:**
```dart
import 'package:wakelock/wakelock.dart';

// On session start
await Wakelock.enable();

// On session end/abandon
await Wakelock.disable();
```

### Performance Requirements
**Source:** [PRD Feature 3 - US-3.1 AC]

- **Transition time:** Home → ActiveWorkoutScreen < 500ms
- **Session creation:** < 100ms
- **Database write:** < 50ms

### UI/UX Guidelines
**Source:** [PRD Feature 3 - US-3.1]

**Home Screen FAB:**
- Position: Bottom right
- Icon: Play icon or dumbbell icon
- Color: Primary color
- Label: "Start Workout" (or icon only)

**Workout Selection Sheet:**
- Bottom sheet (not dialog)
- Height: 60% of screen
- Sections: "Quick Start", "My Workouts", "Templates"
- Each workout: name, exercise count preview
- Tap to select → sheet closes → navigate

**ActiveWorkoutScreen:**
- AppBar: Workout name, elapsed time (00:15:32), close icon
- Body: Exercise view (to be implemented in Story 3.2)
- Background: Keep consistent with app theme
- No bottom navigation (focused experience)

### Dependencies
**Source:** [PRD Technical Architecture]

New package to add to `pubspec.yaml`:
- `wakelock: ^0.6.2` - Keep screen on during workout

Existing packages:
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `get_it: ^7.6.0`
- `uuid: ^4.0.0`
- `equatable: ^2.0.5`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`, `test/data/repositories/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- Session creation with UUID generation
- StartTime set to current time
- Status set to active
- Session persists to database
- WakeLock enabled on start
- Transition performance < 500ms
- Quick Start creates session without workout

### Integration with Other Stories
**Dependencies:**
- Story 1.1 (Workouts) - Required to load workout list for selection
- Story 2.1 (Exercises) - Required for exercise data

**Enables:**
- Story 3.2 (Track Sets) - Requires active session to add sets
- Story 3.7 (Auto-save) - Builds on session persistence

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

