# Story 4.3: Contrôles timer (pause, skip, extend)

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** contrôler le timer flexiblement,  
**so that** je m'adapte à mes conditions réelles.

---

## Acceptance Criteria

1. Bouton "Pause" (gel countdown)
2. Bouton "Resume" (reprendre countdown)
3. Bouton "Skip" (terminer repos immédiatement)
4. Bouton "+30s" (extend repos de 30 secondes)
5. Bouton "-30s" (réduire repos de 30 secondes, minimum 0)
6. UI: grands boutons tactiles (minimum 48x48dp)
7. Contrôles toujours visibles dans timer overlay

---

## Tasks / Subtasks

### State Management (BLoC)
- [ ] **Task 1: Extend TimerBloc for Controls** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 1.1: Add control events to `timer_event.dart`
    - `PauseTimer()`, `ResumeTimer()`, `SkipTimer()`, `ExtendTimer(Duration extension)`, `ReduceTimer(Duration reduction)`
  - [ ] Subtask 1.2: Add paused state to `timer_state.dart`
    - `TimerPaused(Duration remaining)` - Timer stopped but not complete
  - [ ] Subtask 1.3: Update `timer_bloc.dart` to handle control events
    - PauseTimer: Cancel ticker subscription, emit TimerPaused state
    - ResumeTimer: Restart ticker with remaining duration, emit TimerRunning
    - SkipTimer: Cancel ticker, emit TimerCompleted immediately
    - ExtendTimer: Add duration to remaining time, continue countdown
    - ReduceTimer: Subtract duration (min 0), continue or complete if reaches 0

### UI Layer - Timer Control Buttons
- [ ] **Task 2: Add Control Buttons to Timer Overlay** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Subtask 2.1: Update `TimerOverlay` widget to include control buttons
    - Row of buttons below countdown display
    - Large touch targets (minimum 48x48dp)
    - Clear icons and labels
  - [ ] Subtask 2.2: Implement Pause/Resume button
    - Icon: Pause (⏸) / Play (▶)
    - Toggle between pause and resume based on state
    - Dispatch PauseTimer or ResumeTimer event on tap
  - [ ] Subtask 2.3: Implement Skip button
    - Icon: Forward/Skip (⏭)
    - Label: "Skip" or "Done"
    - Dispatch SkipTimer event
    - Confirmation dialog optional (or immediate)
  - [ ] Subtask 2.4: Implement +30s button
    - Icon: Plus (+30s)
    - Dispatch ExtendTimer(Duration(seconds: 30))
    - Visual feedback: brief highlight or animation
  - [ ] Subtask 2.5: Implement -30s button
    - Icon: Minus (-30s)
    - Dispatch ReduceTimer(Duration(seconds: 30))
    - Disable if remaining < 30s (or reduce to 0)

### UI Layout
- [ ] **Task 3: Design Control Button Layout** (AC: 6, 7)
  - [ ] Subtask 3.1: Create button row layout
    - Horizontal layout, evenly spaced
    - Order: [Pause/Resume] [Skip] [+30s] [-30s]
    - Or: [-30s] [Pause] [Skip] [+30s]
  - [ ] Subtask 3.2: Button styling
    - Large circular or rounded rect buttons
    - High contrast colors (visible with sweaty fingers)
    - Icons + optional text labels
    - Minimum 56x56dp (larger than standard 48dp for gym use)
  - [ ] Subtask 3.3: Responsive design
    - Works in portrait and landscape
    - Buttons don't overlap countdown display

### Pause/Resume Logic
- [ ] **Task 4: Implement Pause/Resume Functionality** (AC: 1, 2)
  - [ ] Subtask 4.1: On PauseTimer event
    - Cancel ticker stream subscription
    - Store current remaining duration
    - Emit TimerPaused state
  - [ ] Subtask 4.2: On ResumeTimer event
    - Restart ticker with remaining duration
    - Emit TimerRunning state
    - Continue countdown from where it stopped
  - [ ] Subtask 4.3: Update UI on pause
    - Change "Pause" button to "Resume"
    - Optional: Show "PAUSED" label
    - Countdown stops updating

### Skip Logic
- [ ] **Task 5: Implement Skip Functionality** (AC: 3)
  - [ ] Subtask 5.1: On SkipTimer event
    - Cancel ticker immediately
    - Emit TimerCompleted state
    - Trigger completion alerts (haptic, sound)
  - [ ] Subtask 5.2: Optional confirmation
    - If adding confirmation: Show dialog "Skip rest?"
    - If no confirmation: Skip immediately (faster UX)
  - [ ] Subtask 5.3: Navigate back to workout
    - Same behavior as timer naturally completing

### Extend/Reduce Logic
- [ ] **Task 6: Implement Extend/Reduce Functionality** (AC: 4, 5)
  - [ ] Subtask 6.1: On ExtendTimer event
    - Add extension duration to remaining time
    - Continue ticker with new total
    - Show brief feedback (toast or animation)
  - [ ] Subtask 6.2: On ReduceTimer event
    - Subtract reduction from remaining time
    - If remaining <= 0: Complete timer immediately
    - If remaining > 0: Continue with reduced time
  - [ ] Subtask 6.3: Visual feedback for extend/reduce
    - Brief flash or color change on countdown
    - Optional: Show "+30s" or "-30s" animation

### Testing
- [ ] **Task 7: Unit Tests**
  - [ ] Subtask 7.1: Test TimerBloc PauseTimer event
    - Emits TimerPaused state
    - Preserves remaining duration
  - [ ] Subtask 7.2: Test TimerBloc ResumeTimer event
    - Resumes from paused state
    - Continues countdown
  - [ ] Subtask 7.3: Test TimerBloc SkipTimer event
    - Immediately emits TimerCompleted
  - [ ] Subtask 7.4: Test TimerBloc ExtendTimer event
    - Adds time correctly
  - [ ] Subtask 7.5: Test TimerBloc ReduceTimer event
    - Subtracts time
    - Completes if reaches 0

- [ ] **Task 8: Widget Tests**
  - [ ] Subtask 8.1: Test control buttons render in overlay
  - [ ] Subtask 8.2: Test pause button toggles to resume
  - [ ] Subtask 8.3: Test skip button dispatches event
  - [ ] Subtask 8.4: Test +30s/-30s buttons dispatch events
  - [ ] Subtask 8.5: Test button sizes (minimum 48x48dp)

- [ ] **Task 9: Integration Tests**
  - [ ] Subtask 9.1: Test pause → resume flow
  - [ ] Subtask 9.2: Test skip ends rest immediately
  - [ ] Subtask 9.3: Test extend adds time correctly
  - [ ] Subtask 9.4: Test reduce subtracts time or completes

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 4 - US-4.4]

Modified files:
```
lib/
├── presentation/
│   ├── blocs/timer/
│   │   ├── timer_bloc.dart (MODIFY - add control event handlers)
│   │   ├── timer_event.dart (MODIFY - add control events)
│   │   └── timer_state.dart (MODIFY - add TimerPaused state)
│   └── widgets/
│       └── timer_overlay.dart (MODIFY - add control buttons)
```

### TimerBloc State Updates
**Source:** [PRD Feature 4 - US-4.4, Technical Specifications]

**Updated States:**
```dart
abstract class TimerState {}

class TimerInitial extends TimerState {
  final Duration duration;
}

class TimerRunning extends TimerState {
  final Duration remaining;
}

class TimerPaused extends TimerState { // NEW STATE
  final Duration remaining;
}

class TimerCompleted extends TimerState {}
```

**New Events:**
```dart
class PauseTimer extends TimerEvent {}
class ResumeTimer extends TimerEvent {}
class SkipTimer extends TimerEvent {}
class ExtendTimer extends TimerEvent {
  final Duration extension;
}
class ReduceTimer extends TimerEvent {
  final Duration reduction;
}
```

### Pause/Resume Implementation
**Source:** [PRD Feature 4 - US-4.4 AC]

**Pause Logic:**
```dart
on<PauseTimer>((event, emit) async {
  if (state is TimerRunning) {
    _tickerSubscription?.cancel();
    final remaining = (state as TimerRunning).remaining;
    emit(TimerPaused(remaining));
  }
});
```

**Resume Logic:**
```dart
on<ResumeTimer>((event, emit) async {
  if (state is TimerPaused) {
    final remaining = (state as TimerPaused).remaining;
    await emit.forEach<int>(
      _ticker.tick(ticks: remaining.inSeconds),
      onData: (ticksRemaining) {
        return TimerRunning(Duration(seconds: ticksRemaining));
      },
    );
    emit(TimerCompleted());
  }
});
```

### Skip Implementation
**Source:** [PRD Feature 4 - US-4.4 AC]

**Skip Logic:**
```dart
on<SkipTimer>((event, emit) {
  _tickerSubscription?.cancel();
  emit(TimerCompleted());
  // Trigger completion alerts (haptic, sound)
  HapticFeedback.heavyImpact();
  if (_soundEnabled) {
    _soundService.playTimerCompleteSound();
  }
});
```

**No confirmation needed** - User wants to skip immediately, confirmation adds friction.

### Extend/Reduce Implementation
**Source:** [PRD Feature 4 - US-4.4 AC]

**Extend Logic:**
```dart
on<ExtendTimer>((event, emit) {
  if (state is TimerRunning) {
    final current = (state as TimerRunning).remaining;
    final newRemaining = current + event.extension;
    // Restart ticker with extended duration
    _tickerSubscription?.cancel();
    _startTicker(newRemaining);
  }
});
```

**Reduce Logic:**
```dart
on<ReduceTimer>((event, emit) {
  if (state is TimerRunning) {
    final current = (state as TimerRunning).remaining;
    final newRemaining = current - event.reduction;
    
    if (newRemaining <= Duration.zero) {
      _tickerSubscription?.cancel();
      emit(TimerCompleted());
    } else {
      _tickerSubscription?.cancel();
      _startTicker(newRemaining);
    }
  }
});
```

### UI/UX Design
**Source:** [PRD Feature 4 - US-4.4]

```
Timer Overlay:
┌─────────────────────────────────┐
│         RESTING                 │
│                                 │
│          2:45                   │  ← Large countdown
│                                 │
│  ┌────────────────────────────┐│
│  │ [-30s] [⏸ Pause] [⏭ Skip]  ││  ← Control row 1
│  │              [+30s]         ││  ← Control row 2 or same row
│  └────────────────────────────┘│
└─────────────────────────────────┘
```

**Button Layout Options:**

**Option 1: Single Row (4 buttons)**
```
[-30s]  [Pause]  [Skip]  [+30s]
```

**Option 2: Two Rows**
```
    [Pause]      [Skip]
[-30s]             [+30s]
```

**Recommendation:** Single row, centered, large buttons

### Button Specifications
**Source:** [PRD Feature 4 - US-4.4 AC]

**Size:**
- Minimum: 56x56dp (larger than standard 48dp)
- Rationale: Gym use, sweaty/shaky hands

**Styling:**
- Shape: Circular or rounded rectangle
- Color: High contrast (white on dark, or colored)
- Icon: Clear, recognizable
- Label: Optional text below icon

**Icons:**
- Pause: ⏸ (standard pause icon)
- Resume: ▶ (play icon)
- Skip: ⏭ or ⏩
- +30s: ➕ or "30" with up arrow
- -30s: ➖ or "30" with down arrow

**States:**
- Normal: Default style
- Pressed: Scale down slightly + ripple
- Disabled: Grayed out (e.g., -30s when remaining < 30s)

### Pause vs Skip Use Cases
**Source:** [PRD Feature 4 - US-4.4]

**Pause:**
- User needs to adjust weight
- User needs to check form
- Distraction (phone call, trainer question)
- Resume rest after

**Skip:**
- User feels ready before timer ends
- Short rest for lighter exercises
- Time constraint (need to finish quickly)
- Immediate action, no resume

### Edge Cases
**Source:** [PRD Feature 4 - US-4.4]

**Reduce timer when remaining < 30s:**
- Option 1: Complete timer immediately (set to 0)
- Option 2: Disable -30s button
- **Recommendation:** Complete timer if < 30s

**Extend timer multiple times:**
- Allow unlimited extends
- User can add 30s, 30s, 30s... as needed

**Pause then skip:**
- Skip from paused state works
- No need to resume first

### Performance Considerations
**Source:** [PRD Feature 4 - US-4.4]

- **Pause/Resume:** Instant (< 10ms)
- **Skip:** Instant (< 10ms)
- **Extend/Reduce:** < 50ms (restart ticker)
- **Button tap responsiveness:** < 100ms visual feedback

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- Ticker from Story 4.1

### Testing Standards

**Unit Test Location:** `test/presentation/blocs/timer/`
**Widget Test Location:** `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- Pause preserves remaining time
- Resume continues from paused time
- Skip completes timer immediately
- Extend adds time correctly
- Reduce subtracts time or completes
- Button tap triggers correct event
- Button sizes meet 48dp minimum
- Paused state displays correctly

### Integration with Other Stories
**Dependencies:**
- Story 4.1 (Auto Timer) - Extends timer with controls
- Story 4.2 (Notifications) - Skip triggers completion alerts

**Enables:**
- Flexible timer experience
- User can adapt to real gym conditions
- Better UX than rigid timer

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

