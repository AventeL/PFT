# Story 4.1: Timer auto-démarré après chaque set

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** que le timer démarre automatiquement après un set,  
**so that** je respecte mes temps de repos sans friction.

---

## Acceptance Criteria

1. Après "Add Set", timer démarre immédiatement
2. Durée par défaut basée sur type exercice (Compound: 3 min, Isolation: 90s)
3. User peut override durée par exercice (dans workout editor)
4. Timer affiché en fullscreen overlay (semi-transparent)
5. Countdown visible: "2:45 remaining" format
6. Timer s'arrête automatiquement à 0s

---

## Tasks / Subtasks

### Domain Layer - Timer Logic
- [ ] **Task 1: Create Timer Entity & Ticker** (AC: 1, 2, 5, 6)
  - [ ] Subtask 1.1: Create `Ticker` class in `lib/core/utils/ticker.dart`
    - Stream<int> that emits every second
    - Used by TimerBloc to generate countdown
  - [ ] Subtask 1.2: Define default rest times by exercise category
    - Compound: Duration(minutes: 3)
    - Isolation: Duration(seconds: 90)
  - [ ] Subtask 1.3: Add `restTime` field to WorkoutExercise entity (optional override)

### Use Cases
- [ ] **Task 2: Create Timer Use Cases** (AC: 1, 2, 3)
  - [ ] Subtask 2.1: Create `GetRestTimeForExercise` use case in `lib/domain/usecases/get_rest_time_for_exercise.dart`
    - Input: Exercise (with category)
    - Output: Duration (custom override or default based on category)
    - Logic: Check if custom rest time set, else use default
  - [ ] Subtask 2.2: Create `StartRestTimer` use case in `lib/domain/usecases/start_rest_timer.dart`
    - Input: Duration
    - Trigger timer start in TimerBloc

### State Management (BLoC)
- [ ] **Task 3: Implement TimerBloc** (AC: 1, 5, 6)
  - [ ] Subtask 3.1: Create TimerBloc events in `lib/presentation/blocs/timer/timer_event.dart`
    - `StartTimer(Duration duration)`, `PauseTimer()`, `ResumeTimer()`, `ResetTimer()`, `SkipTimer()`, `ExtendTimer(Duration extension)`, `TimerTick(Duration remaining)`, `TimerComplete()`
  - [ ] Subtask 3.2: Create TimerBloc states in `lib/presentation/blocs/timer/timer_state.dart`
    - `TimerInitial(Duration duration)`, `TimerRunning(Duration remaining)`, `TimerPaused(Duration remaining)`, `TimerCompleted()`
  - [ ] Subtask 3.3: Implement TimerBloc logic in `lib/presentation/blocs/timer/timer_bloc.dart`
    - On StartTimer: Subscribe to Ticker stream, emit TimerRunning
    - On TimerTick: Decrement remaining time, emit updated state
    - On reaching 0: Emit TimerCompleted
    - Cancel stream subscription on reset/skip
  - [ ] Subtask 3.4: Integrate with ActiveWorkoutBloc
    - When AddSet event succeeds, dispatch StartTimer event

### UI Layer - Timer Overlay
- [ ] **Task 4: Create Timer Overlay Widget** (AC: 4, 5)
  - [ ] Subtask 4.1: Create `TimerOverlay` widget in `lib/presentation/widgets/timer_overlay.dart`
    - Full-screen overlay with semi-transparent background
    - Large countdown display (e.g., "2:45")
    - "RESTING" label at top
    - Control buttons: Pause, Skip, +30s (Story 4.4)
  - [ ] Subtask 4.2: Format countdown display
    - Format: "M:SS" (e.g., "2:45", "0:10")
    - Font: Large, bold, easy to read
    - Color: High contrast (white or primary color)
  - [ ] Subtask 4.3: Add semi-transparent background
    - Color: Black with 70% opacity
    - Allows seeing workout screen beneath
  - [ ] Subtask 4.4: Position overlay above ActiveWorkoutScreen
    - Use Stack widget
    - Show overlay when TimerRunning state

- [ ] **Task 5: Integrate Timer Overlay into ActiveWorkoutScreen** (AC: 1, 4)
  - [ ] Subtask 5.1: Update `ActiveWorkoutScreen` to listen to TimerBloc
  - [ ] Subtask 5.2: Show TimerOverlay when timer is running
    - Wrap screen in Stack
    - Show overlay on top when state is TimerRunning
  - [ ] Subtask 5.3: Hide overlay when timer completes or skipped

### Auto-Start Timer Logic
- [ ] **Task 6: Implement Auto-Start on Add Set** (AC: 1, 2)
  - [ ] Subtask 6.1: Update ActiveWorkoutBloc AddSet event handler
    - After set added successfully, get rest time for current exercise
    - Dispatch StartTimer event with rest duration
  - [ ] Subtask 6.2: Get rest time logic
    - Check if exercise has custom rest time override
    - If not, use default based on exercise category (compound vs isolation)
  - [ ] Subtask 6.3: Test: Verify timer starts immediately after "Add Set" tapped

### Exercise Rest Time Override
- [ ] **Task 7: Add Rest Time Override to Workout Editor** (AC: 3)
  - [ ] Subtask 7.1: Update `WorkoutBuilderScreen` to allow setting rest time per exercise
    - Add "Set Rest Time" option in exercise settings
    - Quick options: 60s, 90s, 2min, 3min, 5min
    - Custom option: time picker
  - [ ] Subtask 7.2: Save rest time with WorkoutExercise in database
    - Update workout_exercises table to include rest_time field
    - Update WorkoutExercise model
  - [ ] Subtask 7.3: Use custom rest time when starting timer
    - If restTime set on WorkoutExercise, use it
    - Else, fall back to default

### Testing
- [ ] **Task 8: Unit Tests**
  - [ ] Subtask 8.1: Test Ticker emits every second
  - [ ] Subtask 8.2: Test `GetRestTimeForExercise` use case
    - Custom rest time returns custom value
    - No custom rest time returns default (compound: 3min, isolation: 90s)
  - [ ] Subtask 8.3: Test TimerBloc events and states
    - StartTimer → TimerRunning
    - TimerTick decrements remaining time
    - Timer reaches 0 → TimerCompleted
  - [ ] Subtask 8.4: Test ActiveWorkoutBloc dispatches StartTimer after AddSet

- [ ] **Task 9: Widget Tests**
  - [ ] Subtask 9.1: Test TimerOverlay renders countdown correctly
  - [ ] Subtask 9.2: Test overlay shows when timer running
  - [ ] Subtask 9.3: Test overlay hides when timer completes

- [ ] **Task 10: Integration Tests**
  - [ ] Subtask 10.1: Test full flow: Add set → Timer starts → Countdown to 0 → Timer completes
  - [ ] Subtask 10.2: Test auto-start with different exercise types (compound vs isolation)
  - [ ] Subtask 10.3: Test custom rest time override works

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 4 - Technical Specifications]

New files for Timer feature:
```
lib/
├── core/
│   └── utils/
│       └── ticker.dart (NEW)
├── domain/
│   ├── entities/
│   │   └── workout_exercise.dart (MODIFY - add restTime field)
│   └── usecases/
│       ├── get_rest_time_for_exercise.dart (NEW)
│       └── start_rest_timer.dart (NEW)
├── presentation/
│   ├── blocs/
│   │   ├── timer/
│   │   │   ├── timer_bloc.dart (NEW)
│   │   │   ├── timer_event.dart (NEW)
│   │   │   └── timer_state.dart (NEW)
│   │   └── active_workout/
│   │       └── active_workout_bloc.dart (MODIFY - dispatch StartTimer on AddSet)
│   ├── screens/
│   │   ├── active_workout/
│   │   │   └── active_workout_screen.dart (MODIFY - show timer overlay)
│   │   └── workout_builder/
│   │       └── workout_builder_screen.dart (MODIFY - add rest time setting)
│   └── widgets/
│       └── timer_overlay.dart (NEW)
```

### Ticker Implementation
**Source:** [PRD Feature 4 - Technical Specifications]

**Purpose:** Provide a stream of ticks (every second) for the countdown timer

**Implementation:**
```dart
class Ticker {
  Stream<int> tick({required int ticks}) {
    return Stream.periodic(
      const Duration(seconds: 1),
      (x) => ticks - x - 1,
    ).take(ticks);
  }
}
```

**Usage in TimerBloc:**
```dart
await emit.forEach<int>(
  _ticker.tick(ticks: event.duration.inSeconds),
  onData: (remainingSeconds) {
    return TimerRunning(Duration(seconds: remainingSeconds));
  },
  onError: (error, stackTrace) {
    return TimerError();
  },
);
emit(TimerCompleted());
```

### Default Rest Times
**Source:** [PRD Feature 4 - US-4.1 AC]

**Rationale:** Different exercise types require different rest periods
- **Compound exercises** (Squat, Deadlift, Bench Press): Heavy, multi-joint, need longer rest → **3 minutes**
- **Isolation exercises** (Bicep Curls, Lateral Raises): Lighter, single-joint, shorter rest → **90 seconds**

**Implementation:**
```dart
Duration getDefaultRestTime(ExerciseCategory category) {
  switch (category) {
    case ExerciseCategory.compound:
      return const Duration(minutes: 3);
    case ExerciseCategory.isolation:
      return const Duration(seconds: 90);
  }
}
```

### Timer Overlay UI Design
**Source:** [PRD Feature 4 - US-4.1 AC, US-4.4]

```
┌─────────────────────────────────┐
│  (Semi-transparent background)  │
│                                 │
│        RESTING                  │ ← Label
│                                 │
│        2:45                     │ ← Large countdown (96pt font)
│                                 │
│  [Pause] [Skip] [+30s]          │ ← Control buttons
│                                 │
└─────────────────────────────────┘
```

**Styling:**
- Background: `Colors.black.withOpacity(0.7)`
- Countdown text: 96pt, bold, white
- Label text: 24pt, white
- Buttons: Large, rounded, high contrast
- Touch targets: Minimum 48x48dp

### Auto-Start Flow
**Source:** [PRD Feature 4 - US-4.1 AC]

**Sequence:**
1. User taps "Add Set" button
2. ActiveWorkoutBloc handles AddSet event
3. Set added to session → state updated
4. ActiveWorkoutBloc calls GetRestTimeForExercise use case
5. Rest time determined (custom or default)
6. ActiveWorkoutBloc dispatches StartTimer event to TimerBloc
7. TimerBloc starts countdown
8. ActiveWorkoutScreen shows TimerOverlay
9. User sees countdown immediately

**Key Requirement:** Seamless, no delay between "Add Set" and timer appearing

### Rest Time Override
**Source:** [PRD Feature 4 - US-4.3 AC]

**In Workout Builder:**
- Each exercise has optional "Rest Time" setting
- UI: Tap exercise → "Set Rest Time" option
- Quick options: 60s, 90s, 2min, 3min, 5min (chips or buttons)
- Custom option: Time picker (minutes + seconds)
- Saved in WorkoutExercise.restTime field

**During Active Workout:**
- If WorkoutExercise.restTime is set, use it
- Else, use default based on Exercise.category

**Database:**
- Update workout_exercises table: Add `rest_time` INTEGER (seconds) column

### BLoC Architecture
**Source:** [PRD Feature 4 - Technical Specifications]

**TimerBloc Events:**
- `StartTimer(Duration duration)` - Start countdown
- `PauseTimer()` - Pause countdown (Story 4.4)
- `ResumeTimer()` - Resume paused timer (Story 4.4)
- `ResetTimer()` - Reset to initial duration
- `SkipTimer()` - Skip rest immediately (Story 4.4)
- `ExtendTimer(Duration extension)` - Add time (Story 4.4)
- `TimerTick(Duration remaining)` - Internal tick event
- `TimerComplete()` - Timer reached 0

**TimerBloc States:**
- `TimerInitial(Duration duration)` - Timer not started
- `TimerRunning(Duration remaining)` - Countdown in progress
- `TimerPaused(Duration remaining)` - Timer paused (Story 4.4)
- `TimerCompleted()` - Timer finished

### Integration with AddSet
**Source:** [PRD Feature 4 - US-4.1 AC]

**ActiveWorkoutBloc.AddSet event handler:**
```dart
on<AddSet>((event, emit) async {
  // 1. Add set to session
  final updatedSession = await _addSetToExercise(event);
  emit(ActiveWorkoutActive(updatedSession));
  
  // 2. Get rest time for current exercise
  final exercise = _getExerciseById(event.exerciseId);
  final restTime = await _getRestTimeForExercise(exercise);
  
  // 3. Start timer
  _timerBloc.add(StartTimer(restTime));
});
```

### Performance Considerations
**Source:** [PRD Feature 4 - US-4.1 AC]

- **Timer start delay:** < 100ms after "Add Set" tapped
- **Tick accuracy:** ±100ms per second (acceptable)
- **UI responsiveness:** Timer overlay does not block interactions beneath

### Dependencies
**Source:** [PRD Feature 4 - Technical Specifications]

Packages to add to `pubspec.yaml`:
- `flutter_local_notifications: ^16.3.0` - For notifications (Story 4.2)
- Ticker: Built-in (no external dependency)

Existing packages:
- `flutter_bloc: ^8.1.0`
- `equatable: ^2.0.5`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`, `test/presentation/blocs/timer/`
**Widget Test Location:** `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- Ticker emits correct number of ticks
- GetRestTimeForExercise returns custom or default
- TimerBloc StartTimer → TimerRunning
- TimerBloc countdown to 0 → TimerCompleted
- ActiveWorkoutBloc AddSet dispatches StartTimer
- TimerOverlay renders and updates every second
- Integration: Add set → Timer appears and counts down

### Integration with Other Stories
**Dependencies:**
- Story 3.2 (Track Sets) - AddSet event triggers timer start
- Story 2.1 (Exercises) - Exercise category determines default rest time

**Enables:**
- Story 4.2 (Timer Notifications) - Timer completion triggers notifications
- Story 4.4 (Timer Controls) - Pause/Skip/Extend controls
- Story 4.5 (Background Timer) - Timer continues in background

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

