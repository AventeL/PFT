# Story 4.2: Notifications timer (son + vibration)

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** être alerté quand repos terminé,  
**so that** je peux me concentrer sur ma séance sans regarder écran.

---

## Acceptance Criteria

1. À 10s restantes: vibration courte + affichage "10s"
2. À 0s: vibration longue + son (optionnel)
3. Son configurable: on/off dans settings
4. Notification locale (même si app en background)
5. Timer continue en background si app minimisée

---

## Tasks / Subtasks

### Notifications Setup
- [ ] **Task 1: Configure Flutter Local Notifications** (AC: 2, 4)
  - [ ] Subtask 1.1: Add `flutter_local_notifications: ^16.3.0` to pubspec.yaml
  - [ ] Subtask 1.2: Initialize notification service in `main.dart`
    - Request permissions (Android 13+, iOS)
    - Configure notification channels (Android)
    - Configure notification settings (iOS)
  - [ ] Subtask 1.3: Create `NotificationService` in `lib/core/services/notification_service.dart`
    - Method: `showTimerCompleteNotification()`
    - Method: `showTimerWarningNotification()` (10s warning)
    - Handle notification tap (navigate back to app)

### Haptic Feedback
- [ ] **Task 2: Implement Vibration Patterns** (AC: 1, 2)
  - [ ] Subtask 2.1: Use `HapticFeedback` from Flutter SDK
  - [ ] Subtask 2.2: Implement 10s warning vibration
    - Pattern: Short vibration (HapticFeedback.lightImpact)
    - Trigger when remaining time = 10s
  - [ ] Subtask 2.3: Implement timer complete vibration
    - Pattern: Long vibration (HapticFeedback.heavyImpact)
    - Trigger when timer reaches 0s
  - [ ] Subtask 2.4: Test vibration on physical device (simulator doesn't vibrate)

### Sound Playback
- [ ] **Task 3: Implement Timer Complete Sound** (AC: 2, 3)
  - [ ] Subtask 3.1: Add sound asset `assets/sounds/timer_complete.mp3`
    - Short, pleasant chime (1-2 seconds)
    - Not too loud or jarring
  - [ ] Subtask 3.2: Add `audioplayers: ^5.2.0` package for sound playback
  - [ ] Subtask 3.3: Create `SoundService` in `lib/core/services/sound_service.dart`
    - Method: `playTimerCompleteSound()`
    - Load sound asset
    - Play sound at appropriate volume
  - [ ] Subtask 3.4: Integrate with TimerBloc
    - On TimerComplete event, check if sound enabled in settings
    - If enabled, play sound

### Settings Integration
- [ ] **Task 4: Add Sound Settings** (AC: 3)
  - [ ] Subtask 4.1: Create `SettingsRepository` in `lib/domain/repositories/settings_repository.dart`
    - Method: `getSoundEnabled()` → bool
    - Method: `setSoundEnabled(bool enabled)`
    - Store in SharedPreferences
  - [ ] Subtask 4.2: Create Settings screen (basic version for this story)
    - Switch: "Timer Sound" (on/off)
    - Save preference when toggled
  - [ ] Subtask 4.3: Update TimerBloc to check sound setting before playing
    - Load setting on init
    - Only play sound if enabled

### TimerBloc Integration
- [ ] **Task 5: Integrate Notifications into TimerBloc** (AC: 1, 2)
  - [ ] Subtask 5.1: Update TimerBloc to trigger 10s warning
    - When remaining time = 10s, dispatch event
    - Show "10s" on timer overlay (visual + text)
    - Trigger short vibration
  - [ ] Subtask 5.2: Update TimerBloc to trigger completion alerts
    - On TimerCompleted state, trigger:
      - Long vibration
      - Sound (if enabled)
      - Notification (if app in background)
  - [ ] Subtask 5.3: Add visual feedback for 10s warning
    - Change timer color to orange/yellow
    - Show "10s!" text
    - Pulsing animation

### Background Timer Support
- [ ] **Task 6: Implement Background Timer** (AC: 4, 5)
  - [ ] Subtask 6.1: Configure app to run timer in background
    - Android: Use foreground service with notification
    - iOS: Use background modes (limited support)
  - [ ] Subtask 6.2: Show persistent notification during active timer
    - Title: "Rest Timer"
    - Content: "2:45 remaining"
    - Update notification every second with countdown
    - Tap notification → return to app
  - [ ] Subtask 6.3: Handle app lifecycle events
    - On app paused: Show persistent notification
    - On app resumed: Hide persistent notification, sync timer state
  - [ ] Subtask 6.4: Test background timer
    - Start timer → minimize app → verify countdown continues
    - Verify notification shows and updates
    - Verify alert triggers at 0s even when backgrounded

### Testing
- [ ] **Task 7: Unit Tests**
  - [ ] Subtask 7.1: Test NotificationService methods
    - showTimerCompleteNotification()
    - showTimerWarningNotification()
  - [ ] Subtask 7.2: Test SoundService
    - playTimerCompleteSound() plays sound
    - Respects enabled/disabled setting
  - [ ] Subtask 7.3: Test SettingsRepository
    - getSoundEnabled() returns saved preference
    - setSoundEnabled() persists preference
  - [ ] Subtask 7.4: Test TimerBloc triggers alerts at correct times
    - 10s warning at remaining = 10s
    - Completion alerts at remaining = 0s

- [ ] **Task 8: Widget Tests**
  - [ ] Subtask 8.1: Test Settings screen renders sound toggle
  - [ ] Subtask 8.2: Test timer overlay shows 10s warning visuals

- [ ] **Task 9: Integration Tests (Physical Device Required)**
  - [ ] Subtask 9.1: Test vibration on 10s warning
  - [ ] Subtask 9.2: Test vibration + sound on timer complete
  - [ ] Subtask 9.3: Test background timer with notifications
    - Start timer → minimize app → wait for completion → verify alert
  - [ ] Subtask 9.4: Test notification tap returns to app

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 4 - US-4.2]

New files:
```
lib/
├── core/
│   └── services/
│       ├── notification_service.dart (NEW)
│       └── sound_service.dart (NEW)
├── domain/
│   └── repositories/
│       └── settings_repository.dart (NEW)
├── data/
│   └── repositories/
│       └── settings_repository_impl.dart (NEW)
├── presentation/
│   ├── blocs/timer/
│   │   └── timer_bloc.dart (MODIFY - add alert triggers)
│   └── screens/settings/
│       └── settings_screen.dart (NEW - basic version)

assets/
└── sounds/
    └── timer_complete.mp3 (NEW)
```

### Notification Configuration
**Source:** [PRD Feature 4 - US-4.2 AC]

**Android Configuration:**
Add to `android/app/src/main/AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.VIBRATE" />
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
```

**iOS Configuration:**
Add to `ios/Runner/Info.plist`:
```xml
<key>UIBackgroundModes</key>
<array>
  <string>audio</string>
</array>
```

**Notification Channel (Android):**
```dart
const AndroidNotificationChannel channel = AndroidNotificationChannel(
  'timer_channel',
  'Timer Notifications',
  description: 'Rest timer alerts',
  importance: Importance.high,
  sound: RawResourceAndroidNotificationSound('timer_complete'),
  enableVibration: true,
);
```

### Vibration Patterns
**Source:** [PRD Feature 4 - US-4.2 AC]

**10s Warning (Light):**
```dart
HapticFeedback.lightImpact(); // Short, gentle vibration
```

**Timer Complete (Heavy):**
```dart
HapticFeedback.heavyImpact(); // Long, strong vibration
```

**Note:** Haptic feedback requires physical device for testing

### Sound Implementation
**Source:** [PRD Feature 4 - US-4.2 AC]

**Sound Asset:**
- File: `assets/sounds/timer_complete.mp3`
- Duration: 1-2 seconds
- Type: Pleasant chime or beep
- Volume: Medium (not startling)

**Playback:**
```dart
import 'package:audioplayers/audioplayers.dart';

class SoundService {
  final AudioPlayer _player = AudioPlayer();
  
  Future<void> playTimerCompleteSound() async {
    await _player.play(AssetSource('sounds/timer_complete.mp3'));
  }
}
```

### Settings Storage
**Source:** [PRD Feature 4 - US-4.2 AC]

**Package:** `shared_preferences: ^2.2.0`

**SettingsRepository Implementation:**
```dart
class SettingsRepositoryImpl implements SettingsRepository {
  final SharedPreferences prefs;
  
  static const String _soundEnabledKey = 'timer_sound_enabled';
  
  @override
  Future<bool> getSoundEnabled() async {
    return prefs.getBool(_soundEnabledKey) ?? true; // Default: enabled
  }
  
  @override
  Future<void> setSoundEnabled(bool enabled) async {
    await prefs.setBool(_soundEnabledKey, enabled);
  }
}
```

### Background Timer Implementation
**Source:** [PRD Feature 4 - US-4.2 AC, US-4.5]

**Challenge:** iOS has limited background execution for non-audio apps

**Android Approach:**
- Use foreground service with persistent notification
- Notification shows countdown
- Updates every second
- Service keeps timer running even when app backgrounded

**iOS Approach:**
- Use background fetch (limited reliability)
- Or keep app in foreground audio mode (timer as "audio" app)
- Notifications trigger at specific times using local notification scheduling

**Persistent Notification (Android):**
```dart
flutterLocalNotificationsPlugin.show(
  0,
  'Rest Timer',
  '2:45 remaining',
  NotificationDetails(
    android: AndroidNotificationDetails(
      'timer_channel',
      'Timer Notifications',
      channelDescription: 'Rest timer countdown',
      importance: Importance.high,
      priority: Priority.high,
      ongoing: true, // Persistent
      autoCancel: false,
    ),
  ),
);
```

**Update every second:**
```dart
Timer.periodic(Duration(seconds: 1), (timer) {
  if (appInBackground && timerRunning) {
    updateNotificationWithRemainingTime(remainingDuration);
  }
});
```

### Timer Alert Triggers
**Source:** [PRD Feature 4 - US-4.2 AC]

**10s Warning:**
- Trigger: `remaining.inSeconds == 10`
- Actions:
  - Visual: Change timer color to orange, show "10s!" text
  - Haptic: `HapticFeedback.lightImpact()`
  - Sound: None (only at completion)

**Timer Complete (0s):**
- Trigger: `remaining.inSeconds == 0`
- Actions:
  - Visual: Timer overlay shows "REST COMPLETE!" message
  - Haptic: `HapticFeedback.heavyImpact()`
  - Sound: Play timer_complete.mp3 (if enabled in settings)
  - Notification: Show notification (if app in background)

### TimerBloc Integration
**Source:** [PRD Feature 4 - Technical Specifications]

**Updated TimerBloc logic:**
```dart
on<TimerTick>((event, emit) {
  final remaining = event.remaining;
  
  // 10s warning
  if (remaining.inSeconds == 10) {
    HapticFeedback.lightImpact();
    _notificationService.showTimerWarningNotification();
  }
  
  // Timer complete
  if (remaining.inSeconds == 0) {
    HapticFeedback.heavyImpact();
    
    // Play sound if enabled
    final soundEnabled = await _settingsRepository.getSoundEnabled();
    if (soundEnabled) {
      _soundService.playTimerCompleteSound();
    }
    
    // Show notification if app in background
    if (_appInBackground) {
      _notificationService.showTimerCompleteNotification();
    }
    
    emit(TimerCompleted());
  } else {
    emit(TimerRunning(remaining));
  }
});
```

### Visual 10s Warning
**Source:** [PRD Feature 4 - US-4.2 AC]

**Timer Overlay Changes at 10s:**
- Countdown color: Change to amber/orange
- Show "10s!" text above countdown
- Pulsing animation on countdown number
- Border or glow effect

**Implementation:**
```dart
Widget build(BuildContext context) {
  final isWarning = remaining.inSeconds <= 10;
  
  return Text(
    formatDuration(remaining),
    style: TextStyle(
      fontSize: 96,
      fontWeight: FontWeight.bold,
      color: isWarning ? Colors.orange : Colors.white,
    ),
  );
}
```

### Dependencies
**Source:** [PRD Feature 4 - Technical Specifications]

New packages to add to `pubspec.yaml`:
- `flutter_local_notifications: ^16.3.0` - Local notifications
- `audioplayers: ^5.2.0` - Sound playback
- `shared_preferences: ^2.2.0` - Settings storage

Existing packages:
- `flutter_bloc: ^8.1.0`
- `wakelock: ^0.6.2` (from Story 3.1)

### Testing Challenges
**Source:** Best Practices

**Vibration/Sound Testing:**
- Cannot test on simulator/emulator
- Requires physical device
- Manual testing required

**Background Timer Testing:**
- Test on physical device
- Test different scenarios:
  - Minimize app
  - Lock screen
  - Switch to other apps
- Verify timer continues and alerts trigger

### Settings Screen (Basic)
**Source:** [PRD Feature 4 - US-4.2 AC]

For this story, create a minimal Settings screen with just the sound toggle. Full settings screen will be expanded in Story 7.x.

**Basic Settings Screen:**
```
┌─────────────────────────────────┐
│  ← Settings                     │
├─────────────────────────────────┤
│  Timer Settings                 │
│                                 │
│  Timer Sound        [ON/OFF]    │
│  Play sound when timer complete │
│                                 │
└─────────────────────────────────┘
```

### Performance Considerations
**Source:** [PRD Feature 4 - US-4.2 AC]

- **Notification overhead:** < 10ms to show/update notification
- **Sound playback latency:** < 100ms from trigger to sound
- **Battery impact:** Background timer with persistent notification has minimal impact (< 1% per hour)

### Testing Standards

**Unit Test Location:** `test/core/services/`, `test/domain/repositories/`
**Widget Test Location:** `test/presentation/screens/`
**Integration Test Location:** `integration_test/` (requires physical device)
**Coverage Target:** >80%

**Key Test Cases:**
- NotificationService shows notifications
- SoundService plays sound
- SettingsRepository stores and retrieves preferences
- TimerBloc triggers alerts at 10s and 0s
- Background timer continues when app minimized
- Alert triggers even when app in background

### Integration with Other Stories
**Dependencies:**
- Story 4.1 (Auto Timer) - Timer must be running to trigger alerts

**Enables:**
- Story 4.4 (Timer Controls) - Controls work with alerts
- Story 4.5 (Background Timer) - Alerts work in background

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

