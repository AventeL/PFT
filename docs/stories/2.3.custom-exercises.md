# Story 2.3: Créer exercices personnalisés

## Status
**Draft**

---

## Story

**As a** utilisateur avancé,  
**I want to** créer mes propres exercices,  
**so that** je peux tracker des mouvements non standards.

---

## Acceptance Criteria

1. Bouton "Create Custom Exercise" dans exercise list
2. User renseigne: nom (requis), groupe musculaire, type, équipement
3. Instructions (optionnel, 500 char max)
4. Exercice custom marqué avec badge "Custom"
5. Exercices customs apparaissent dans liste générale
6. Validation: nom unique (case-insensitive)
7. User peut éditer/supprimer ses exercices customs

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Custom Exercise Use Cases** (AC: 2, 6, 7)
  - [ ] Subtask 1.1: Create `CreateCustomExercise` use case in `lib/domain/usecases/create_custom_exercise.dart`
    - Input: name, muscleGroup, category, equipmentType, instructions?
    - Validation: name not empty, name unique (case-insensitive)
    - Generate UUID
    - Set isCustom = true
    - Set createdAt = now
    - Save to repository
  - [ ] Subtask 1.2: Create `UpdateCustomExercise` use case in `lib/domain/usecases/update_custom_exercise.dart`
    - Input: exerciseId, updated fields
    - Only allow updates if isCustom = true
    - Update in repository
  - [ ] Subtask 1.3: Create `DeleteCustomExercise` use case in `lib/domain/usecases/delete_custom_exercise.dart`
    - Input: exerciseId
    - Only allow delete if isCustom = true
    - Check if exercise used in workouts (warn user)
    - Delete from repository

### Repository Extension
- [ ] **Task 2: Extend ExerciseRepository** (AC: 6)
  - [ ] Subtask 2.1: Add method `Future<bool> isExerciseNameUnique(String name, String? excludeId)`
    - Query database for exercise with same name (case-insensitive)
    - Exclude current exercise ID if editing
  - [ ] Subtask 2.2: Add delete method if not exists
    - `Future<void> deleteExercise(String exerciseId)`

### State Management (BLoC)
- [ ] **Task 3: Extend ExerciseBloc for Custom Exercises** (AC: 1, 2, 5, 7)
  - [ ] Subtask 3.1: Add custom exercise events to `exercise_event.dart`
    - `CreateCustomExercise(...)`, `UpdateCustomExercise(...)`, `DeleteCustomExercise(String id)`
  - [ ] Subtask 3.2: Update `exercise_state.dart` if needed
    - ExercisesLoaded state already includes all exercises (custom + predefined)
  - [ ] Subtask 3.3: Update `exercise_bloc.dart` logic
    - Handle CreateCustomExercise event
    - Validate name uniqueness
    - Handle UpdateCustomExercise event
    - Handle DeleteCustomExercise event
    - Reload exercises after create/update/delete

### UI Layer - Create Exercise Screen
- [ ] **Task 4: Create Custom Exercise Form** (AC: 1, 2, 3)
  - [ ] Subtask 4.1: Create `CreateExerciseScreen` in `lib/presentation/screens/create_exercise/create_exercise_screen.dart`
    - TextField: Exercise name (required, max 100 chars)
    - Dropdown: Muscle group (required)
    - Dropdown: Category (Compound/Isolation, required)
    - Dropdown: Equipment type (required)
    - TextField: Instructions (optional, max 500 chars, multiline)
    - Save button
    - Cancel button
  - [ ] Subtask 4.2: Add validation
    - Name not empty
    - Name unique (check on save)
    - Show error if name already exists
  - [ ] Subtask 4.3: Handle save action
    - Dispatch CreateCustomExercise event
    - On success: show success message, navigate back
    - On error: show error message

### UI Layer - Edit/Delete Custom Exercise
- [ ] **Task 5: Implement Edit/Delete for Custom Exercises** (AC: 7)
  - [ ] Subtask 5.1: Add edit option in exercise list (long press menu)
    - Only show for custom exercises (isCustom = true)
    - Navigate to CreateExerciseScreen in edit mode
  - [ ] Subtask 5.2: Pre-fill form with existing data in edit mode
  - [ ] Subtask 5.3: Add delete option in edit screen or long press menu
    - Show confirmation dialog
    - If exercise used in workouts, warn user
    - Dispatch DeleteCustomExercise event

### UI Layer - Exercise List Integration
- [ ] **Task 6: Show Custom Exercises in List** (AC: 4, 5)
  - [ ] Subtask 6.1: Update `ExerciseListItem` widget to show "Custom" badge
    - If exercise.isCustom = true, show badge
    - Badge color: distinct from standard exercises
  - [ ] Subtask 6.2: Add "Create Custom Exercise" FAB or button
    - Position: Floating Action Button or in AppBar
    - Navigate to CreateExerciseScreen
  - [ ] Subtask 6.3: Sort custom exercises
    - Option 1: Mix with standard exercises (alphabetical)
    - Option 2: Show custom exercises in separate section
    - Recommendation: Mix, with badge for identification

### Testing
- [ ] **Task 7: Unit Tests**
  - [ ] Subtask 7.1: Test `CreateCustomExercise` use case
    - Creates exercise with correct fields
    - Sets isCustom = true
    - Validates name uniqueness
  - [ ] Subtask 7.2: Test `UpdateCustomExercise` use case
    - Only updates if isCustom = true
    - Updates fields correctly
  - [ ] Subtask 7.3: Test `DeleteCustomExercise` use case
    - Only deletes if isCustom = true
    - Deletes from database
  - [ ] Subtask 7.4: Test name uniqueness validation
    - Case-insensitive check
    - Excludes current exercise when editing
  - [ ] Subtask 7.5: Test ExerciseBloc custom exercise events

- [ ] **Task 8: Widget Tests**
  - [ ] Subtask 8.1: Test CreateExerciseScreen form validation
  - [ ] Subtask 8.2: Test "Custom" badge appears on custom exercises
  - [ ] Subtask 8.3: Test edit/delete options only for custom exercises

- [ ] **Task 9: Integration Tests**
  - [ ] Subtask 9.1: Test full flow: Create custom exercise → Appears in list → Use in workout
  - [ ] Subtask 9.2: Test edit custom exercise flow
  - [ ] Subtask 9.3: Test delete custom exercise with warning if used

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 2 - US-2.3]

New/Modified files:
```
lib/
├── domain/
│   ├── entities/
│   │   └── exercise.dart (MODIFY - already has isCustom field)
│   ├── repositories/
│   │   └── exercise_repository.dart (MODIFY - add uniqueness check)
│   └── usecases/
│       ├── create_custom_exercise.dart (NEW)
│       ├── update_custom_exercise.dart (NEW)
│       └── delete_custom_exercise.dart (NEW)
├── data/
│   └── repositories/
│       └── exercise_repository_impl.dart (MODIFY)
├── presentation/
│   ├── blocs/exercise/
│   │   ├── exercise_bloc.dart (MODIFY)
│   │   ├── exercise_event.dart (MODIFY)
│   │   └── exercise_state.dart (already supports custom exercises)
│   ├── screens/
│   │   └── create_exercise/
│   │       └── create_exercise_screen.dart (NEW)
│   └── widgets/
│       └── exercise_list_item.dart (MODIFY - add badge)
```

### Exercise Entity
**Source:** [PRD Feature 2 - Technical Specifications]

**Exercise entity (already defined in Story 2.1):**
```dart
class Exercise {
  final String id; // UUID
  final String name;
  final MuscleGroup muscleGroup;
  final ExerciseCategory category; // compound/isolation
  final EquipmentType equipmentType;
  final bool isCustom; // Already exists!
  final String? instructions;
  final DateTime createdAt;
}
```

**isCustom field:**
- `true` for user-created exercises
- `false` for predefined exercises from seed data

### Database Operations
**Source:** [PRD Feature 2 - US-2.3]

**Check name uniqueness:**
```sql
SELECT COUNT(*) FROM exercises 
WHERE LOWER(name) = LOWER(?) 
AND id != ?;
```

**Insert custom exercise:**
```sql
INSERT INTO exercises (id, name, muscle_group, category, equipment_type, is_custom, instructions, created_at)
VALUES (?, ?, ?, ?, ?, 1, ?, ?);
```

**Delete custom exercise:**
```sql
DELETE FROM exercises WHERE id = ? AND is_custom = 1;
```

### Validation Rules
**Source:** [PRD Feature 2 - US-2.3 AC]

1. **Name:** Required, 1-100 characters, unique (case-insensitive)
2. **Muscle Group:** Required, one of enum values
3. **Category:** Required, compound or isolation
4. **Equipment Type:** Required, one of enum values
5. **Instructions:** Optional, max 500 characters

**Uniqueness check:**
- Case-insensitive: "Bench Press" = "bench press" = "BENCH PRESS"
- Across all exercises (custom + predefined)
- When editing, exclude current exercise from check

### UI/UX Design
**Source:** [PRD Feature 2 - US-2.3]

**Create Exercise Screen:**
```
┌─────────────────────────────────┐
│  ← Create Custom Exercise  [✓]  │
├─────────────────────────────────┤
│  Exercise Name *                │
│  ┌───────────────────────────┐ │
│  │ Cable Chest Flyes         │ │
│  └───────────────────────────┘ │
│                                 │
│  Muscle Group *                 │
│  ┌───────────────────────────┐ │
│  │ Chest             ▼       │ │
│  └───────────────────────────┘ │
│                                 │
│  Type *                         │
│  ┌───────────────────────────┐ │
│  │ Isolation         ▼       │ │
│  └───────────────────────────┘ │
│                                 │
│  Equipment *                    │
│  ┌───────────────────────────┐ │
│  │ Cable             ▼       │ │
│  └───────────────────────────┘ │
│                                 │
│  Instructions (optional)        │
│  ┌───────────────────────────┐ │
│  │ Stand between cables...   │ │
│  │                           │ │
│  │                           │ │
│  └───────────────────────────┘ │
│  0/500 characters              │
│                                 │
│  [      Save Exercise      ]    │
└─────────────────────────────────┘
```

**Custom Exercise Badge:**
```
Exercise List Item:
┌─────────────────────────────────┐
│ Cable Chest Flyes    [CUSTOM]   │ ← Badge
│ Isolation • Cable               │
└─────────────────────────────────┘
```

**Badge Styling:**
- Color: Accent color (orange, purple, or theme color)
- Small, uppercase text
- Positioned top-right of exercise card

### Edit vs Delete Permissions
**Source:** [PRD Feature 2 - US-2.3 AC]

**Only custom exercises can be edited/deleted:**
- Predefined exercises: Read-only, no edit/delete options
- Custom exercises: Full CRUD permissions

**UI implementation:**
- Long press on exercise → show context menu
- If isCustom = true: Show "Edit" and "Delete" options
- If isCustom = false: Only show "View Details" option

### Delete Warning
**Source:** [PRD Feature 2 - US-2.3]

**If exercise used in workouts:**
- Query: Check if exercise exists in workout_exercises table
- If found: Show warning dialog
  - "This exercise is used in X workouts. Deleting it won't remove it from existing workouts, but you won't be able to add it to new ones."
  - Options: "Cancel" or "Delete Anyway"
- If not found: Standard confirmation
  - "Delete exercise 'Cable Chest Flyes'?"
  - Options: "Cancel" or "Delete"

### Integration with Exercise List
**Source:** [PRD Feature 2 - US-2.3 AC]

**Custom exercises in main list:**
- Appear alongside predefined exercises
- Filterable/searchable like standard exercises
- Badge distinguishes them visually
- Sort alphabetically by default

**FAB/Button placement:**
- Option 1: Floating Action Button (bottom-right)
- Option 2: AppBar action (top-right)
- Recommendation: FAB for better discoverability

### Performance Considerations
**Source:** [PRD Feature 2 - US-2.3]

- **Name uniqueness check:** < 10ms (indexed query)
- **Create operation:** < 50ms (single INSERT)
- **Delete operation:** < 50ms (single DELETE)
- **Reload list:** < 100ms (query all exercises)

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `uuid: ^4.0.0`
- `equatable: ^2.0.5`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- CreateCustomExercise validates name uniqueness
- CreateCustomExercise sets isCustom = true
- UpdateCustomExercise only works on custom exercises
- DeleteCustomExercise only works on custom exercises
- Name uniqueness is case-insensitive
- Custom badge appears only on custom exercises
- Edit/delete options only for custom exercises

### Integration with Other Stories
**Dependencies:**
- Story 2.1 (Exercise Database) - Extends exercise system

**Enables:**
- Users can track non-standard exercises
- Advanced users can customize their exercise library
- Story 1.1 (Create Workout) - Can use custom exercises in workouts

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

