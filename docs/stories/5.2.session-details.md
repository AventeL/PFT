# Story 5.2: DÃ©tails d'une sÃ©ance passÃ©e

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** revoir les dÃ©tails d'une sÃ©ance complÃ©tÃ©e,  
**so that** je peux comparer avec mes performances actuelles.

---

## Acceptance Criteria

1. Tap sur sÃ©ance dans historique â†’ navigate to session details
2. Affiche: date complÃ¨te, heure dÃ©but/fin, durÃ©e totale
3. Affiche: workout name, tous les exercices rÃ©alisÃ©s
4. Affiche: tous les sets avec reps, weight, RPE
5. Affiche: notes de sÃ©ance si prÃ©sentes
6. Option "Use as Template" (rÃ©utiliser structure)
7. Option "Repeat Workout" (refaire Ã  l'identique)

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Session Details Use Cases** (AC: 2, 3, 4, 5, 6, 7)
  - [ ] Subtask 1.1: Create `GetSessionDetails` use case in `lib/domain/usecases/get_session_details.dart`
    - Input: sessionId
    - Load full WorkoutSession with all performed exercises and sets
    - Calculate session stats (total sets, total volume, duration)
    - Return SessionDetails entity
  - [ ] Subtask 1.2: Create `CreateTemplateFromSession` use case in `lib/domain/usecases/create_template_from_session.dart`
    - Input: sessionId
    - Extract workout structure (exercises, target sets)
    - Create new Workout template
    - Save to repository
  - [ ] Subtask 1.3: Create `RepeatSession` use case in `lib/domain/usecases/repeat_session.dart`
    - Input: sessionId
    - Load session details
    - Create new active session with same structure
    - Navigate to ActiveWorkoutScreen

### State Management (BLoC)
- [ ] **Task 2: Extend HistoryBloc for Session Details** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 2.1: Add session details events to `history_event.dart`
    - `LoadSessionDetails(String sessionId)`, `CreateTemplateFromSession(String sessionId)`, `RepeatSession(String sessionId)`
  - [ ] Subtask 2.2: Add session details state to `history_state.dart`
    - `SessionDetailsLoaded(WorkoutSession session, SessionStats stats)`, `SessionDetailsError`
  - [ ] Subtask 2.3: Update `history_bloc.dart` logic
    - Handle LoadSessionDetails event
    - Load session with all exercises and sets
    - Calculate stats
    - Emit SessionDetailsLoaded state

### UI Layer - Session Details Screen
- [ ] **Task 3: Create Session Details Screen** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 3.1: Create `SessionDetailsScreen` in `lib/presentation/screens/session_details/session_details_screen.dart`
    - AppBar: Date (e.g., "Jan 8, 2026"), back button, menu (actions)
    - Header: Workout name, duration, time range (e.g., "45m â€¢ 10:15 AM - 11:00 AM")
    - Stats summary: Total sets, total volume, exercises count
    - Exercise breakdown: List of exercises with all sets
    - Notes section (if present)
  - [ ] Subtask 3.2: Create `SessionExerciseCard` widget in `lib/presentation/widgets/session_exercise_card.dart`
    - Exercise name
    - List of sets: "Set 1: 8 reps @ 80kg (RPE 8)"
    - Collapsible/expandable
  - [ ] Subtask 3.3: Format date/time display
    - Full date: "January 8, 2026"
    - Time range: "10:15 AM - 11:00 AM"
    - Duration: "45m" or "1h 23m"

### UI Layer - Actions Menu
- [ ] **Task 4: Implement Session Actions** (AC: 6, 7)
  - [ ] Subtask 4.1: Add menu button in AppBar (3 dots)
    - Options: "Use as Template", "Repeat Workout", "Share" (future), "Delete" (optional)
  - [ ] Subtask 4.2: Implement "Use as Template"
    - Dispatch CreateTemplateFromSession event
    - Show success message: "Template created: [Workout Name]"
    - Navigate back or to workout list
  - [ ] Subtask 4.3: Implement "Repeat Workout"
    - Dispatch RepeatSession event
    - Navigate to ActiveWorkoutScreen with new session
    - Pre-fill with previous performance data
  - [ ] Subtask 4.4: Confirmation dialogs for actions
    - "Use as Template" â†’ immediate action or confirm?
    - "Repeat Workout" â†’ immediate or confirm?

### UI Layer - Stats Display
- [ ] **Task 5: Display Session Statistics** (AC: 2)
  - [ ] Subtask 5.1: Calculate and display stats
    - Total sets: Count of all sets across exercises
    - Total volume: Î£(reps Ã— weight) for all sets
    - Total exercises: Count of performed exercises
    - Duration: endTime - startTime
  - [ ] Subtask 5.2: Create `SessionStatsCard` widget
    - Grid layout: 2x2 or 3x1
    - Icons for each stat
    - Large numbers, small labels

### UI Layer - Notes Display
- [ ] **Task 6: Display Session Notes** (AC: 5)
  - [ ] Subtask 6.1: Show notes section if present
    - Title: "Notes"
    - Content: session notes text
    - Styled card/container
  - [ ] Subtask 6.2: Hide notes section if empty
    - Don't show empty notes area

### Testing
- [ ] **Task 7: Unit Tests**
  - [ ] Subtask 7.1: Test `GetSessionDetails` use case
    - Loads session with all data
    - Calculates stats correctly
  - [ ] Subtask 7.2: Test `CreateTemplateFromSession` use case
    - Creates workout template from session
    - Preserves exercise structure
  - [ ] Subtask 7.3: Test `RepeatSession` use case
    - Creates new active session
    - Copies session structure
  - [ ] Subtask 7.4: Test HistoryBloc session details events
    - LoadSessionDetails loads and emits state
    - Stats calculated correctly

- [ ] **Task 8: Widget Tests**
  - [ ] Subtask 8.1: Test SessionDetailsScreen renders all data
  - [ ] Subtask 8.2: Test SessionExerciseCard displays sets correctly
  - [ ] Subtask 8.3: Test stats display shows correct numbers
  - [ ] Subtask 8.4: Test notes section shows/hides appropriately
  - [ ] Subtask 8.5: Test action menu options

- [ ] **Task 9: Integration Tests**
  - [ ] Subtask 9.1: Test full flow: History â†’ Tap session â†’ See details
  - [ ] Subtask 9.2: Test "Use as Template" creates workout
  - [ ] Subtask 9.3: Test "Repeat Workout" starts new session

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 5 - US-5.5]

New/Modified files:
```
lib/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ session_stats.dart (NEW)
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ get_session_details.dart (NEW)
â”‚       â”œâ”€â”€ create_template_from_session.dart (NEW)
â”‚       â””â”€â”€ repeat_session.dart (NEW)
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ blocs/history/
â”‚   â”‚   â”œâ”€â”€ history_bloc.dart (MODIFY)
â”‚   â”‚   â”œâ”€â”€ history_event.dart (MODIFY)
â”‚   â”‚   â””â”€â”€ history_state.dart (MODIFY)
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â””â”€â”€ session_details/
â”‚   â”‚       â””â”€â”€ session_details_screen.dart (NEW)
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ session_exercise_card.dart (NEW)
â”‚       â””â”€â”€ session_stats_card.dart (NEW)
```

### Data Models
**Source:** [PRD Feature 5 - US-5.5 AC]

**SessionStats Entity:**
```dart
class SessionStats {
  final int totalSets;
  final double totalVolume; // sum of (reps Ã— weight)
  final int exercisesCompleted;
  final Duration duration;
  final DateTime startTime;
  final DateTime endTime;
}
```

**Note:** WorkoutSession entity already exists (Story 3.1)

### Session Details Query
**Source:** [PRD Feature 5 - US-5.5 AC]

**Load full session:**
```sql
-- Session
SELECT * FROM workout_sessions WHERE id = ?;

-- Performed exercises
SELECT * FROM performed_exercises WHERE session_id = ?;

-- All sets for each exercise
SELECT * FROM set_records WHERE performed_exercise_id IN (...);
```

**Calculate stats:**
```dart
SessionStats calculateStats(WorkoutSession session) {
  int totalSets = 0;
  double totalVolume = 0.0;
  
  for (var exercise in session.performedExercises) {
    totalSets += exercise.sets.length;
    for (var set in exercise.sets) {
      totalVolume += set.reps * set.weight;
    }
  }
  
  return SessionStats(
    totalSets: totalSets,
    totalVolume: totalVolume,
    exercisesCompleted: session.performedExercises.length,
    duration: session.endTime!.difference(session.startTime),
    startTime: session.startTime,
    endTime: session.endTime!,
  );
}
```

### UI/UX Design
**Source:** [PRD Feature 5 - US-5.5]

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Jan 8, 2026           â‹®      â”‚ â† AppBar with menu
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Push Day                       â”‚ â† Workout name
â”‚  45m â€¢ 10:15 AM - 11:00 AM      â”‚ â† Duration + time
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“Š Session Stats               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  18    â”‚ 3,420  â”‚   5    â”‚  â”‚
â”‚  â”‚ Sets   â”‚ Volume â”‚ Exer.  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Exercises                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Bench Press            â–¼  â”‚ â”‚ â† Expandable
â”‚  â”‚ Set 1: 8 reps @ 80kg      â”‚ â”‚
â”‚  â”‚ Set 2: 7 reps @ 80kg      â”‚ â”‚
â”‚  â”‚ Set 3: 6 reps @ 80kg      â”‚ â”‚
â”‚  â”‚ Set 4: 6 reps @ 80kg      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Incline DB Press       â–¼  â”‚ â”‚
â”‚  â”‚ ...                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ðŸ“ Notes                       â”‚
â”‚  Felt strong today, increased  â”‚
â”‚  weight on bench press.        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Actions Menu (â‹®):**
- Use as Template
- Repeat Workout
- Share (future)
- Delete (optional)

### "Use as Template" Logic
**Source:** [PRD Feature 5 - US-5.5 AC]

**CreateTemplateFromSession:**
1. Load session
2. Extract workout structure:
   - Workout name (or generate: "My [Original Name]")
   - List of exercises with target sets (from performed exercises)
3. Create new Workout entity
4. Save to database (is_template = false, user workout)
5. Return new workout

**Example:**
- Session: "Push Day" with 5 exercises
- Template created: "My Push Day" (editable workout)

### "Repeat Workout" Logic
**Source:** [PRD Feature 5 - US-5.5 AC]

**RepeatSession:**
1. Load session details
2. Create new WorkoutSession:
   - Generate new UUID
   - startTime = now
   - status = active
   - Initialize performed exercises from previous session (empty sets)
3. Navigate to ActiveWorkoutScreen
4. Pre-fill last session data for reference (show "Last time" preview)

**User experience:**
- User sees previous performance for each exercise
- Can repeat same weights/reps or adjust
- New session tracked independently

### Date/Time Formatting
**Source:** [PRD Feature 5 - US-5.5 AC]

**Full date:** "January 8, 2026" (long format)  
**Time range:** "10:15 AM - 11:00 AM" (12-hour format with AM/PM)  
**Duration:** "45m" or "1h 23m"  

**Use `intl` package:**
```dart
import 'package:intl/intl.dart';

String formatFullDate(DateTime date) {
  return DateFormat('MMMM d, y').format(date); // "January 8, 2026"
}

String formatTimeRange(DateTime start, DateTime end) {
  final startStr = DateFormat('h:mm a').format(start); // "10:15 AM"
  final endStr = DateFormat('h:mm a').format(end); // "11:00 AM"
  return '$startStr - $endStr';
}

String formatDuration(Duration duration) {
  final hours = duration.inHours;
  final minutes = duration.inMinutes.remainder(60);
  if (hours > 0) {
    return '${hours}h ${minutes}m';
  }
  return '${minutes}m';
}
```

### Stats Display
**Source:** [PRD Feature 5 - US-5.5 AC]

**Stats to show:**
1. **Total Sets:** Count across all exercises
2. **Total Volume:** Î£(reps Ã— weight) in kg or lb
3. **Exercises:** Count of performed exercises

**Optional stats:**
- Average RPE
- Max weight lifted (single set)
- PRs achieved (Story 6.2)

### Notes Handling
**Source:** [PRD Feature 5 - US-5.5 AC]

**If notes present:**
- Show "Notes" section
- Display full note text
- Card/container styling

**If notes absent:**
- Hide notes section entirely
- Don't show empty placeholder

### Performance Considerations
**Source:** [PRD Feature 5 - US-5.5]

- **Load session:** < 200ms (join queries)
- **Render screen:** < 300ms
- **Scroll performance:** Smooth 60fps (use ListView.builder if many exercises)

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `intl: ^0.18.0` - Date formatting

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- GetSessionDetails loads full session
- Stats calculated correctly
- CreateTemplateFromSession creates workout
- RepeatSession creates new active session
- SessionDetailsScreen renders all data
- Action menu options work correctly
- Navigation from history to details

### Integration with Other Stories
**Dependencies:**
- Story 5.1 (History) - Provides list to tap into details
- Story 3.3 (Finish Session) - Creates completed sessions to view

**Enables:**
- Users can review past performance
- Users can reuse successful workouts
- Motivation through seeing progress

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

