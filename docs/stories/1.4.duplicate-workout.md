# Story 1.4: Dupliquer une séance existante

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** dupliquer une séance que j'aime,  
**so that** je peux créer des variations facilement.

---

## Acceptance Criteria

1. Action "Duplicate" dans menu contextuel (long press)
2. Séance dupliquée s'appelle "[Original Name] (Copy)"
3. User peut renommer immédiatement après duplication
4. Tous les exercices et paramètres sont copiés
5. Nouvelle séance créée avec nouvel UUID
6. CreatedAt timestamp = now pour la copie

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Duplicate Use Case** (AC: 1, 2, 4, 5, 6)
  - [ ] Subtask 1.1: Create `DuplicateWorkout` use case in `lib/domain/usecases/duplicate_workout.dart`
    - Input: workoutId
    - Load original workout
    - Create new workout with:
      - New UUID
      - Name: "[Original Name] (Copy)"
      - Copy all exercises with order, target sets, rest times
      - createdAt = now, updatedAt = now
      - isTemplate = false (user workout)
    - Save to repository
    - Return new workout

### State Management (BLoC)
- [ ] **Task 2: Extend WorkoutBloc for Duplicate** (AC: 1, 2, 5)
  - [ ] Subtask 2.1: Add DuplicateWorkout event to `workout_event.dart`
    - `DuplicateWorkout(String workoutId)`
  - [ ] Subtask 2.2: Handle event in `workout_bloc.dart`
    - Call DuplicateWorkout use case
    - Add new workout to state
    - Emit updated WorkoutsLoaded state

### UI Layer - Duplicate Action
- [ ] **Task 3: Add Duplicate Option to Context Menu** (AC: 1)
  - [ ] Subtask 3.1: Update workout list long press menu
    - Add "Duplicate" option
    - Icon: Copy icon (⎘)
  - [ ] Subtask 3.2: Handle duplicate action
    - Dispatch DuplicateWorkout event
    - Show loading indicator briefly
    - Show success toast: "Workout duplicated"

### UI Layer - Rename After Duplicate
- [ ] **Task 4: Enable Immediate Rename** (AC: 3)
  - [ ] Subtask 4.1: After duplication, navigate to WorkoutBuilderScreen in edit mode
    - Pass duplicated workout
    - Auto-focus on name field
    - Pre-select " (Copy)" suffix for easy deletion
  - [ ] Subtask 4.2: Alternative: Show rename dialog
    - Dialog with TextField pre-filled
    - User can rename or keep default
    - Save updates workout name

### Database Operations
- [ ] **Task 5: Implement Duplicate in Repository** (AC: 4, 5)
  - [ ] Subtask 5.1: Clone workout record
    - INSERT new workout with new ID
    - Copy all fields except id, createdAt, updatedAt
  - [ ] Subtask 5.2: Clone workout_exercises records
    - INSERT copies with new workout_id
    - Preserve order, target_sets, rest_time

### Testing
- [ ] **Task 6: Unit Tests**
  - [ ] Subtask 6.1: Test DuplicateWorkout use case
    - Creates new workout with new UUID
    - Copies all exercises
    - Appends " (Copy)" to name
  - [ ] Subtask 6.2: Test WorkoutBloc duplicate event
    - New workout added to state
  - [ ] Subtask 6.3: Test name format
    - "Push Day" → "Push Day (Copy)"
    - "Pull Day (Copy)" → "Pull Day (Copy) (Copy)"

- [ ] **Task 7: Widget Tests**
  - [ ] Subtask 7.1: Test duplicate option appears in menu
  - [ ] Subtask 7.2: Test duplicate creates new workout in list
  - [ ] Subtask 7.3: Test rename navigation

- [ ] **Task 8: Integration Tests**
  - [ ] Subtask 8.1: Test full flow: Duplicate → Rename → Save
  - [ ] Subtask 8.2: Test duplicated workout independent from original

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 1 - US-1.4]

New/Modified files:
```
lib/
├── domain/
│   └── usecases/
│       └── duplicate_workout.dart (NEW)
├── presentation/
│   └── blocs/workout/
│       ├── workout_bloc.dart (MODIFY)
│       └── workout_event.dart (MODIFY)
```

### Duplicate Logic
**Source:** [PRD Feature 1 - US-1.4 AC]

**Clone workout:**
```dart
Workout duplicateWorkout(Workout original) {
  return Workout(
    id: Uuid().v4(), // New UUID
    name: '${original.name} (Copy)',
    description: original.description,
    exercises: original.exercises.map((e) => WorkoutExercise(
      exerciseId: e.exerciseId,
      order: e.order,
      targetSets: e.targetSets,
      restTime: e.restTime,
    )).toList(),
    notes: original.notes,
    createdAt: DateTime.now(),
    updatedAt: DateTime.now(),
    isTemplate: false,
  );
}
```

### Name Format
**Source:** [PRD Feature 1 - US-1.4 AC]

**Append " (Copy)":**
- Original: "Push Day"
- Duplicated: "Push Day (Copy)"

**If duplicate a copy:**
- "Push Day (Copy)" → "Push Day (Copy) (Copy)"
- Or smarter: "Push Day (Copy 2)"

**Recommendation:** Simple append for MVP

### Immediate Rename UX
**Source:** [PRD Feature 1 - US-1.4 AC]

**Option 1: Navigate to edit (Recommended)**
- Duplicate → Navigate to WorkoutBuilderScreen
- Name field auto-focused
- " (Copy)" suffix pre-selected
- User can delete and rename or keep

**Option 2: Rename dialog**
- Duplicate → Show dialog
- TextField with current name
- User renames or confirms
- Then added to list

**Recommendation:** Option 1 for consistency

### Context Menu Updated
**Source:** [PRD Feature 1 - US-1.4 AC]

**Long press menu:**
```
┌─────────────────────────┐
│  Edit                   │
│  Duplicate         ⎘    │  ← NEW
│  Delete                 │
└─────────────────────────┘
```

### Database Operations
**Source:** [PRD Feature 1 - US-1.4]

**Clone workout:**
```sql
INSERT INTO workouts (id, name, description, notes, created_at, updated_at, is_template)
SELECT ?, name || ' (Copy)', description, notes, ?, ?, is_template
FROM workouts WHERE id = ?;
```

**Clone exercises:**
```sql
INSERT INTO workout_exercises (id, workout_id, exercise_id, order, target_sets, rest_time)
SELECT ?, ?, exercise_id, order, target_sets, rest_time
FROM workout_exercises WHERE workout_id = ?;
```

### Performance
**Source:** [PRD Feature 1 - US-1.4]

- **Duplicate operation:** < 100ms
- **Navigation:** < 200ms

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `uuid: ^4.0.0`

### Testing Standards

**Coverage Target:** >80%

**Key Test Cases:**
- Duplicate creates independent copy
- All exercises copied correctly
- Name appends " (Copy)"
- New UUID generated
- Original unchanged

### Integration with Other Stories
**Dependencies:**
- Story 1.1 (Create Workout) - Uses same creation logic
- Story 1.3 (Edit Workout) - Rename after duplicate

**Enables:**
- Quick workout variations
- Template-like behavior for user workouts

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

