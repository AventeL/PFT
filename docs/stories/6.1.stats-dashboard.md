# Story 6.1: Dashboard statistiques globales

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** voir des statistiques globales de mon activit√©,  
**so that** je mesure mon engagement et reste motiv√©.

---

## Acceptance Criteria

1. Dashboard "Stats" accessible depuis navigation
2. Total s√©ances compl√©t√©es (completed count)
3. Total volume soulev√© all-time (sum kg)
4. Streak actuel (jours cons√©cutifs avec workout)
5. Exercice le plus fr√©quent
6. Temps total pass√© (dur√©e s√©ances cumul√©es)
7. Mise √† jour en temps r√©el apr√®s chaque s√©ance
8. Animations pour milestones (100 s√©ances, 1000 sets, etc.)

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Stats Use Cases** (AC: 2-6)
  - [ ] Subtask 1.1: Create `GetGlobalStats` use case
    - Query: COUNT completed sessions
    - Query: SUM(reps √ó weight) all sets
    - Calculate: Current streak
    - Find: Most frequent exercise
    - Calculate: Total time (SUM durations)
  - [ ] Subtask 1.2: Create `CalculateStreak` use case
    - Logic: Check last N days for workouts
    - Return: Consecutive days with at least 1 workout

### Data Models
- [ ] **Task 2: Create Stats Entities** (AC: 2-6)
  - [ ] Subtask 2.1: Create GlobalStats entity
    ```dart
    class GlobalStats {
      final int totalWorkouts;
      final double totalVolume; // kg
      final int currentStreak; // days
      final String mostFrequentExercise;
      final Duration totalTime;
    }
    ```

### State Management
- [ ] **Task 3: Create StatsBloc** (AC: 1, 7)
  - [ ] Subtask 3.1: Events: LoadStats, RefreshStats
  - [ ] Subtask 3.2: States: StatsLoading, StatsLoaded, StatsError
  - [ ] Subtask 3.3: Auto-refresh after workout complete

### UI Layer
- [ ] **Task 4: Create Stats Screen** (AC: 1-6)
  - [ ] Subtask 4.1: Create StatsScreen
    - Grid of stat cards
    - Animated numbers
  - [ ] Subtask 4.2: Create StatCard widget
    - Icon, label, value
    - Animation on load
  - [ ] Subtask 4.3: Stats to display:
    - üèãÔ∏è Total Workouts: "42"
    - üì¶ Total Volume: "12,500 kg"
    - üî• Current Streak: "7 days"
    - üí™ Favorite Exercise: "Bench Press"
    - ‚è±Ô∏è Total Time: "35h 20m"

### Milestone Celebrations
- [ ] **Task 5: Implement Milestone Animations** (AC: 8)
  - [ ] Subtask 5.1: Define milestones
    - 10, 25, 50, 100, 250, 500 workouts
    - 1000, 5000, 10000 total sets
    - 7, 30, 100 day streaks
  - [ ] Subtask 5.2: Check for milestone on stats update
  - [ ] Subtask 5.3: Show celebration dialog
    - Confetti animation
    - Badge/trophy
    - Share option (optional)

### Real-time Updates
- [ ] **Task 6: Auto-refresh Stats** (AC: 7)
  - [ ] Subtask 6.1: Listen to workout completion events
  - [ ] Subtask 6.2: Dispatch RefreshStats on complete
  - [ ] Subtask 6.3: Animate stat changes (number count-up)

### Testing
- [ ] **Task 7: Tests**
  - [ ] Subtask 7.1: Unit test calculations
  - [ ] Subtask 7.2: Test streak logic
  - [ ] Subtask 7.3: Widget tests for stat cards

---

## Dev Notes

### Stat Calculations
**Source:** [PRD Feature 5 - US-5.4]

**Total Workouts:**
```sql
SELECT COUNT(*) FROM workout_sessions WHERE status = 'completed';
```

**Total Volume:**
```sql
SELECT SUM(sr.reps * sr.weight) 
FROM set_records sr
JOIN performed_exercises pe ON sr.performed_exercise_id = pe.id
JOIN workout_sessions s ON pe.session_id = s.id
WHERE s.status = 'completed';
```

**Current Streak:**
```dart
int calculateStreak(List<WorkoutSession> sessions) {
  if (sessions.isEmpty) return 0;
  
  sessions.sort((a, b) => b.startTime.compareTo(a.startTime));
  
  int streak = 0;
  DateTime checkDate = DateTime.now();
  
  for (var session in sessions) {
    if (isSameDay(session.startTime, checkDate)) {
      streak++;
      checkDate = checkDate.subtract(Duration(days: 1));
    } else {
      break;
    }
  }
  
  return streak;
}
```

**Most Frequent Exercise:**
```sql
SELECT e.name, COUNT(*) as frequency
FROM performed_exercises pe
JOIN exercises e ON pe.exercise_id = e.id
JOIN workout_sessions s ON pe.session_id = s.id
WHERE s.status = 'completed'
GROUP BY pe.exercise_id
ORDER BY frequency DESC
LIMIT 1;
```

### Milestones
**Source:** [PRD Feature 5 - US-5.4 AC]

Trigger celebration when user reaches:
- 10, 25, 50, 100, 250, 500, 1000 workouts
- 7, 30, 100, 365 day streak
- 10,000 kg total volume milestones

### Dependencies
Existing packages only

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation | Mathis (PM) |

---

## Dev Agent Record
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

