# Story 3.3: Terminer ou abandonner sÃ©ance

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** finaliser ma sÃ©ance correctement,  
**so that** mes donnÃ©es sont enregistrÃ©es.

---

## Acceptance Criteria

1. Bouton "Finish Workout" accessible aprÃ¨s dernier exercice ou Ã  tout moment
2. Confirmation dialog: "Complete workout?" ou "Save as incomplete?"
3. Si complÃ©tÃ©e: status = "completed", endTime enregistrÃ©
4. Si abandonnÃ©e: status = "abandoned", donnÃ©es conservÃ©es quand mÃªme
5. Transition vers "Workout Summary Screen"
6. Wakelock dÃ©sactivÃ© aprÃ¨s fin de sÃ©ance
7. DonnÃ©es sauvegardÃ©es dÃ©finitivement en base

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Session Completion Use Cases** (AC: 3, 4, 7)
  - [ ] Subtask 1.1: Create `CompleteWorkoutSession` use case in `lib/domain/usecases/complete_workout_session.dart`
    - Input: sessionId
    - Set endTime = DateTime.now()
    - Set status = SessionStatus.completed
    - Save to repository
    - Return completed session
  - [ ] Subtask 1.2: Create `AbandonWorkoutSession` use case in `lib/domain/usecases/abandon_workout_session.dart`
    - Input: sessionId
    - Set endTime = DateTime.now()
    - Set status = SessionStatus.abandoned
    - Keep all performed exercises and sets
    - Save to repository
  - [ ] Subtask 1.3: Create `GetSessionSummary` use case in `lib/domain/usecases/get_session_summary.dart`
    - Input: sessionId
    - Calculate: total duration, exercises completed, total sets, total volume
    - Return summary data

### State Management (BLoC)
- [ ] **Task 2: Extend ActiveWorkoutBloc for Session Completion** (AC: 1, 2, 3, 4)
  - [ ] Subtask 2.1: Add completion events to `active_workout_event.dart`
    - `FinishWorkout()`, `AbandonWorkout()`, `ConfirmCompletion()`, `ConfirmAbandon()`
  - [ ] Subtask 2.2: Add completion states to `active_workout_state.dart`
    - `ActiveWorkoutCompleted(WorkoutSession session, SessionSummary summary)`, `ActiveWorkoutAbandoned(WorkoutSession session)`
  - [ ] Subtask 2.3: Update `active_workout_bloc.dart` logic
    - Handle FinishWorkout event â†’ show confirmation dialog
    - Handle ConfirmCompletion â†’ call CompleteWorkoutSession use case
    - Handle AbandonWorkout event â†’ show confirmation dialog
    - Handle ConfirmAbandon â†’ call AbandonWorkoutSession use case
    - Emit appropriate completion state
    - Disable wakelock on completion/abandon

### UI Layer - Finish Button
- [ ] **Task 3: Add Finish Workout Button** (AC: 1)
  - [ ] Subtask 3.1: Update `ActiveWorkoutScreen` to show "Finish Workout" button
    - Position: AppBar actions or bottom of screen
    - Icon: Checkmark or flag icon
    - Always visible (not just on last exercise)
  - [ ] Subtask 3.2: Handle button tap
    - Dispatch FinishWorkout event
    - Show confirmation dialog

### UI Layer - Confirmation Dialogs
- [ ] **Task 4: Implement Confirmation Dialogs** (AC: 2)
  - [ ] Subtask 4.1: Create `WorkoutCompletionDialog` widget in `lib/presentation/widgets/workout_completion_dialog.dart`
    - Title: "Finish Workout?"
    - Options: "Complete" (green) and "Save as Incomplete" (orange)
    - Cancel button
  - [ ] Subtask 4.2: Complete option logic
    - Tap "Complete" â†’ dispatch ConfirmCompletion event
    - All exercises considered done
  - [ ] Subtask 4.3: Incomplete option logic
    - Tap "Save as Incomplete" â†’ dispatch ConfirmAbandon event
    - Partial progress saved
  - [ ] Subtask 4.4: Cancel option
    - Tap "Cancel" â†’ close dialog, continue workout

### UI Layer - Summary Screen
- [ ] **Task 5: Create Workout Summary Screen** (AC: 5)
  - [ ] Subtask 5.1: Create `WorkoutSummaryScreen` in `lib/presentation/screens/workout_summary/workout_summary_screen.dart`
    - Display session summary:
      - Workout name
      - Duration (start â†’ end)
      - Exercises completed (X of Y)
      - Total sets
      - Total volume (sets Ã— reps Ã— weight)
      - Personal records achieved (if any)
    - "Done" button â†’ navigate to Home
  - [ ] Subtask 5.2: Calculate and display duration
    - Format: "1h 23m" or "45m"
    - Show start and end times
  - [ ] Subtask 5.3: Show exercise breakdown
    - List of exercises with set counts
    - Green checkmark for completed, amber for partial
  - [ ] Subtask 5.4: Highlight PRs (if any)
    - "ğŸ† New PR: Bench Press - 100kg!"
    - Link to detailed PR view (Story 6.2)

- [ ] **Task 6: Implement Navigation to Summary** (AC: 5)
  - [ ] Subtask 6.1: On ActiveWorkoutCompleted state, navigate to SummaryScreen
    - Use Navigator.pushReplacement (can't go back to active workout)
    - Pass session data to summary screen
  - [ ] Subtask 6.2: On "Done" button in summary, navigate to Home
    - Use Navigator.popUntil or pushAndRemoveUntil

### WakeLock Management
- [ ] **Task 7: Disable WakeLock on Completion** (AC: 6)
  - [ ] Subtask 7.1: Update ActiveWorkoutBloc to disable wakelock
    - On CompleteWorkoutSession success â†’ call Wakelock.disable()
    - On AbandonWorkoutSession success â†’ call Wakelock.disable()
  - [ ] Subtask 7.2: Test wakelock disabled
    - Complete workout â†’ verify screen can sleep
    - Abandon workout â†’ verify screen can sleep

### Data Persistence
- [ ] **Task 8: Ensure Data Persisted to Database** (AC: 7)
  - [ ] Subtask 8.1: Verify CompleteWorkoutSession use case saves to DB
    - Update workout_sessions table
    - Verify status = 'completed'
    - Verify endTime saved
  - [ ] Subtask 8.2: Verify AbandonWorkoutSession use case saves to DB
    - Update workout_sessions table
    - Verify status = 'abandoned'
    - Verify all sets preserved
  - [ ] Subtask 8.3: Test data integrity
    - Complete session â†’ query DB â†’ verify data matches

### Testing
- [ ] **Task 9: Unit Tests**
  - [ ] Subtask 9.1: Test `CompleteWorkoutSession` use case
    - Sets endTime
    - Sets status to completed
    - Saves to repository
  - [ ] Subtask 9.2: Test `AbandonWorkoutSession` use case
    - Sets endTime
    - Sets status to abandoned
    - Preserves all data
  - [ ] Subtask 9.3: Test `GetSessionSummary` use case
    - Calculates duration correctly
    - Counts exercises, sets, volume
  - [ ] Subtask 9.4: Test ActiveWorkoutBloc completion events
    - FinishWorkout shows confirmation
    - ConfirmCompletion calls use case
    - Emits completed state

- [ ] **Task 10: Widget Tests**
  - [ ] Subtask 10.1: Test Finish Workout button renders
  - [ ] Subtask 10.2: Test confirmation dialog shows options
  - [ ] Subtask 10.3: Test WorkoutSummaryScreen displays data correctly
  - [ ] Subtask 10.4: Test navigation to summary screen

- [ ] **Task 11: Integration Tests**
  - [ ] Subtask 11.1: Test full flow: Start session â†’ Add sets â†’ Finish â†’ See summary
  - [ ] Subtask 11.2: Test abandon flow: Start session â†’ Add sets â†’ Abandon â†’ Data saved
  - [ ] Subtask 11.3: Test wakelock disabled after completion
  - [ ] Subtask 11.4: Test data persists in database

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 3 - US-3.6]

New/Modified files:
```
lib/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ complete_workout_session.dart (NEW)
â”‚       â”œâ”€â”€ abandon_workout_session.dart (NEW)
â”‚       â””â”€â”€ get_session_summary.dart (NEW)
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ blocs/active_workout/
â”‚   â”‚   â”œâ”€â”€ active_workout_bloc.dart (MODIFY)
â”‚   â”‚   â”œâ”€â”€ active_workout_event.dart (MODIFY)
â”‚   â”‚   â””â”€â”€ active_workout_state.dart (MODIFY)
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ active_workout/
â”‚   â”‚   â”‚   â””â”€â”€ active_workout_screen.dart (MODIFY - add Finish button)
â”‚   â”‚   â””â”€â”€ workout_summary/
â”‚   â”‚       â””â”€â”€ workout_summary_screen.dart (NEW)
â”‚   â””â”€â”€ widgets/
â”‚       â””â”€â”€ workout_completion_dialog.dart (NEW)
```

### Session Completion Logic
**Source:** [PRD Feature 3 - US-3.6 AC]

**Complete Workflow:**
1. User taps "Finish Workout" button
2. Show confirmation dialog with options:
   - **Complete:** Mark session as fully completed
   - **Save as Incomplete:** Mark as abandoned but save data
   - **Cancel:** Return to workout
3. If "Complete":
   - Set status = completed
   - Set endTime = now
   - Save to database
   - Navigate to Summary Screen
4. If "Save as Incomplete":
   - Set status = abandoned
   - Set endTime = now
   - Keep all performed exercises/sets
   - Save to database
   - Navigate to Summary Screen (or Home)

**Key Difference:**
- **Completed:** User finished entire workout as planned
- **Abandoned:** User stopped early but data should be preserved for history

### Confirmation Dialog Design
**Source:** [PRD Feature 3 - US-3.6 AC]

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Finish Workout?               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚   You've completed 4 of 5       â”‚
â”‚   exercises.                    â”‚
â”‚                                 â”‚
â”‚   [  Complete Workout  ]        â”‚ â† Green, bold
â”‚                                 â”‚
â”‚   [ Save as Incomplete ]        â”‚ â† Orange/Amber
â”‚                                 â”‚
â”‚   [       Cancel       ]        â”‚ â† Grey
â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Options:**
- **Complete Workout:** Ideal case, all done
- **Save as Incomplete:** Partial session (injury, time limit, etc.)
- **Cancel:** User wants to continue workout

### Session Summary Data
**Source:** [PRD Feature 3 - US-3.6 AC]

**SessionSummary Entity:**
```dart
class SessionSummary {
  final String sessionId;
  final Duration duration;
  final int exercisesCompleted;
  final int totalExercises;
  final int totalSets;
  final double totalVolume; // sum of (sets Ã— reps Ã— weight)
  final List<PersonalRecord> newPRs; // Story 6.2
}
```

**Calculations:**
- **Duration:** endTime - startTime
- **Exercises Completed:** Count of exercises with at least 1 set
- **Total Exercises:** Count of exercises in workout template
- **Total Sets:** Sum of all sets across exercises
- **Total Volume:** Î£(reps Ã— weight) for all sets

### Summary Screen Design
**Source:** [PRD Feature 3 - US-3.6]

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ Workout Complete!            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚   Push Day                      â”‚ â† Workout name
â”‚   45m 23s                       â”‚ â† Duration
â”‚                                 â”‚
â”‚   ğŸ“Š Summary                    â”‚
â”‚   â”œâ”€ Exercises: 5/5             â”‚
â”‚   â”œâ”€ Total Sets: 18             â”‚
â”‚   â””â”€ Total Volume: 3,420 kg     â”‚
â”‚                                 â”‚
â”‚   ğŸ† New Personal Records       â”‚
â”‚   â”œâ”€ Bench Press: 100kg         â”‚
â”‚   â””â”€ Overhead Press: 60kg       â”‚
â”‚                                 â”‚
â”‚   ğŸ“‹ Exercise Breakdown         â”‚
â”‚   âœ“ Bench Press - 4 sets        â”‚
â”‚   âœ“ Incline Press - 3 sets      â”‚
â”‚   âœ“ Dips - 3 sets               â”‚
â”‚   âœ“ Lateral Raises - 4 sets     â”‚
â”‚   âœ“ Tricep Pushdown - 4 sets    â”‚
â”‚                                 â”‚
â”‚   [       Done       ]          â”‚ â† Return to Home
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WakeLock Management
**Source:** [PRD Feature 3 - US-3.1, US-3.6]

**Enable WakeLock:**
- On session start (Story 3.1)
- Keeps screen on during workout

**Disable WakeLock:**
- On session complete (this story)
- On session abandon (this story)
- On app error/crash (handled by lifecycle)

**Implementation:**
```dart
// In ActiveWorkoutBloc
on<ConfirmCompletion>((event, emit) async {
  final completedSession = await _completeWorkoutSession(state.session.id);
  await Wakelock.disable(); // Screen can sleep now
  emit(ActiveWorkoutCompleted(completedSession, summary));
});
```

### Database Updates
**Source:** [PRD Feature 3 - Technical Specifications]

**Update workout_sessions table:**
```sql
UPDATE workout_sessions 
SET 
  end_time = ?, 
  status = ? 
WHERE id = ?;
```

**Status Values:**
- `'active'` - Session in progress
- `'completed'` - Session finished normally
- `'abandoned'` - Session stopped early but saved

**All set data preserved regardless of status.**

### Navigation Flow
**Source:** [PRD Feature 3 - US-3.6 AC]

**Complete/Abandon â†’ Summary â†’ Home:**
```
ActiveWorkoutScreen
  â””â”€> [Finish button tapped]
      â””â”€> [Confirmation dialog]
          â”œâ”€> [Complete]
          â”‚   â””â”€> WorkoutSummaryScreen
          â”‚       â””â”€> [Done button]
          â”‚           â””â”€> HomeScreen
          â””â”€> [Save as Incomplete]
              â””â”€> WorkoutSummaryScreen (or directly to Home)
```

**Navigation Implementation:**
```dart
// Navigate to summary (can't go back)
Navigator.of(context).pushReplacement(
  MaterialPageRoute(
    builder: (_) => WorkoutSummaryScreen(session: completedSession),
  ),
);

// Navigate to home (clear stack)
Navigator.of(context).pushAndRemoveUntil(
  MaterialPageRoute(builder: (_) => HomeScreen()),
  (route) => false,
);
```

### Integration with Auto-Save
**Source:** [PRD Feature 3 - US-3.7]

**Auto-save (Story 3.2) vs Complete:**
- **Auto-save:** Ongoing, every 30s, status remains 'active'
- **Complete:** Final save, status changes to 'completed' or 'abandoned'

**Both use same repository update method, different status.**

### Abandoned vs Incomplete
**Source:** [PRD Feature 3 - US-3.6 AC]

**Terminology:**
- **Abandoned:** User stopped workout early (technical term in DB)
- **Incomplete:** User-facing label ("Save as Incomplete")

**Why preserve abandoned sessions:**
- User may have valid reason to stop (injury, time, emergency)
- Data is still valuable for tracking
- Shows consistency (or lack thereof)
- Can filter out in history view if desired

### Performance Considerations
**Source:** [PRD Feature 3 - US-3.6]

- **Summary calculation:** < 50ms (lightweight math)
- **Database update:** < 50ms (single UPDATE query)
- **Navigation transition:** < 300ms (standard Material route)

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `wakelock: ^0.6.2`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- Complete session sets correct status and endTime
- Abandon session preserves all data
- Summary calculates correctly
- WakeLock disabled on completion
- Navigation flows correctly
- Database persists completion state

### Integration with Other Stories
**Dependencies:**
- Story 3.1 (Start Session) - Creates session to complete
- Story 3.2 (Track Sets) - Sets to preserve in abandoned session

**Enables:**
- Story 5.1 (History) - Completed/abandoned sessions appear in history
- Story 6.2 (Personal Records) - PRs calculated from completed sessions
- Story 3.7 (Crash Recovery) - Distinguish active vs completed on app restart

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

