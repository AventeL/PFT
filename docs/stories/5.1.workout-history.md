# Story 5.1: Voir historique complet des sÃ©ances

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** voir toutes mes sÃ©ances d'entraÃ®nement passÃ©es,  
**so that** je visualise ma progression et reste motivÃ©.

---

## Acceptance Criteria

1. Screen "History" accessible depuis navigation principale
2. Liste chronologique de toutes les sÃ©ances (completed + abandoned)
3. Affichage par sÃ©ance: date, workout name, durÃ©e, exercices count
4. Filtres: par pÃ©riode (semaine, mois, all), par workout type
5. Tap sur sÃ©ance â†’ navigate to session details (Story 5.2)
6. Performance: chargement < 300ms pour 100+ sÃ©ances
7. Pagination ou infinite scroll si > 50 sÃ©ances

---

## Tasks / Subtasks

### Domain Layer - Use Cases
- [ ] **Task 1: Create History Use Cases** (AC: 2, 3, 4, 6)
  - [ ] Subtask 1.1: Create `GetWorkoutHistory` use case in `lib/domain/usecases/get_workout_history.dart`
    - Input: optional filters (date range, workout type, status)
    - Query: Load workout sessions ordered by date DESC
    - Return: List<WorkoutSession>
    - Apply pagination (limit/offset)
  - [ ] Subtask 1.2: Create `GetHistoryStats` use case in `lib/domain/usecases/get_history_stats.dart`
    - Calculate: total workouts, total this week, total this month
    - Return: HistoryStats
  - [ ] Subtask 1.3: Optimize database query with indexes
    - Index on workout_sessions.start_time
    - Index on workout_sessions.status

### Repository Extension
- [ ] **Task 2: Extend WorkoutSessionRepository** (AC: 2, 4)
  - [ ] Subtask 2.1: Add method to `WorkoutSessionRepository`
    - `Future<List<WorkoutSession>> getHistory({DateRange? dateRange, String? workoutId, SessionStatus? status, int limit = 50, int offset = 0})`
  - [ ] Subtask 2.2: Implement in `WorkoutSessionRepositoryImpl`
    - Build dynamic SQL query based on filters
    - ORDER BY start_time DESC
    - LIMIT and OFFSET for pagination
  - [ ] Subtask 2.3: Add method for stats
    - `Future<HistoryStats> getHistoryStats()`
    - Count total sessions by status

### State Management (BLoC)
- [ ] **Task 3: Implement HistoryBloc** (AC: 1, 2, 4, 6)
  - [ ] Subtask 3.1: Create HistoryBloc events in `lib/presentation/blocs/history/history_event.dart`
    - `LoadHistory({DateRange? range, String? workoutId, SessionStatus? status})`, `LoadMoreHistory()`, `FilterHistory(HistoryFilters filters)`, `RefreshHistory()`
  - [ ] Subtask 3.2: Create HistoryBloc states in `lib/presentation/blocs/history/history_state.dart`
    - `HistoryInitial`, `HistoryLoading`, `HistoryLoaded(List<WorkoutSession> sessions, bool hasMore, HistoryStats stats)`, `HistoryError`
  - [ ] Subtask 3.3: Implement HistoryBloc logic in `lib/presentation/blocs/history/history_bloc.dart`
    - Handle LoadHistory event
    - Handle LoadMoreHistory for pagination
    - Handle FilterHistory
    - Track pagination state (offset, hasMore)

### UI Layer - History Screen
- [ ] **Task 4: Create History Screen** (AC: 1, 2, 3, 5)
  - [ ] Subtask 4.1: Create `HistoryScreen` in `lib/presentation/screens/history/history_screen.dart`
    - AppBar with "History" title
    - Summary stats at top (total workouts, this week, this month)
    - List of sessions below
    - Pull-to-refresh
    - Infinite scroll (load more on scroll to bottom)
  - [ ] Subtask 4.2: Create `HistoryListItem` widget in `lib/presentation/widgets/history_list_item.dart`
    - Display: date (e.g., "Jan 8, 2026"), workout name
    - Display: duration (e.g., "45m"), exercises count (e.g., "5 exercises")
    - Display: status badge (completed âœ“ or abandoned ~)
    - Tap â†’ navigate to SessionDetailsScreen
  - [ ] Subtask 4.3: Group sessions by date
    - Section headers: "Today", "Yesterday", "This Week", dates
    - Use SliverList with sticky headers

### UI Layer - Filters
- [ ] **Task 5: Implement History Filters** (AC: 4)
  - [ ] Subtask 5.1: Create `HistoryFilters` widget in `lib/presentation/widgets/history_filters.dart`
    - Chips: "All", "This Week", "This Month", "This Year"
    - Dropdown: Filter by workout type
    - Dropdown: Filter by status (All, Completed, Abandoned)
  - [ ] Subtask 5.2: Handle filter changes
    - Dispatch FilterHistory event
    - Reload history with new filters
  - [ ] Subtask 5.3: Persist filter preferences (optional)
    - Save last used filter to SharedPreferences

### UI Layer - Empty State
- [ ] **Task 6: Handle Empty History** (AC: 2)
  - [ ] Subtask 6.1: Show empty state when no sessions
    - Illustration or icon
    - Message: "No workouts yet. Start your first workout!"
    - CTA button: "Start Workout"
  - [ ] Subtask 6.2: Show filtered empty state
    - Message: "No workouts match your filters"
    - Button: "Clear Filters"

### Pagination Implementation
- [ ] **Task 7: Implement Infinite Scroll** (AC: 7)
  - [ ] Subtask 7.1: Detect scroll to bottom
    - Use ScrollController
    - Trigger LoadMoreHistory when 80% scrolled
  - [ ] Subtask 7.2: Load next page of sessions
    - Increment offset by page size (50)
    - Append to existing list
  - [ ] Subtask 7.3: Show loading indicator at bottom
    - CircularProgressIndicator while loading more
  - [ ] Subtask 7.4: Handle "no more data"
    - When hasMore = false, show "All workouts loaded"

### Performance Optimization
- [ ] **Task 8: Optimize for Large Datasets** (AC: 6)
  - [ ] Subtask 8.1: Add database indexes
    - CREATE INDEX idx_sessions_date ON workout_sessions(start_time DESC)
    - CREATE INDEX idx_sessions_status ON workout_sessions(status)
  - [ ] Subtask 8.2: Use ListView.builder for efficient rendering
    - Only render visible items
  - [ ] Subtask 8.3: Implement query pagination
    - LIMIT 50 OFFSET n
    - Avoid loading all sessions at once
  - [ ] Subtask 8.4: Test with large dataset (500+ sessions)
    - Verify load time < 300ms

### Testing
- [ ] **Task 9: Unit Tests**
  - [ ] Subtask 9.1: Test `GetWorkoutHistory` use case
    - Filters by date range
    - Filters by workout type
    - Filters by status
    - Pagination works correctly
  - [ ] Subtask 9.2: Test `GetHistoryStats` use case
    - Counts total sessions
    - Counts this week/month
  - [ ] Subtask 9.3: Test HistoryBloc
    - LoadHistory loads sessions
    - LoadMoreHistory appends sessions
    - FilterHistory reloads with filters

- [ ] **Task 10: Widget Tests**
  - [ ] Subtask 10.1: Test HistoryScreen renders list
  - [ ] Subtask 10.2: Test HistoryListItem displays data correctly
  - [ ] Subtask 10.3: Test filters change list
  - [ ] Subtask 10.4: Test empty state shows
  - [ ] Subtask 10.5: Test infinite scroll triggers load more

- [ ] **Task 11: Performance Tests**
  - [ ] Subtask 11.1: Test with 100+ sessions
    - Load time < 300ms
    - Smooth scrolling (60fps)
  - [ ] Subtask 11.2: Test with 500+ sessions
    - Pagination works
    - No memory issues

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 5 - US-5.1]

New files:
```
lib/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ history_stats.dart (NEW)
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ get_workout_history.dart (NEW)
â”‚       â””â”€â”€ get_history_stats.dart (NEW)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ workout_session_repository_impl.dart (MODIFY - add history methods)
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ blocs/history/
â”‚   â”‚   â”œâ”€â”€ history_bloc.dart (NEW)
â”‚   â”‚   â”œâ”€â”€ history_event.dart (NEW)
â”‚   â”‚   â””â”€â”€ history_state.dart (NEW)
â”‚   â”œâ”€â”€ screens/history/
â”‚   â”‚   â””â”€â”€ history_screen.dart (NEW)
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ history_list_item.dart (NEW)
â”‚       â””â”€â”€ history_filters.dart (NEW)
```

### Data Models
**Source:** [PRD Feature 5 - Technical Specifications]

**HistoryStats Entity:**
```dart
class HistoryStats {
  final int totalWorkouts;
  final int completedWorkouts;
  final int abandonedWorkouts;
  final int thisWeek;
  final int thisMonth;
}
```

**DateRange Filter:**
```dart
enum DateRange {
  thisWeek,
  thisMonth,
  last3Months,
  thisYear,
  all
}
```

### Database Query
**Source:** [PRD Feature 5 - US-5.1 AC]

**Get History with Filters:**
```sql
SELECT * FROM workout_sessions
WHERE 
  start_time >= ? AND start_time <= ?  -- Date range filter
  AND (? IS NULL OR workout_id = ?)    -- Workout type filter
  AND (? IS NULL OR status = ?)        -- Status filter
ORDER BY start_time DESC
LIMIT ? OFFSET ?;
```

**Get Stats:**
```sql
-- Total workouts
SELECT COUNT(*) FROM workout_sessions WHERE status IN ('completed', 'abandoned');

-- This week
SELECT COUNT(*) FROM workout_sessions 
WHERE start_time >= ? AND status IN ('completed', 'abandoned');

-- This month
SELECT COUNT(*) FROM workout_sessions 
WHERE start_time >= ? AND status IN ('completed', 'abandoned');
```

### BLoC Architecture
**Source:** [PRD Feature 5 - Technical Specifications]

**Events:**
- `LoadHistory()` - Load initial history (first page)
- `LoadMoreHistory()` - Load next page (pagination)
- `FilterHistory(HistoryFilters filters)` - Apply filters
- `RefreshHistory()` - Pull-to-refresh

**States:**
- `HistoryInitial` - Initial state
- `HistoryLoading` - Loading first page
- `HistoryLoaded(sessions, hasMore, stats)` - Data loaded
- `HistoryError(message)` - Error occurred

**State includes:**
- `List<WorkoutSession> sessions` - Current loaded sessions
- `bool hasMore` - Whether more pages available
- `HistoryStats stats` - Summary stats
- `HistoryFilters currentFilters` - Active filters

### UI/UX Design
**Source:** [PRD Feature 5 - US-5.1]

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† History                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š Summary                     â”‚
â”‚  Total: 42 workouts             â”‚
â”‚  This week: 3 â€¢ This month: 12  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filters:                       â”‚
â”‚  [All] [Week] [Month] [Year]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Today                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ“ Push Day                â”‚ â”‚
â”‚  â”‚ 45m â€¢ 5 exercises         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Yesterday                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âœ“ Pull Day                â”‚ â”‚
â”‚  â”‚ 52m â€¢ 6 exercises         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  Jan 8, 2026                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ~ Leg Day (Incomplete)    â”‚ â”‚
â”‚  â”‚ 30m â€¢ 3 exercises         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚  [Loading more...]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HistoryListItem Design
**Source:** [PRD Feature 5 - US-5.1 AC]

**Fields:**
- **Status badge:** âœ“ (completed) or ~ (abandoned)
- **Workout name:** e.g., "Push Day"
- **Duration:** e.g., "45m" or "1h 23m"
- **Exercise count:** e.g., "5 exercises"
- **Date:** Shown as section header (Today, Yesterday, Jan 8)

**Styling:**
- Card with subtle shadow
- Tap ripple effect
- Completed: normal style
- Abandoned: slightly muted color

### Pagination Strategy
**Source:** [PRD Feature 5 - US-5.1 AC]

**Page size:** 50 sessions per page

**Infinite scroll:**
- Load first page on screen open
- When user scrolls to 80% of list, load next page
- Append new sessions to existing list
- Show loading indicator at bottom
- Stop loading when hasMore = false

**Performance:**
- Only query 50 sessions at a time
- Render only visible items (ListView.builder)
- Avoid loading entire history upfront

### Date Grouping
**Source:** [PRD Feature 5 - US-5.1]

**Group sessions by date:**
- "Today" - sessions from today
- "Yesterday" - sessions from yesterday
- "This Week" - sessions from this week (group by day)
- Older - group by date (e.g., "Jan 8, 2026")

**Implementation:**
- Use SliverList with SliverPersistentHeader for sticky headers
- Or use simple section headers with ListView

### Filter Options
**Source:** [PRD Feature 5 - US-5.1 AC]

**Date Range Filters:**
- All (no filter)
- This Week (last 7 days)
- This Month (current month)
- This Year (current year)

**Workout Type Filter:**
- All workouts
- Specific workout (dropdown of user's workouts)

**Status Filter:**
- All
- Completed only
- Abandoned only

### Performance Requirements
**Source:** [PRD Feature 5 - US-5.1 AC]

- **Load time:** < 300ms for first 50 sessions
- **Scroll performance:** 60fps smooth scrolling
- **Pagination load:** < 200ms for next page
- **Database indexes:** Ensure queries use indexes

**Test with:**
- 100 sessions: < 300ms
- 500 sessions: pagination, no lag
- 1000+ sessions: still smooth

### Empty State Handling
**Source:** [PRD Feature 5 - US-5.1]

**No sessions at all:**
- Show motivational empty state
- Illustration (person lifting weights)
- "No workouts yet"
- CTA: "Start Your First Workout"

**No sessions matching filter:**
- "No workouts match your filters"
- Button: "Clear Filters"
- Show filter summary (e.g., "Showing: This Week, Push Day")

### Integration with Navigation
**Source:** [PRD Feature 5 - US-5.1 AC]

**History tab in bottom navigation:**
- Icon: Calendar or list icon
- Label: "History"
- Badge: Show unviewed workout count (optional)

**Tap session â†’ SessionDetailsScreen:**
- Navigate with session data
- Implemented in Story 5.2

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `intl: ^0.18.0` - Date formatting

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`, `test/presentation/blocs/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Performance Test Location:** `test/performance/`
**Coverage Target:** >80%

**Key Test Cases:**
- GetWorkoutHistory with various filters
- Pagination loads correct offset
- HistoryBloc handles LoadMoreHistory
- HistoryListItem displays session correctly
- Filters change displayed sessions
- Empty state shows when appropriate
- Performance with 100+ sessions

### Integration with Other Stories
**Dependencies:**
- Story 3.3 (Finish Session) - Creates completed/abandoned sessions to display

**Enables:**
- Story 5.2 (Session Details) - Tap session navigates to details
- Story 6.2 (Personal Records) - History needed to calculate PRs
- Story 6.1 (Progress Graphs) - History data for charts

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

