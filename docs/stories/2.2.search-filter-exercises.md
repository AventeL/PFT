# Story 2.2: Rechercher et filtrer exercices

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** rechercher et filtrer exercices,  
**so that** je trouve rapidement ce que je cherche.

---

## Acceptance Criteria

1. Barre de recherche (search by name)
2. Filtres par groupe musculaire (chips sélectionnables)
3. Filtres par type (compound/isolation)
4. Filtres par équipement (barbell/dumbbell/machine/bodyweight)
5. Résultats mis à jour en temps réel (debounced search)
6. Performance: search sur 50+ exercices < 50ms

---

## Tasks / Subtasks

### Domain Layer - Use Cases
- [ ] **Task 1: Create Search/Filter Use Cases** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 1.1: Create `SearchExercises` use case in `lib/domain/usecases/search_exercises.dart`
    - Input: query string, filters (muscle groups, categories, equipment types)
    - Logic: filter exercises by all criteria
    - Return filtered List<Exercise>
  - [ ] Subtask 1.2: Implement search logic (case-insensitive, partial match on name)
  - [ ] Subtask 1.3: Implement multi-filter logic (AND between different filter types, OR within same type)

### State Management (BLoC)
- [ ] **Task 2: Extend ExerciseBloc for Search/Filter** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 2.1: Add search/filter events to `exercise_event.dart`
    - `SearchExercises(String query)`, `FilterByMuscleGroups(Set<MuscleGroup> groups)`, `FilterByCategories(Set<ExerciseCategory> categories)`, `FilterByEquipmentTypes(Set<EquipmentType> types)`, `ClearFilters()`
  - [ ] Subtask 2.2: Update `exercise_state.dart` to include filter state
    - Add fields: `searchQuery`, `selectedMuscleGroups`, `selectedCategories`, `selectedEquipmentTypes`, `filteredExercises`
  - [ ] Subtask 2.3: Update `exercise_bloc.dart` to handle search/filter events
    - Implement debouncing for search (500ms delay)
    - Apply filters to exercises list
    - Emit updated state with filtered results

### UI Layer - Search & Filter
- [ ] **Task 3: Add Search Bar to Exercise List Screen** (AC: 1, 5)
  - [ ] Subtask 3.1: Add TextField search bar at top of `ExerciseListScreen`
    - Hint text: "Search exercises..."
    - Clear button when text present
    - Search icon
  - [ ] Subtask 3.2: Implement debounced search (500ms)
    - Use Timer or debounce package
    - Dispatch `SearchExercises` event on text change
  - [ ] Subtask 3.3: Show "No results found" message when filtered list empty

- [ ] **Task 4: Implement Filter Chips** (AC: 2, 3, 4)
  - [ ] Subtask 4.1: Create `ExerciseFilterChips` widget in `lib/presentation/widgets/exercise_filter_chips.dart`
    - Horizontal scrollable row of filter chips
    - Sections: Muscle Groups, Categories, Equipment Types
  - [ ] Subtask 4.2: Implement Muscle Group filter chips
    - Chips: Chest, Back, Shoulders, Arms, Legs, Core
    - Multi-select (can select multiple)
    - Selected chips highlighted
  - [ ] Subtask 4.3: Implement Category filter chips
    - Chips: Compound, Isolation
    - Multi-select
  - [ ] Subtask 4.4: Implement Equipment Type filter chips
    - Chips: Barbell, Dumbbell, Machine, Bodyweight, Cable
    - Multi-select
  - [ ] Subtask 4.5: Add "Clear Filters" button
    - Visible only when filters active
    - Resets all filters

- [ ] **Task 5: Update Exercise List to Show Filtered Results** (AC: 5, 6)
  - [ ] Subtask 5.1: Update `ExerciseListScreen` to display filtered exercises
    - Listen to ExerciseBloc state
    - Render `filteredExercises` instead of all exercises
  - [ ] Subtask 5.2: Show filter count badge
    - "X exercises found" or "Showing X of Y exercises"
  - [ ] Subtask 5.3: Optimize rendering for real-time updates
    - Use ListView.builder
    - Minimal rebuilds

### Testing
- [ ] **Task 6: Unit Tests**
  - [ ] Subtask 6.1: Test `SearchExercises` use case with various queries
    - Empty query returns all
    - Partial match (e.g., "bench" matches "Barbell Bench Press")
    - Case-insensitive search
  - [ ] Subtask 6.2: Test multi-filter logic
    - Single filter type
    - Multiple filter types (AND logic)
    - OR logic within same filter type
  - [ ] Subtask 6.3: Test ExerciseBloc search/filter events
    - SearchExercises event updates filtered list
    - FilterByMuscleGroups event
    - ClearFilters resets to all exercises
  - [ ] Subtask 6.4: Test debouncing behavior (search not triggered until 500ms idle)

- [ ] **Task 7: Widget Tests**
  - [ ] Subtask 7.1: Test search bar renders and accepts input
  - [ ] Subtask 7.2: Test filter chips render correctly
  - [ ] Subtask 7.3: Test chip selection/deselection
  - [ ] Subtask 7.4: Test "No results found" message
  - [ ] Subtask 7.5: Test "Clear Filters" button appears and works

- [ ] **Task 8: Performance Test**
  - [ ] Subtask 8.1: Verify search performance < 50ms on 50+ exercises
  - [ ] Subtask 8.2: Verify UI remains responsive during real-time filtering

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 2 - US-2.2]

New/Modified files:
```
lib/
├── domain/
│   └── usecases/
│       └── search_exercises.dart (NEW)
├── presentation/
│   ├── blocs/exercise/
│   │   ├── exercise_bloc.dart (MODIFY)
│   │   ├── exercise_event.dart (MODIFY)
│   │   └── exercise_state.dart (MODIFY)
│   ├── screens/exercise_list/
│   │   └── exercise_list_screen.dart (MODIFY)
│   └── widgets/
│       └── exercise_filter_chips.dart (NEW)
```

### Search Logic
**Source:** [PRD Feature 2 - US-2.2 AC]

**Search Algorithm:**
1. Convert query and exercise names to lowercase
2. Check if exercise name contains query substring
3. Return matching exercises

**Example:**
- Query: "press" → matches "Barbell Bench Press", "Overhead Press", "Leg Press"
- Query: "bar" → matches "Barbell Bench Press", "Barbell Rows", "Barbell Curls", "Barbell Squat"

### Filter Logic
**Source:** [PRD Feature 2 - US-2.2 AC]

**Multi-Filter Rules:**
- **Between filter types:** AND logic
  - Example: Muscle Group = Chest AND Category = Compound → only compound chest exercises
- **Within filter type:** OR logic
  - Example: Muscle Group = (Chest OR Back) → all chest and back exercises
- **Empty filters:** No filtering (show all)

**Filter Priority:**
1. Search query (highest)
2. Muscle Group filter
3. Category filter
4. Equipment Type filter

### Debouncing
**Source:** [PRD Feature 2 - US-2.2 AC]

- **Delay:** 500ms after last keystroke
- **Purpose:** Avoid excessive filtering on every character
- **Implementation:** Use `Timer` or `rxdart` debounce

**Example implementation:**
```dart
Timer? _debounce;

void _onSearchChanged(String query) {
  if (_debounce?.isActive ?? false) _debounce!.cancel();
  _debounce = Timer(const Duration(milliseconds: 500), () {
    add(SearchExercises(query));
  });
}
```

### BLoC State Updates
**Source:** [PRD Feature 2 - US-2.2 AC]

**ExerciseState (updated):**
```dart
class ExercisesLoaded extends ExerciseState {
  final List<Exercise> allExercises;
  final List<Exercise> filteredExercises;
  final String searchQuery;
  final Set<MuscleGroup> selectedMuscleGroups;
  final Set<ExerciseCategory> selectedCategories;
  final Set<EquipmentType> selectedEquipmentTypes;
  
  bool get hasActiveFilters => 
    searchQuery.isNotEmpty || 
    selectedMuscleGroups.isNotEmpty || 
    selectedCategories.isNotEmpty || 
    selectedEquipmentTypes.isNotEmpty;
}
```

### UI/UX Guidelines
**Source:** [PRD Feature 2 - US-2.2]

**Search Bar:**
- Positioned at top of screen below AppBar
- Prefix icon: search (Icons.search)
- Suffix icon: clear (Icons.clear) when text present
- Border: outlined with rounded corners
- Hint: "Search exercises..."

**Filter Chips:**
- Horizontally scrollable (SingleChildScrollView)
- Positioned below search bar
- Selected chips: filled with primary color
- Unselected chips: outlined
- Chip labels: short (e.g., "Chest", "Barbell")
- Spacing: 8px between chips

**Results:**
- "X exercises found" text below filters
- "No results found" with suggestion to adjust filters
- List updates smoothly (no flicker)

### Performance Optimization
**Source:** [PRD Feature 2 - US-2.2 AC]

**Target:** Search/filter < 50ms on 50+ exercises

**Optimizations:**
1. **In-memory filtering:** Don't query database on every filter change
2. **Efficient list operations:** Use `where()` instead of loops
3. **Avoid unnecessary rebuilds:** Use `const` widgets where possible
4. **ListView.builder:** Only render visible items
5. **Debouncing:** Reduce filter operations

### Dependencies
**Source:** [PRD Technical Architecture]

Optional packages for enhanced functionality:
- `rxdart: ^0.27.0` - Debounce operators (or use built-in Timer)

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`, `test/presentation/blocs/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Coverage Target:** >80%

**Key Test Cases:**
- Search with empty query
- Search with no matches
- Search with partial matches
- Multiple filters active simultaneously
- Clear filters resets state
- Debouncing prevents rapid searches
- Performance test (50+ exercises filtered in < 50ms)

### Integration with Story 1.1
**Note:** This story enhances the exercise picker in Story 1.1 by adding search and filter capabilities, making it easier to find exercises when building workouts.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

