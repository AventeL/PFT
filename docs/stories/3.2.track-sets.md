# Story 3.2: Tracker sets × reps × poids

## Status
**Draft**

---

## Story

**As a** utilisateur en séance,  
**I want to** enregistrer mes performances rapidement,  
**so that** je ne perds pas de temps entre séries.

---

## Acceptance Criteria

1. Interface "Set Entry" avec 3 champs: Reps, Weight, (RPE optionnel)
2. Champs numériques optimisés pour saisie rapide (numpad)
3. Bouton "Add Set" ajoute set et auto-lance timer repos
4. **Temps de saisie < 10 secondes (KPI CRITIQUE)**
5. Sets affichés en liste avec numéro (Set 1, Set 2...)
6. User peut éditer/supprimer set après ajout
7. Auto-save toutes les 30s en background
8. Preview "Last time" si exercice déjà fait

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Set Management Use Cases** (AC: 3, 6, 7)
  - [ ] Subtask 1.1: Create `AddSetToExercise` use case in `lib/domain/usecases/add_set_to_exercise.dart`
    - Input: sessionId, exerciseId, setNumber, reps, weight, rpe?
    - Create SetRecord with timestamp
    - Add to PerformedExercise.sets
    - Save session to repository
  - [ ] Subtask 1.2: Create `UpdateSet` use case in `lib/domain/usecases/update_set.dart`
    - Input: sessionId, exerciseId, setNumber, updated values
    - Update SetRecord in session
    - Save to repository
  - [ ] Subtask 1.3: Create `DeleteSet` use case in `lib/domain/usecases/delete_set.dart`
    - Input: sessionId, exerciseId, setNumber
    - Remove SetRecord from session
    - Renumber remaining sets
    - Save to repository
  - [ ] Subtask 1.4: Create `GetLastSessionForExercise` use case in `lib/domain/usecases/get_last_session_for_exercise.dart`
    - Input: exerciseId
    - Query last completed session containing this exercise
    - Return PerformedExercise with sets

### State Management (BLoC)
- [ ] **Task 2: Extend ActiveWorkoutBloc for Set Tracking** (AC: 1, 3, 5, 6, 7, 8)
  - [ ] Subtask 2.1: Add set tracking events to `active_workout_event.dart`
    - `AddSet(exerciseId, reps, weight, rpe?)`, `UpdateSet(exerciseId, setNumber, reps, weight, rpe?)`, `DeleteSet(exerciseId, setNumber)`, `LoadLastSession(exerciseId)`, `AutoSaveSession()`
  - [ ] Subtask 2.2: Update `active_workout_state.dart` to include:
    - Current exercise ID
    - Last session data for current exercise
    - Auto-save timer state
  - [ ] Subtask 2.3: Update `active_workout_bloc.dart` logic
    - Handle AddSet event (add set + dispatch timer start)
    - Handle UpdateSet, DeleteSet events
    - Handle LoadLastSession event
    - Implement auto-save every 30s using Timer.periodic
  - [ ] Subtask 2.4: Emit updated state after each set operation

### UI Layer - Set Entry Form
- [ ] **Task 3: Create Set Entry Widget** (AC: 1, 2, 4)
  - [ ] Subtask 3.1: Create `SetEntryForm` widget in `lib/presentation/widgets/set_entry_form.dart`
    - TextField for Reps (numeric keyboard, integer only)
    - TextField for Weight (numeric keyboard, decimal support)
    - TextField for RPE (optional, 1-10 slider or numeric)
    - Large "Add Set" CTA button
  - [ ] Subtask 3.2: Optimize for speed (< 10s target)
    - Auto-focus on Reps field when screen loads
    - Tab/Next to jump from Reps → Weight
    - Enter key on Weight → Add Set
    - Smart defaults: pre-fill with last set values
  - [ ] Subtask 3.3: Add input validation
    - Reps: 1-100
    - Weight: 0-500 (kg or lb)
    - RPE: 1-10 (optional)
  - [ ] Subtask 3.4: Show unit (kg or lb) from settings

- [ ] **Task 4: Create Set List Display** (AC: 5, 6)
  - [ ] Subtask 4.1: Create `SetListItem` widget in `lib/presentation/widgets/set_list_item.dart`
    - Display: "Set 1: 8 reps @ 80kg" (with checkmark)
    - RPE badge if present (e.g., "RPE 8")
    - Timestamp (e.g., "2m ago")
  - [ ] Subtask 4.2: Make sets tappable for editing
    - Tap → open inline edit mode or bottom sheet
    - Pre-fill current values
    - Save button updates set
  - [ ] Subtask 4.3: Add swipe-to-delete gesture
    - Swipe left → show red delete button
    - Tap delete → confirmation dialog
    - Delete → remove from list + renumber
  - [ ] Subtask 4.4: Display sets in ListView
    - Scrollable if many sets
    - Latest set at bottom (auto-scroll on add)

### UI Layer - Last Session Preview
- [ ] **Task 5: Implement "Last Time" Preview** (AC: 8)
  - [ ] Subtask 5.1: Create `LastSessionPreview` widget in `lib/presentation/widgets/last_session_preview.dart`
    - Display: "Last time: 3×8 @ 80kg" (collapsed view)
    - Expandable to show all sets from last session
    - If first time exercise, show "First time doing this exercise"
  - [ ] Subtask 5.2: Add "Use Last Session" button
    - Pre-fills set entry form with last session's first set
    - Or batch-adds all sets from last session
  - [ ] Subtask 5.3: Load last session on exercise start
    - Dispatch LoadLastSession event when exercise becomes active
    - Display preview at top of screen

### UI Layer - Active Workout Screen Updates
- [ ] **Task 6: Integrate Set Tracking into ActiveWorkoutScreen** (AC: 1, 5, 8)
  - [ ] Subtask 6.1: Update `ActiveWorkoutScreen` to show current exercise
    - Exercise name in large text
    - Last session preview below name
    - Set list in middle
    - Set entry form at bottom (sticky)
  - [ ] Subtask 6.2: Add exercise navigation
    - "Previous" / "Next Exercise" buttons or swipe gestures
    - Update current exercise in BLoC state
  - [ ] Subtask 6.3: Show exercise progress indicator
    - "Exercise 2 of 5" or dots indicator

### Auto-Save Implementation
- [ ] **Task 7: Implement Auto-Save** (AC: 7)
  - [ ] Subtask 7.1: Start Timer.periodic in ActiveWorkoutBloc when session starts
    - Interval: 30 seconds
    - Dispatch AutoSaveSession event
  - [ ] Subtask 7.2: Handle AutoSaveSession event
    - Call updateSession use case
    - Save current session to database
    - No UI feedback (silent background save)
  - [ ] Subtask 7.3: Cancel timer when session ends
  - [ ] Subtask 7.4: Test: Verify session persists every 30s

### Testing
- [ ] **Task 8: Unit Tests**
  - [ ] Subtask 8.1: Test `AddSetToExercise` use case
    - Creates SetRecord with correct data
    - Adds to PerformedExercise.sets
    - Saves to repository
  - [ ] Subtask 8.2: Test `UpdateSet` use case
  - [ ] Subtask 8.3: Test `DeleteSet` use case (including renumbering)
  - [ ] Subtask 8.4: Test `GetLastSessionForExercise` use case
  - [ ] Subtask 8.5: Test ActiveWorkoutBloc AddSet event
    - Set added to state
    - Timer start event dispatched (Story 4.1)
  - [ ] Subtask 8.6: Test auto-save timer (verify 30s interval)

- [ ] **Task 9: Widget Tests**
  - [ ] Subtask 9.1: Test SetEntryForm renders and accepts input
  - [ ] Subtask 9.2: Test input validation (reps, weight ranges)
  - [ ] Subtask 9.3: Test SetListItem displays set data correctly
  - [ ] Subtask 9.4: Test swipe-to-delete gesture
  - [ ] Subtask 9.5: Test LastSessionPreview displays previous data
  - [ ] Subtask 9.6: Test "Use Last Session" button pre-fills form

- [ ] **Task 10: Performance Test (CRITICAL)**
  - [ ] Subtask 10.1: Measure time from opening set entry to tapping "Add Set"
    - Target: < 10 seconds
    - Test with: auto-focus, smart defaults, Enter key shortcuts
  - [ ] Subtask 10.2: Optimize if > 10s (reduce form fields, improve keyboard flow)

- [ ] **Task 11: Integration Tests**
  - [ ] Subtask 11.1: Test full flow: Start session → Add set → Verify saved
  - [ ] Subtask 11.2: Test auto-save: Add set → Wait 30s → Kill app → Restart → Verify set persists
  - [ ] Subtask 11.3: Test edit/delete set flow

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 3 - US-3.2]

New/Modified files:
```
lib/
├── domain/
│   └── usecases/
│       ├── add_set_to_exercise.dart (NEW)
│       ├── update_set.dart (NEW)
│       ├── delete_set.dart (NEW)
│       └── get_last_session_for_exercise.dart (NEW)
├── presentation/
│   ├── blocs/active_workout/
│   │   ├── active_workout_bloc.dart (MODIFY)
│   │   ├── active_workout_event.dart (MODIFY)
│   │   └── active_workout_state.dart (MODIFY)
│   ├── screens/active_workout/
│   │   └── active_workout_screen.dart (MODIFY)
│   └── widgets/
│       ├── set_entry_form.dart (NEW)
│       ├── set_list_item.dart (NEW)
│       └── last_session_preview.dart (NEW)
```

### UI/UX Flow
**Source:** [PRD Feature 3 - US-3.2]

```
Active Workout Screen:
┌─────────────────────────────────┐
│  ← Barbell Bench Press    1/5   │ ← Exercise name + progress
├─────────────────────────────────┤
│  Last time: 3×8 @ 80kg  [▼]     │ ← Last session preview
├─────────────────────────────────┤
│  Current Sets:                  │
│  ✓ Set 1: 8 reps @ 80kg (RPE 8) │ ← Completed sets
│  ✓ Set 2: 7 reps @ 80kg (RPE 9) │
│  ✓ Set 3: 6 reps @ 80kg         │
├─────────────────────────────────┤
│  Quick Add:                     │
│  ┌─────┐ ┌───────┐ ┌─────┐     │
│  │ 8   │ │ 80.0  │ │ RPE │     │ ← Form inputs
│  │Reps │ │Weight │ │ 8   │     │
│  └─────┘ └───────┘ └─────┘     │
│                                 │
│     [  Add Set  ]               │ ← Large CTA button
└─────────────────────────────────┘
│  Timer: 2:45 ⏸️  ⏭️              │ ← Timer (Story 4.1)
└─────────────────────────────────┘
```

### KPI: < 10 Seconds Set Entry Time
**Source:** [PRD Feature 3 - US-3.2 AC]

**Critical Success Factor:** User must be able to add a set in under 10 seconds

**Optimization Strategies:**
1. **Auto-focus:** Reps field focused on screen load
2. **Smart defaults:** Pre-fill with previous set values (e.g., if Set 1 was 8 reps @ 80kg, Set 2 defaults to same)
3. **Keyboard optimization:** Numeric keyboard, Enter key submits
4. **Tab order:** Reps → Weight → Add Set (no unnecessary focus jumps)
5. **Large touch targets:** Add Set button is big and easy to tap
6. **Minimal fields:** RPE is optional, can skip
7. **Inline feedback:** No dialogs, instant add to list

**User Flow (optimized):**
1. Finish set
2. Screen already open on Set Entry
3. Reps field auto-focused → Type "8" (1s)
4. Tap Next → Weight field → Type "80" (2s)
5. Tap "Add Set" button (1s)
6. **Total: ~4-5 seconds** ✅

### Set Entry Form Design
**Source:** [PRD Feature 3 - US-3.2]

**Reps TextField:**
- Label: "Reps"
- Keyboard: TextInputType.number
- Input formatters: Only integers, max 3 digits
- Auto-focus: true
- Default: Last set reps or empty

**Weight TextField:**
- Label: "Weight (kg)" or "Weight (lb)" based on settings
- Keyboard: TextInputType.numberWithOptions(decimal: true)
- Input formatters: Decimal, max 5 digits + decimal
- Default: Last set weight or empty

**RPE Input (Optional):**
- Label: "RPE (1-10)" or slider
- Can be hidden by default, expand to show
- Not required for < 10s target

### Smart Defaults Logic
**Source:** [PRD Feature 3 - US-3.2]

When adding Set N:
- If Set N-1 exists, pre-fill Reps and Weight from Set N-1
- Rationale: Most people do similar reps/weight for consecutive sets
- User can adjust if needed (e.g., decrease weight, decrease reps)

When starting new exercise:
- If "Use Last Session" clicked, pre-fill with last session's first set
- Otherwise, fields empty

### Last Session Preview
**Source:** [PRD Feature 3 - US-3.2 AC]

**Purpose:** Show user their previous performance for comparison and motivation

**Format:**
- Collapsed: "Last time: 3×8 @ 80kg" (3 sets, 8 reps each, 80kg)
- Expanded: Full list of sets with details

**Data Loading:**
- Load when exercise becomes active
- Query: Get last completed session where this exercise was performed
- If no previous session, show "First time doing this exercise!"

### Auto-Save Implementation
**Source:** [PRD Feature 3 - US-3.2 AC, US-3.7]

**Purpose:** Prevent data loss if app crashes or is force-closed

**Mechanism:**
- Timer.periodic starts when session is active
- Every 30 seconds, dispatch AutoSaveSession event
- BLoC calls UpdateSession use case → saves to SQLite
- No UI feedback (silent background operation)

**Implementation:**
```dart
Timer? _autoSaveTimer;

void _startAutoSave() {
  _autoSaveTimer = Timer.periodic(Duration(seconds: 30), (_) {
    add(AutoSaveSession());
  });
}

void _stopAutoSave() {
  _autoSaveTimer?.cancel();
  _autoSaveTimer = null;
}
```

### Edit/Delete Set Interaction
**Source:** [PRD Feature 3 - US-3.4]

**Edit:**
- Tap set → open edit mode (inline or bottom sheet)
- Pre-fill current values
- User modifies → Tap "Save"
- Dispatch UpdateSet event → update in state + database

**Delete:**
- Swipe left on set → reveal delete button
- Tap delete → confirmation dialog: "Delete Set 2?"
- Confirm → Dispatch DeleteSet event
- Sets renumbered: Set 3 becomes Set 2, etc.

### Database Operations
**Source:** [PRD Feature 3 - Technical Specifications]

**Add Set:**
- INSERT into set_records table
- Update performed_exercises relationship

**Update Set:**
- UPDATE set_records WHERE id = ?

**Delete Set:**
- DELETE FROM set_records WHERE id = ?
- UPDATE remaining sets: SET set_number = set_number - 1 WHERE set_number > deleted_number

### Performance Considerations
**Source:** [PRD Feature 3 - US-3.2 AC]

- **Set entry:** < 10 seconds (user action time)
- **Database write:** < 50ms per set
- **Auto-save:** < 100ms (background, no UI impact)
- **List rendering:** Use ListView.builder for many sets

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project from Story 3.1):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `uuid: ^4.0.0`
- `equatable: ^2.0.5`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/widgets/`
**Performance Test Location:** `test/performance/`
**Coverage Target:** >80%

**Critical Test Cases:**
- Add set with valid data
- Add set with invalid data (out of range)
- Edit set updates correctly
- Delete set renumbers remaining sets
- Auto-save triggers every 30s
- **Performance test: Set entry < 10s**
- Last session loads correctly
- Smart defaults pre-fill form

### Integration with Other Stories
**Dependencies:**
- Story 3.1 (Start Session) - Required for active session context
- Story 2.1 (Exercises) - Required for exercise data

**Enables:**
- Story 4.1 (Timer) - AddSet event triggers timer start
- Story 3.7 (Auto-save) - Auto-save mechanism prevents data loss
- Story 5.1 (History) - Sets saved here become historical data

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

