# Story 6.2: Personal Records (PR) Tracking

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** voir mes records personnels,  
**so that** je cÃ©lÃ¨bre mes accomplissements et reste motivÃ©.

---

## Acceptance Criteria

1. Badge "ğŸ† NEW PR!" affichÃ© pendant sÃ©ance si nouveau record battu
2. Records trackÃ©s: Max Weight (1RM), Max Reps at Weight, Max Volume (single session)
3. Screen "Personal Records" liste tous PRs par exercice
4. Affichage: exercice name, record type, value, date atteinte
5. Animation cÃ©lÃ©bration quand PR battu (confetti, haptic feedback)
6. PR detection automatique aprÃ¨s chaque set ajoutÃ©
7. PR summary dans Workout Summary Screen (Story 3.3)

---

## Tasks / Subtasks

### Domain Layer - PR Entities
- [ ] **Task 1: Create PR Entities** (AC: 2)
  - [ ] Subtask 1.1: Create `PersonalRecord` entity in `lib/domain/entities/personal_record.dart`
    - Properties: id, exerciseId, recordType (enum), value (double), date, sessionId
  - [ ] Subtask 1.2: Create `PRType` enum
    - Values: maxWeight, maxRepsAtWeight, maxVolume
  - [ ] Subtask 1.3: Create `PRComparison` entity for detection
    - Properties: isNewPR, previousValue, newValue, improvementPercent

### Use Cases
- [ ] **Task 2: Create PR Use Cases** (AC: 2, 6)
  - [ ] Subtask 2.1: Create `DetectPersonalRecord` use case in `lib/domain/usecases/detect_personal_record.dart`
    - Input: exerciseId, weight, reps
    - Query current PRs for this exercise
    - Compare with current set
    - Return PRComparison (isNewPR, details)
  - [ ] Subtask 2.2: Create `SavePersonalRecord` use case in `lib/domain/usecases/save_personal_record.dart`
    - Input: exerciseId, recordType, value, sessionId
    - Save new PR to repository
    - Update existing PR if better
  - [ ] Subtask 2.3: Create `GetPersonalRecords` use case in `lib/domain/usecases/get_personal_records.dart`
    - Input: optional exerciseId filter
    - Return list of all PRs (or for specific exercise)
  - [ ] Subtask 2.4: Create `CalculateEstimated1RM` use case
    - Input: weight, reps
    - Formula: weight Ã— (1 + reps/30) (Epley formula)
    - Return estimated 1RM

### Repository
- [ ] **Task 3: Implement PR Repository** (AC: 2)
  - [ ] Subtask 3.1: Create `PersonalRecordRepository` interface in `lib/domain/repositories/personal_record_repository.dart`
    - Methods: save, getByExercise, getAll, delete
  - [ ] Subtask 3.2: Create `PersonalRecordLocalDataSource`
  - [ ] Subtask 3.3: Implement datasource with SQLite
    - Create table: `personal_records` (id, exercise_id, record_type, value, date, session_id)
    - Index: exercise_id, record_type
  - [ ] Subtask 3.4: Implement `PersonalRecordRepositoryImpl`

### State Management (BLoC)
- [ ] **Task 4: Implement PRBloc** (AC: 1, 3, 4, 6)
  - [ ] Subtask 4.1: Create PRBloc events in `lib/presentation/blocs/pr/pr_event.dart`
    - `DetectPR(exerciseId, weight, reps)`, `SavePR(PersonalRecord pr)`, `LoadPRs({exerciseId?})`, `CelebratePR(PersonalRecord pr)`
  - [ ] Subtask 4.2: Create PRBloc states in `lib/presentation/blocs/pr/pr_state.dart`
    - `PRInitial`, `PRDetected(PRComparison comparison)`, `PRsLoaded(List<PersonalRecord> prs)`, `PRCelebration(PersonalRecord pr)`
  - [ ] Subtask 4.3: Implement PRBloc logic in `lib/presentation/blocs/pr/pr_bloc.dart`
    - Handle DetectPR event (check if new PR)
    - Handle SavePR event (persist to DB)
    - Handle LoadPRs event
    - Emit appropriate states

### PR Detection Integration
- [ ] **Task 5: Integrate PR Detection with ActiveWorkoutBloc** (AC: 1, 6)
  - [ ] Subtask 5.1: Update ActiveWorkoutBloc AddSet handler
    - After set added, dispatch DetectPR event to PRBloc
    - Listen to PRDetected state
    - If new PR, show badge/notification
  - [ ] Subtask 5.2: Store PR information with set
    - Mark set as PR in UI (optional flag in SetRecord)

### UI Layer - PR Badge & Celebration
- [ ] **Task 6: Implement PR Badge During Workout** (AC: 1, 5)
  - [ ] Subtask 6.1: Create `PRBadge` widget in `lib/presentation/widgets/pr_badge.dart`
    - Trophy icon ğŸ†
    - "NEW PR!" text
    - Animated appearance
  - [ ] Subtask 6.2: Show badge on set when PR detected
    - Appear next to set in list
    - Animation: scale + fade in
  - [ ] Subtask 6.3: Implement confetti animation
    - Use `confetti` package or custom animation
    - Trigger on PR detection
    - Short duration (2-3 seconds)
  - [ ] Subtask 6.4: Trigger haptic feedback
    - HapticFeedback.heavyImpact() on PR
    - Celebratory vibration pattern

### UI Layer - PR List Screen
- [ ] **Task 7: Create Personal Records Screen** (AC: 3, 4)
  - [ ] Subtask 7.1: Create `PersonalRecordsScreen` in `lib/presentation/screens/personal_records/personal_records_screen.dart`
    - AppBar: "Personal Records", filter options
    - List of all PRs grouped by exercise
    - Empty state: "No records yet"
  - [ ] Subtask 7.2: Create `PRListItem` widget in `lib/presentation/widgets/pr_list_item.dart`
    - Exercise name + icon
    - Record type (Max Weight, Max Reps, Max Volume)
    - Value + date achieved
    - Trophy icon
  - [ ] Subtask 7.3: Group PRs by exercise
    - Show all record types for each exercise
    - Collapsible sections

### UI Layer - PR Summary in Workout Summary
- [ ] **Task 8: Add PR Summary to Workout Summary Screen** (AC: 7)
  - [ ] Subtask 8.1: Update `WorkoutSummaryScreen` (Story 3.3)
    - Add "ğŸ† New Personal Records" section
    - List PRs achieved during session
    - Highlight with special styling
  - [ ] Subtask 8.2: Query PRs for session
    - Filter PRs by sessionId
    - Display in summary

### PR Calculation Logic
- [ ] **Task 9: Implement PR Detection Algorithm** (AC: 2, 6)
  - [ ] Subtask 9.1: Max Weight detection
    - Compare weight of current set with max weight for exercise
    - If higher â†’ new PR
  - [ ] Subtask 9.2: Max Reps at Weight detection
    - Compare reps at specific weight
    - If more reps at same or higher weight â†’ new PR
  - [ ] Subtask 9.3: Max Volume detection (single session)
    - Calculate session volume: Î£(sets Ã— reps Ã— weight) for exercise
    - Compare with previous max volume for this exercise
    - If higher â†’ new PR
  - [ ] Subtask 9.4: Estimated 1RM calculation
    - Use Epley formula: weight Ã— (1 + reps/30)
    - Or Brzycki formula: weight Ã— (36 / (37 - reps))
    - Display as reference, not official PR

### Testing
- [ ] **Task 10: Unit Tests**
  - [ ] Subtask 10.1: Test `DetectPersonalRecord` use case
    - Detects new max weight
    - Detects new max reps
    - Doesn't trigger for non-PRs
  - [ ] Subtask 10.2: Test `SavePersonalRecord` use case
  - [ ] Subtask 10.3: Test `CalculateEstimated1RM` use case
    - Accurate calculations for various reps
  - [ ] Subtask 10.4: Test PRBloc PR detection logic
  - [ ] Subtask 10.5: Test PR repository CRUD operations

- [ ] **Task 11: Widget Tests**
  - [ ] Subtask 11.1: Test PRBadge renders correctly
  - [ ] Subtask 11.2: Test PersonalRecordsScreen displays PRs
  - [ ] Subtask 11.3: Test PRListItem shows correct data
  - [ ] Subtask 11.4: Test celebration animation triggers

- [ ] **Task 12: Integration Tests**
  - [ ] Subtask 12.1: Test full flow: Add set â†’ PR detected â†’ Badge shown â†’ Celebration
  - [ ] Subtask 12.2: Test PR persists to database
  - [ ] Subtask 12.3: Test PRs appear in Personal Records screen

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 5 - US-5.3]

New files:
```
lib/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ personal_record.dart (NEW)
â”‚   â”‚   â””â”€â”€ pr_comparison.dart (NEW)
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ personal_record_repository.dart (NEW)
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ detect_personal_record.dart (NEW)
â”‚       â”œâ”€â”€ save_personal_record.dart (NEW)
â”‚       â”œâ”€â”€ get_personal_records.dart (NEW)
â”‚       â””â”€â”€ calculate_estimated_1rm.dart (NEW)
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ personal_record_model.dart (NEW)
â”‚   â”œâ”€â”€ datasources/local/
â”‚   â”‚   â””â”€â”€ personal_record_local_datasource.dart (NEW)
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ personal_record_repository_impl.dart (NEW)
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ blocs/
â”‚   â”‚   â”œâ”€â”€ pr/
â”‚   â”‚   â”‚   â”œâ”€â”€ pr_bloc.dart (NEW)
â”‚   â”‚   â”‚   â”œâ”€â”€ pr_event.dart (NEW)
â”‚   â”‚   â”‚   â””â”€â”€ pr_state.dart (NEW)
â”‚   â”‚   â””â”€â”€ active_workout/
â”‚   â”‚       â””â”€â”€ active_workout_bloc.dart (MODIFY - integrate PR detection)
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ personal_records/
â”‚   â”‚   â”‚   â””â”€â”€ personal_records_screen.dart (NEW)
â”‚   â”‚   â””â”€â”€ workout_summary/
â”‚   â”‚       â””â”€â”€ workout_summary_screen.dart (MODIFY - add PR section)
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ pr_badge.dart (NEW)
â”‚       â””â”€â”€ pr_list_item.dart (NEW)
```

### Data Models
**Source:** [PRD Feature 5 - US-5.3 AC]

**PersonalRecord Entity:**
```dart
class PersonalRecord {
  final String id; // UUID
  final String exerciseId;
  final PRType recordType;
  final double value;
  final DateTime achievedDate;
  final String sessionId;
  
  // Computed field for display
  String get displayValue {
    switch (recordType) {
      case PRType.maxWeight:
        return '${value.toStringAsFixed(1)} kg';
      case PRType.maxRepsAtWeight:
        return '${value.toInt()} reps';
      case PRType.maxVolume:
        return '${value.toStringAsFixed(0)} kg total';
    }
  }
}
```

**PRType Enum:**
```dart
enum PRType {
  maxWeight,      // Highest weight lifted for any reps
  maxRepsAtWeight, // Most reps at a specific weight
  maxVolume       // Highest total volume in single session
}
```

**PRComparison Entity:**
```dart
class PRComparison {
  final bool isNewPR;
  final PRType? recordType;
  final double? previousValue;
  final double newValue;
  final double? improvementPercent;
}
```

### Database Schema
**Source:** [PRD Feature 5 - US-5.3]

**Table: personal_records**
```sql
CREATE TABLE personal_records (
  id TEXT PRIMARY KEY,
  exercise_id TEXT NOT NULL,
  record_type TEXT NOT NULL,
  value REAL NOT NULL,
  achieved_date INTEGER NOT NULL,
  session_id TEXT NOT NULL,
  FOREIGN KEY (exercise_id) REFERENCES exercises(id),
  FOREIGN KEY (session_id) REFERENCES workout_sessions(id)
);

CREATE INDEX idx_pr_exercise ON personal_records(exercise_id);
CREATE INDEX idx_pr_type ON personal_records(record_type);
```

### PR Detection Algorithm
**Source:** [PRD Feature 5 - US-5.3 AC]

**Max Weight PR:**
```dart
Future<PRComparison> detectMaxWeightPR(String exerciseId, double weight) async {
  final currentPR = await _repository.getMaxWeightPR(exerciseId);
  
  if (currentPR == null || weight > currentPR.value) {
    return PRComparison(
      isNewPR: true,
      recordType: PRType.maxWeight,
      previousValue: currentPR?.value,
      newValue: weight,
      improvementPercent: currentPR != null 
        ? ((weight - currentPR.value) / currentPR.value * 100)
        : null,
    );
  }
  
  return PRComparison(isNewPR: false, newValue: weight);
}
```

**Max Reps PR:**
- Track max reps at each weight level
- Example: 10 reps @ 80kg is PR, even if max weight is 100kg
- More nuanced, requires weight-specific tracking

**Max Volume PR (Session):**
```dart
double calculateSessionVolume(List<SetRecord> sets) {
  return sets.fold(0.0, (sum, set) => sum + (set.reps * set.weight));
}
```

### 1RM Estimation Formulas
**Source:** [PRD Feature 5 - US-5.3]

**Epley Formula (most common):**
```dart
double calculateEpley1RM(double weight, int reps) {
  return weight * (1 + reps / 30.0);
}
```

**Brzycki Formula (alternative):**
```dart
double calculateBrzycki1RM(double weight, int reps) {
  return weight * (36 / (37 - reps));
}
```

**Example:**
- Set: 8 reps @ 80kg
- Epley 1RM: 80 Ã— (1 + 8/30) = 80 Ã— 1.267 = **101.3kg**

### UI/UX Design
**Source:** [PRD Feature 5 - US-5.3 AC]

**PR Badge (during workout):**
```
Set 3: 8 reps @ 85kg  ğŸ† NEW PR!
                      â†‘ Badge with animation
```

**Confetti Animation:**
- Trigger on PR detection
- Short burst (2-3 seconds)
- Doesn't block UI
- Use `confetti` package: `^0.7.0`

**Personal Records Screen:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Personal Records      ğŸ†     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Bench Press                    â”‚
â”‚  â”œâ”€ Max Weight: 90kg            â”‚
â”‚  â”‚  Jan 8, 2026                 â”‚
â”‚  â”œâ”€ Max Reps: 12 @ 60kg         â”‚
â”‚  â”‚  Jan 5, 2026                 â”‚
â”‚  â””â”€ Max Volume: 1,200kg         â”‚
â”‚     Jan 8, 2026                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Squat                          â”‚
â”‚  â”œâ”€ Max Weight: 120kg           â”‚
â”‚  â”‚  Jan 7, 2026                 â”‚
â”‚  â””â”€ Max Volume: 1,800kg         â”‚
â”‚     Jan 7, 2026                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Workout Summary with PRs:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ Workout Complete!            â”‚
â”‚                                 â”‚
â”‚  ğŸ† New Personal Records        â”‚
â”‚  â”œâ”€ Bench Press: 90kg (Max)     â”‚
â”‚  â””â”€ Overhead Press: 60kg (Max)  â”‚
â”‚                                 â”‚
â”‚  ğŸ“Š Summary                     â”‚
â”‚  ...                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Celebration Animation
**Source:** [PRD Feature 5 - US-5.3 AC]

**Confetti:**
- Package: `confetti: ^0.7.0`
- Trigger: On PRDetected state
- Duration: 2-3 seconds
- Positioning: Overlay on screen

**Haptic Feedback:**
```dart
HapticFeedback.heavyImpact(); // Strong vibration
```

**Visual Feedback:**
- PR badge scales in with animation
- Brief highlight on set item
- Trophy icon ğŸ† prominently displayed

### Integration with ActiveWorkout
**Source:** [PRD Feature 5 - US-5.3 AC]

**On AddSet event:**
1. Set added to session
2. Dispatch DetectPR event to PRBloc
3. PRBloc checks if new PR
4. If yes:
   - Emit PRDetected state
   - SavePR to database
   - Trigger celebration (confetti + haptic)
   - Show PR badge on set
5. If no:
   - Continue normally

**No blocking:** PR detection is async, doesn't slow down set entry

### Performance Considerations
**Source:** [PRD Feature 5 - US-5.3]

- **PR detection:** < 50ms (simple query + comparison)
- **Save PR:** < 50ms (single INSERT/UPDATE)
- **Load PRs screen:** < 200ms (query all PRs)
- **Confetti animation:** Non-blocking, GPU-accelerated

### Dependencies
**Source:** [PRD Technical Architecture]

New package to add:
- `confetti: ^0.7.0` - Celebration animation

Existing packages:
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `uuid: ^4.0.0`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`, `test/presentation/blocs/`
**Widget Test Location:** `test/presentation/widgets/`, `test/presentation/screens/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- DetectPR correctly identifies new max weight
- DetectPR correctly identifies max reps PR
- 1RM calculation accurate
- PRBloc emits correct states
- PR badge appears on new PR
- Confetti animation triggers
- PRs persist to database
- PRs appear in Personal Records screen
- Integration: Add set â†’ PR detected â†’ Saved â†’ Visible in PR list

### Integration with Other Stories
**Dependencies:**
- Story 3.2 (Track Sets) - PR detection on set add
- Story 3.3 (Finish Session) - PR summary in workout summary
- Story 5.1 (History) - Historical data for PR calculations

**Enables:**
- Gamification and motivation
- Progress tracking
- Goal setting for users

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

