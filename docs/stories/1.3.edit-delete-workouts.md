# Story 1.3: Éditer/Supprimer séances existantes

## Status
**Draft**

---

## Story

**As a** utilisateur,  
**I want to** modifier ou supprimer mes séances,  
**so that** je peux adapter mon programme au fil du temps.

---

## Acceptance Criteria

1. User peut éditer nom, description, exercices d'une séance
2. User peut supprimer une séance (confirmation requise)
3. Suppression affiche warning si séance utilisée dans historique
4. Suppression ne supprime PAS l'historique (séances réalisées conservées)
5. Édition met à jour timestamp "updatedAt"
6. Édition préserve l'ID de la séance
7. Actions accessibles via menu contextuel ou screen d'édition

---

## Tasks / Subtasks

### Use Cases
- [ ] **Task 1: Create Edit/Delete Use Cases** (AC: 1, 2, 4, 5)
  - [ ] Subtask 1.1: Update `UpdateWorkout` use case in `lib/domain/usecases/update_workout.dart`
    - Input: workout with updated fields
    - Validation: name not empty, at least 1 exercise
    - Set updatedAt = DateTime.now()
    - Preserve workout ID
    - Save to repository
  - [ ] Subtask 1.2: Update `DeleteWorkout` use case in `lib/domain/usecases/delete_workout.dart`
    - Input: workoutId
    - Check if workout used in history (query workout_sessions)
    - Return usage count
    - Delete from workouts table
    - Note: Does NOT delete workout_sessions (historical data preserved)
  - [ ] Subtask 1.3: Create `CheckWorkoutUsage` use case
    - Input: workoutId
    - Query: COUNT sessions where workoutId matches
    - Return count for warning message

### State Management (BLoC)
- [ ] **Task 2: Extend WorkoutBloc for Edit/Delete** (AC: 1, 2, 5, 6)
  - [ ] Subtask 2.1: UpdateWorkout event already exists in WorkoutBloc
    - Verify event handler updates workout correctly
    - Ensure updatedAt is set
  - [ ] Subtask 2.2: DeleteWorkout event already exists
    - Verify event handler calls use case
    - Add pre-delete usage check
  - [ ] Subtask 2.3: Add CheckWorkoutUsage event if needed
    - Load usage count before delete

### UI Layer - Edit Workout
- [ ] **Task 3: Enable Edit Mode in WorkoutBuilderScreen** (AC: 1, 5, 6)
  - [ ] Subtask 3.1: Update `WorkoutBuilderScreen` to support edit mode
    - Constructor: add optional `Workout editWorkout` parameter
    - If editWorkout provided: pre-fill form with existing data
    - AppBar title: "Edit Workout" vs "New Workout"
  - [ ] Subtask 3.2: Pre-fill form in edit mode
    - Workout name field
    - Description field
    - Exercise list with order
    - Target sets per exercise
  - [ ] Subtask 3.3: Save button in edit mode
    - Dispatch UpdateWorkout event (not CreateWorkout)
    - Preserve workout ID
    - Update updatedAt timestamp
  - [ ] Subtask 3.4: Show success message after edit
    - "Workout updated successfully"

### UI Layer - Delete Workout
- [ ] **Task 4: Implement Delete Functionality** (AC: 2, 3, 4)
  - [ ] Subtask 4.1: Add delete option in workout list
    - Long press → show context menu
    - Menu option: "Delete"
    - Or swipe-to-delete gesture
  - [ ] Subtask 4.2: Show confirmation dialog
    - Title: "Delete workout?"
    - Message: "This will delete '[Workout Name]'"
    - Buttons: "Cancel", "Delete"
  - [ ] Subtask 4.3: Check workout usage before delete
    - Dispatch CheckWorkoutUsage event
    - If used in history: Show enhanced warning
  - [ ] Subtask 4.4: Enhanced warning for used workouts
    - Message: "This workout has been used in X sessions. Deleting it won't remove your workout history."
    - Emphasis: Historical data is preserved
    - Buttons: "Cancel", "Delete Anyway"
  - [ ] Subtask 4.5: Execute delete after confirmation
    - Dispatch DeleteWorkout event
    - Remove from list on success
    - Show toast: "Workout deleted"

### UI Layer - Edit Action
- [ ] **Task 5: Add Edit Option to Workout List** (AC: 1, 7)
  - [ ] Subtask 5.1: Add edit option in context menu
    - Long press workout → show menu
    - Option: "Edit"
  - [ ] Subtask 5.2: Navigate to WorkoutBuilderScreen in edit mode
    - Pass workout object
    - Screen opens in edit mode
  - [ ] Subtask 5.3: Alternative: Edit button in workout details view
    - If workout has detail screen, add edit FAB/button

### Database Operations
- [ ] **Task 6: Implement Update/Delete Database Operations** (AC: 4, 5)
  - [ ] Subtask 6.1: Update workout in database
    - UPDATE workouts SET name=?, description=?, updated_at=? WHERE id=?
    - Update workout_exercises (delete old, insert new)
  - [ ] Subtask 6.2: Delete workout from database
    - DELETE FROM workouts WHERE id=?
    - CASCADE delete workout_exercises
    - DO NOT delete workout_sessions (foreign key allows null)
  - [ ] Subtask 6.3: Check workout usage query
    - SELECT COUNT(*) FROM workout_sessions WHERE workout_id = ?

### Testing
- [ ] **Task 7: Unit Tests**
  - [ ] Subtask 7.1: Test UpdateWorkout use case
    - Updates workout fields
    - Sets updatedAt timestamp
    - Preserves workout ID
  - [ ] Subtask 7.2: Test DeleteWorkout use case
    - Deletes workout
    - Does not delete workout_sessions
  - [ ] Subtask 7.3: Test CheckWorkoutUsage use case
    - Returns correct usage count
  - [ ] Subtask 7.4: Test WorkoutBloc update/delete events

- [ ] **Task 8: Widget Tests**
  - [ ] Subtask 8.1: Test WorkoutBuilderScreen in edit mode
    - Pre-fills form correctly
    - Save updates workout (not creates new)
  - [ ] Subtask 8.2: Test delete confirmation dialog
  - [ ] Subtask 8.3: Test enhanced warning for used workouts
  - [ ] Subtask 8.4: Test context menu shows edit/delete options

- [ ] **Task 9: Integration Tests**
  - [ ] Subtask 9.1: Test full edit flow: Select workout → Edit → Save → Verify updated
  - [ ] Subtask 9.2: Test full delete flow: Select workout → Delete → Confirm → Verify removed
  - [ ] Subtask 9.3: Test delete with history: Create session → Delete workout → Verify history preserved

---

## Dev Notes

### Project Structure
**Source:** [PRD Feature 1 - US-1.3]

Modified files:
```
lib/
├── domain/
│   └── usecases/
│       ├── update_workout.dart (MODIFY - ensure updatedAt set)
│       ├── delete_workout.dart (MODIFY - add usage check)
│       └── check_workout_usage.dart (NEW)
├── presentation/
│   ├── blocs/workout/
│   │   └── workout_bloc.dart (MODIFY - verify update/delete handlers)
│   ├── screens/
│   │   └── workout_builder/
│   │       └── workout_builder_screen.dart (MODIFY - add edit mode)
│   └── widgets/
│       └── workout_list_item.dart (MODIFY - add context menu)
```

### Workout Entity (Already Defined)
**Source:** [PRD Feature 1 - Technical Specifications]

```dart
class Workout {
  final String id; // UUID - PRESERVED on update
  final String name;
  final String? description;
  final List<WorkoutExercise> exercises;
  final String? notes;
  final DateTime createdAt; // PRESERVED on update
  final DateTime updatedAt; // UPDATED on edit
}
```

### Edit Mode vs Create Mode
**Source:** [PRD Feature 1 - US-1.3 AC]

**Create Mode:**
- No workout passed to WorkoutBuilderScreen
- Empty form
- Save → CreateWorkout event
- Generate new UUID

**Edit Mode:**
- Workout object passed to constructor
- Form pre-filled with workout data
- Save → UpdateWorkout event
- Preserve existing UUID
- Update updatedAt timestamp

**UI Distinction:**
- AppBar title: "New Workout" vs "Edit Workout"
- Save button may say "Update" instead of "Save"

### Delete Warning Logic
**Source:** [PRD Feature 1 - US-1.3 AC]

**Check usage:**
```sql
SELECT COUNT(*) as usage_count 
FROM workout_sessions 
WHERE workout_id = ?;
```

**Standard confirmation (usage = 0):**
- "Delete workout '[Workout Name]'?"
- "This action cannot be undone."

**Enhanced warning (usage > 0):**
- "Delete workout '[Workout Name]'?"
- "This workout has been used in X workout sessions."
- "⚠️ Your workout history will NOT be deleted. Only this workout template will be removed."
- Emphasize that historical data is safe

### Database Update Operations
**Source:** [PRD Feature 1 - US-1.3 AC]

**Update workout:**
```sql
-- Update main workout
UPDATE workouts 
SET name = ?, description = ?, notes = ?, updated_at = ? 
WHERE id = ?;

-- Update exercises (delete old, insert new)
DELETE FROM workout_exercises WHERE workout_id = ?;
INSERT INTO workout_exercises (id, workout_id, exercise_id, order, target_sets, rest_time)
VALUES ...;
```

**Delete workout:**
```sql
-- Delete workout (cascades to workout_exercises)
DELETE FROM workouts WHERE id = ?;

-- workout_sessions are NOT deleted
-- If foreign key constraint: SET NULL or keep reference
```

**Recommendation:** Use ON DELETE SET NULL for workout_id in workout_sessions table:
```sql
ALTER TABLE workout_sessions 
ADD CONSTRAINT fk_workout 
FOREIGN KEY (workout_id) 
REFERENCES workouts(id) 
ON DELETE SET NULL;
```

### Historical Data Preservation
**Source:** [PRD Feature 1 - US-1.3 AC]

**Critical Rule:** Deleting a workout template NEVER deletes workout sessions

**Why:**
- User's historical data is sacred
- Progress tracking depends on history
- PRs calculated from past sessions
- Motivation comes from seeing progress

**Implementation:**
- workout_sessions.workout_id can be NULL
- Or keep ID even if workout deleted (orphaned reference)
- Display: "Deleted Workout" or original name from session

### Context Menu Design
**Source:** [PRD Feature 1 - US-1.3]

**Long press on workout card:**
```
┌─────────────────────────┐
│  Edit                   │
│  Duplicate              │  ← Story 1.4
│  Delete                 │
│  Share (future)         │
└─────────────────────────┘
```

**Or swipe gestures:**
- Swipe right: Edit
- Swipe left: Delete (with confirmation)

### Edit Workflow
**Source:** [PRD Feature 1 - US-1.3 AC]

1. User taps workout (or long press → Edit)
2. Navigate to WorkoutBuilderScreen with workout object
3. Form pre-filled with current data
4. User modifies name, exercises, etc.
5. User taps "Update" button
6. Validation (same as create)
7. Dispatch UpdateWorkout event
8. Update in database (preserve ID, update updatedAt)
9. Navigate back to workout list
10. Show success toast

### Delete Workflow
**Source:** [PRD Feature 1 - US-1.3 AC]

1. User long press → Delete (or swipe left)
2. System checks usage: `CheckWorkoutUsage(workoutId)`
3. Show appropriate confirmation dialog
4. User confirms delete
5. Dispatch DeleteWorkout event
6. Delete from database (NOT from history)
7. Remove from UI list
8. Show success toast

### Performance Considerations
**Source:** [PRD Feature 1 - US-1.3]

- **Update operation:** < 100ms (UPDATE + DELETE + INSERT exercises)
- **Delete operation:** < 50ms (simple DELETE)
- **Usage check query:** < 10ms (indexed query)

### Dependencies
**Source:** [PRD Technical Architecture]

Packages (already in project):
- `flutter_bloc: ^8.1.0`
- `sqflite: ^2.3.0`
- `uuid: ^4.0.0`

### Testing Standards

**Unit Test Location:** `test/domain/usecases/`
**Widget Test Location:** `test/presentation/screens/`, `test/presentation/widgets/`
**Integration Test Location:** `integration_test/`
**Coverage Target:** >80%

**Key Test Cases:**
- UpdateWorkout preserves ID and createdAt
- UpdateWorkout sets new updatedAt
- DeleteWorkout does not affect workout_sessions
- CheckWorkoutUsage returns correct count
- Edit mode pre-fills form correctly
- Delete confirmation shows enhanced warning if used
- Context menu appears on long press

### Integration with Other Stories
**Dependencies:**
- Story 1.1 (Create Workout) - Extends CRUD operations
- Story 5.1 (History) - Historical data must be preserved

**Enables:**
- Users can fix mistakes in workout creation
- Users can evolve their programs over time
- Complete workout management

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

