# Story 1.1: Créer une séance personnalisée

## Status
**Draft**

---

## Story

**As a** pratiquant de musculation,  
**I want to** créer mes propres séances d'entraînement,  
**so that** je peux organiser mes entraînements selon mes objectifs.

---

## Acceptance Criteria

1. User peut créer une nouvelle séance avec un nom
2. User peut ajouter une description (optionnel)
3. User peut ajouter des exercices depuis la base de données
4. User peut réordonner les exercices (drag & drop)
5. User peut définir le nombre de séries cibles par exercice
6. Séance sauvegardée localement automatiquement
7. Validation: nom non vide, au moins 1 exercice

---

## Tasks / Subtasks

### Backend / Domain Layer
- [ ] **Task 1: Create Workout entity and models** (AC: 1, 2, 5, 6, 7)
  - [ ] Subtask 1.1: Create `Workout` entity in `lib/domain/entities/workout.dart`
    - Properties: `id` (String UUID), `name` (String), `description` (String?), `exercises` (List<WorkoutExercise>), `notes` (String?), `createdAt` (DateTime), `updatedAt` (DateTime)
  - [ ] Subtask 1.2: Create `WorkoutExercise` entity in `lib/domain/entities/workout_exercise.dart`
    - Properties: `exerciseId` (String), `order` (int), `targetSets` (int), `restTime` (Duration?)
  - [ ] Subtask 1.3: Create `WorkoutModel` in `lib/data/models/workout_model.dart` with `fromJson()`, `toJson()`, `fromEntity()`, `toEntity()` methods
  - [ ] Subtask 1.4: Create `WorkoutExerciseModel` in `lib/data/models/workout_exercise_model.dart` with JSON serialization

- [ ] **Task 2: Implement Workout Repository** (AC: 1, 6)
  - [ ] Subtask 2.1: Create `WorkoutRepository` interface in `lib/domain/repositories/workout_repository.dart`
    - Methods: `Future<List<Workout>> getWorkouts()`, `Future<Workout> createWorkout(Workout workout)`, `Future<Workout> updateWorkout(Workout workout)`, `Future<void> deleteWorkout(String workoutId)`
  - [ ] Subtask 2.2: Create `WorkoutLocalDataSource` interface in `lib/data/datasources/local/workout_local_datasource.dart`
  - [ ] Subtask 2.3: Implement `WorkoutLocalDataSourceImpl` with SQLite operations
    - Create table: `workouts` (id, name, description, notes, created_at, updated_at)
    - Create table: `workout_exercises` (id, workout_id, exercise_id, order, target_sets, rest_time)
  - [ ] Subtask 2.4: Implement `WorkoutRepositoryImpl` in `lib/data/repositories/workout_repository_impl.dart`

- [ ] **Task 3: Create Use Cases** (AC: 1, 6, 7)
  - [ ] Subtask 3.1: Create `CreateWorkout` use case in `lib/domain/usecases/create_workout.dart`
    - Validation logic: name non-empty, at least 1 exercise
    - Generate UUID for workout ID
    - Set createdAt and updatedAt timestamps
  - [ ] Subtask 3.2: Create `GetWorkouts` use case in `lib/domain/usecases/get_workouts.dart`
  - [ ] Subtask 3.3: Create `UpdateWorkout` use case in `lib/domain/usecases/update_workout.dart`
  - [ ] Subtask 3.4: Create `DeleteWorkout` use case in `lib/domain/usecases/delete_workout.dart`

### State Management (BLoC)
- [ ] **Task 4: Implement WorkoutBloc** (AC: 1, 6, 7)
  - [ ] Subtask 4.1: Create WorkoutBloc events in `lib/presentation/blocs/workout/workout_event.dart`
    - `LoadWorkouts`, `CreateWorkout`, `UpdateWorkout`, `DeleteWorkout`, `DuplicateWorkout`
  - [ ] Subtask 4.2: Create WorkoutBloc states in `lib/presentation/blocs/workout/workout_state.dart`
    - `WorkoutInitial`, `WorkoutLoading`, `WorkoutsLoaded`, `WorkoutError`
  - [ ] Subtask 4.3: Implement WorkoutBloc logic in `lib/presentation/blocs/workout/workout_bloc.dart`
    - Handle all events and emit appropriate states
    - Error handling for validation failures

### UI Layer
- [ ] **Task 5: Create Workout Builder Screen** (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 5.1: Create `WorkoutBuilderScreen` in `lib/presentation/screens/workout_builder/workout_builder_screen.dart`
    - AppBar with "New Workout" title, save button, cancel button
    - TextField for workout name (required, max 100 chars)
    - TextField for description (optional, max 500 chars)
    - Reorderable list of exercises with drag handles
    - FAB "+" button to add exercises
  - [ ] Subtask 5.2: Create `WorkoutExerciseListItem` widget in `lib/presentation/widgets/workout_exercise_list_item.dart`
    - Display exercise name, target sets input
    - Delete button
    - Drag handle icon
  - [ ] Subtask 5.3: Implement exercise picker modal
    - Search/filter exercises by name or muscle group
    - List of exercises with add button
    - Integration with Exercise database (dependency on Feature 2)

- [ ] **Task 6: Implement Drag & Drop Reordering** (AC: 4)
  - [ ] Subtask 6.1: Use `ReorderableListView` widget for exercise list
  - [ ] Subtask 6.2: Update exercise order in workout state on reorder
  - [ ] Subtask 6.3: Persist new order to local storage

- [ ] **Task 7: Implement Form Validation** (AC: 7)
  - [ ] Subtask 7.1: Add validation for workout name (non-empty)
  - [ ] Subtask 7.2: Add validation for at least 1 exercise before save
  - [ ] Subtask 7.3: Display error messages using SnackBar
  - [ ] Subtask 7.4: Disable save button if validation fails

### Testing
- [ ] **Task 8: Unit Tests**
  - [ ] Subtask 8.1: Test `Workout` and `WorkoutExercise` entity creation
  - [ ] Subtask 8.2: Test `WorkoutModel` JSON serialization/deserialization
  - [ ] Subtask 8.3: Test `CreateWorkout` use case validation logic
  - [ ] Subtask 8.4: Test `WorkoutRepositoryImpl` CRUD operations (mock datasource)
  - [ ] Subtask 8.5: Test `WorkoutBloc` event handling and state transitions

- [ ] **Task 9: Widget Tests**
  - [ ] Subtask 9.1: Test `WorkoutBuilderScreen` renders correctly
  - [ ] Subtask 9.2: Test form validation displays errors
  - [ ] Subtask 9.3: Test exercise list reordering
  - [ ] Subtask 9.4: Test save button triggers CreateWorkout event

---

## Dev Notes

### Project Structure
**Source:** [PRD Section: Technical Architecture]

This is a **greenfield Flutter project** following **Clean Architecture** principles:

```
lib/
├── main.dart
├── core/
│   ├── error/
│   ├── usecases/
│   ├── utils/
│   └── di/ (dependency injection)
├── domain/
│   ├── entities/
│   ├── repositories/ (interfaces)
│   └── usecases/
├── data/
│   ├── models/
│   ├── datasources/local/
│   └── repositories/ (implementations)
└── presentation/
    ├── blocs/
    ├── screens/
    └── widgets/
```

### Data Models
**Source:** [PRD Feature 1 - Technical Specifications]

**Workout Entity:**
```dart
class Workout {
  final String id; // UUID
  final String name;
  final String? description;
  final List<WorkoutExercise> exercises;
  final String? notes;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

**WorkoutExercise Entity:**
```dart
class WorkoutExercise {
  final String exerciseId;
  final int order;
  final int targetSets;
  final Duration? restTime;
}
```

### BLoC Architecture
**Source:** [PRD Feature 1 - Technical Specifications]

**Events:**
- `LoadWorkouts` - Load all workouts from local storage
- `CreateWorkout` - Create new workout (with validation)
- `UpdateWorkout` - Update existing workout
- `DeleteWorkout` - Delete workout by ID
- `DuplicateWorkout` - Duplicate existing workout

**States:**
- `WorkoutInitial` - Initial state
- `WorkoutLoading` - Loading workouts
- `WorkoutsLoaded` - Workouts loaded successfully (contains List<Workout>)
- `WorkoutError` - Error occurred (contains error message)

### Database Schema
**Source:** [PRD Feature 1 - Technical Specifications]

**Table: workouts**
- `id` TEXT PRIMARY KEY
- `name` TEXT NOT NULL
- `description` TEXT
- `notes` TEXT
- `created_at` INTEGER NOT NULL
- `updated_at` INTEGER NOT NULL

**Table: workout_exercises**
- `id` TEXT PRIMARY KEY
- `workout_id` TEXT NOT NULL (FOREIGN KEY)
- `exercise_id` TEXT NOT NULL (FOREIGN KEY)
- `order` INTEGER NOT NULL
- `target_sets` INTEGER NOT NULL
- `rest_time` INTEGER (seconds)

### UI/UX Guidelines
**Source:** [PRD Feature 1 - US-1.1 UI/UX Notes]

- **Screen:** "New Workout" screen
- **FAB:** "+" button to add exercises
- **Search:** Filter exercises by muscle group
- **Preview:** Show workout preview before save
- **Validation:** Display inline errors for empty name or no exercises
- **Material Design 3:** Use Material 3 components and theming

### Dependencies
**Source:** [PRD Section: Technical Architecture - Tech Stack Summary]

Required packages (add to `pubspec.yaml`):
- `flutter_bloc: ^8.1.0` - State management
- `sqflite: ^2.3.0` - Local database
- `get_it: ^7.6.0` - Dependency injection
- `uuid: ^4.0.0` - Generate UUIDs for workout IDs
- `equatable: ^2.0.5` - Value equality for BLoC states/events

### Validation Rules
**Source:** [PRD Feature 1 - US-1.1 Acceptance Criteria]

1. **Workout name:** Must not be empty, max 100 characters
2. **Workout description:** Optional, max 500 characters
3. **Exercises:** Must have at least 1 exercise before saving
4. **Target sets:** Must be >= 1 (default: 3)

### Integration Points
**Dependency:** This story requires the Exercise database (Feature 2, US-2.1) to be implemented first or in parallel to allow selecting exercises when building a workout.

**Workaround for development:** Create a mock exercise list with 5-10 basic exercises to unblock UI development.

### Testing Standards

**Unit Test Location:** `test/domain/usecases/` and `test/data/repositories/`
**Widget Test Location:** `test/presentation/screens/`
**Coverage Target:** >80% for domain and data layers

**Testing Framework:** Use Flutter's built-in `flutter_test` package and `bloc_test` for BLoC testing.

**Key Test Cases:**
- Validation logic in `CreateWorkout` use case
- JSON serialization/deserialization in models
- BLoC state transitions
- Widget form validation

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 1.0 | Initial story creation from PRD | Mathis (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_

